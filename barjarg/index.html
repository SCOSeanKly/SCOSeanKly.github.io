<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#070b14">
  <title>Barjarg Fishings</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    /* ── CSS Reset & Variables ──────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-deepest: #050810;
      --bg-deep: #0a0f1c;
      --bg-card: #0f1628;
      --bg-card-hover: #141d35;
      --bg-input: #111a2e;
      --bg-elevated: #182240;

      --border: rgba(255,255,255,0.06);
      --border-focus: rgba(212,165,116,0.4);

      --gold: #d4a574;
      --gold-light: #e8c9a0;
      --gold-dim: rgba(212,165,116,0.15);
      --teal: #2dd4bf;
      --teal-dim: rgba(45,212,191,0.12);
      --salmon: #f87171;
      --salmon-dim: rgba(248,113,113,0.12);
      --blue: #60a5fa;
      --purple: #a78bfa;
      --green: #4ade80;

      --text-primary: #e8e2d8;
      --text-secondary: #8b9ab5;
      --text-muted: #4a5568;
      --text-heading: #f5f0e8;

      --font-heading: 'Cormorant Garamond', Georgia, serif;
      --font-body: 'Outfit', -apple-system, sans-serif;

      --radius: 12px;
      --radius-lg: 20px;
      --radius-sm: 8px;

      --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --shadow-lg: 0 12px 48px rgba(0,0,0,0.6);

      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --nav-height: 72px;
    }

    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: var(--font-body);
      background: var(--bg-deepest);
      color: var(--text-primary);
      min-height: 100dvh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Scrollbar ──────────────────────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

    /* ── Global Animations ─────────────────────────────────────── */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes pulse-gold {
      0%, 100% { box-shadow: 0 0 0 0 rgba(212,165,116,0.3); }
      50% { box-shadow: 0 0 20px 4px rgba(212,165,116,0.15); }
    }
    @keyframes ripple {
      0% { transform: scale(0.8); opacity: 0.6; }
      100% { transform: scale(2.4); opacity: 0; }
    }
    @keyframes countUp {
      from { opacity: 0; transform: scale(0.5); }
      to { opacity: 1; transform: scale(1); }
    }

    .animate-in {
      animation: fadeIn 0.5s ease forwards;
      opacity: 0;
    }
    .animate-in-delay-1 { animation-delay: 0.1s; }
    .animate-in-delay-2 { animation-delay: 0.2s; }
    .animate-in-delay-3 { animation-delay: 0.3s; }
    .animate-in-delay-4 { animation-delay: 0.4s; }
    .animate-in-delay-5 { animation-delay: 0.5s; }

    /* ── App Shell ─────────────────────────────────────────────── */
    #app {
      max-width: 100%;
      min-height: 100dvh;
      position: relative;
    }

    .page {
      padding: 20px 16px;
      padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 80px);
      max-width: 600px;
      margin: 0 auto;
      animation: fadeIn 0.4s ease;
    }

    @media (min-width: 768px) {
      .page { padding: 32px 24px; max-width: 720px; }
    }

    /* ── Header Bar ────────────────────────────────────────────── */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 12px 16px;
      background: rgba(5,8,16,0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-brand {
      font-family: var(--font-heading);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.02em;
    }
    .header-brand span {
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.75rem;
      font-family: var(--font-body);
      margin-left: 8px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    .header-user {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .header-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gold-dim);
      color: var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.8rem;
    }

    /* ── Bottom Navigation ─────────────────────────────────────── */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      height: calc(var(--nav-height) + var(--safe-bottom));
      padding-bottom: var(--safe-bottom);
      background: rgba(10,15,28,0.92);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-around;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      border: none;
      background: none;
      color: var(--text-muted);
      font-family: var(--font-body);
      font-size: 0.65rem;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .nav-item.active {
      color: var(--gold);
    }
    .nav-item.active::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 2px;
      background: var(--gold);
      border-radius: 1px;
    }
    .nav-item svg {
      width: 22px;
      height: 22px;
      stroke-width: 1.5;
    }
    .nav-item-log {
      background: linear-gradient(135deg, var(--gold), #c4915a);
      color: var(--bg-deepest) !important;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      margin-top: -20px;
      box-shadow: 0 4px 20px rgba(212,165,116,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      gap: 0;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .nav-item-log:active {
      transform: scale(0.92);
    }
    .nav-item-log svg {
      width: 26px;
      height: 26px;
      stroke-width: 2;
    }

    /* ── Cards ──────────────────────────────────────────────────── */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all 0.3s ease;
    }
    .card:hover {
      border-color: rgba(255,255,255,0.1);
    }
    .card-glass {
      background: rgba(15,22,40,0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* ── Typography ─────────────────────────────────────────────── */
    .heading-xl {
      font-family: var(--font-heading);
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-heading);
      line-height: 1.2;
    }
    .heading-lg {
      font-family: var(--font-heading);
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-heading);
      line-height: 1.3;
    }
    .heading-md {
      font-family: var(--font-heading);
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-heading);
    }
    .section-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--gold);
      margin-bottom: 12px;
    }

    /* ── Form Elements ─────────────────────────────────────────── */
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      letter-spacing: 0.02em;
    }
    .form-label .optional {
      color: var(--text-muted);
      font-weight: 400;
      font-size: 0.72rem;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 1rem;
      transition: all 0.25s ease;
      outline: none;
      -webkit-appearance: none;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: var(--border-focus);
      background: var(--bg-elevated);
      box-shadow: 0 0 0 3px rgba(212,165,116,0.08);
    }
    .form-input::placeholder {
      color: var(--text-muted);
    }
    .form-select {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b9ab5' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }
    .form-select option {
      background: var(--bg-deep);
      color: var(--text-primary);
    }
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* ── Buttons ────────────────────────────────────────────────── */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      border: none;
      border-radius: var(--radius-sm);
      font-family: var(--font-body);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      text-transform: none;
      letter-spacing: 0.02em;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--gold), #c4915a);
      color: var(--bg-deepest);
      box-shadow: 0 4px 16px rgba(212,165,116,0.25);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 24px rgba(212,165,116,0.35);
      transform: translateY(-1px);
    }
    .btn-primary:active {
      transform: translateY(0);
    }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      padding: 8px 16px;
    }
    .btn-ghost:hover {
      color: var(--text-primary);
      background: rgba(255,255,255,0.04);
    }
    .btn-block {
      width: 100%;
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.8rem;
    }

    /* ── Species Colors ────────────────────────────────────────── */
    .species-salmon { color: var(--salmon); }
    .species-brown-trout { color: #a78bfa; }
    .species-sea-trout { color: var(--teal); }
    .species-rainbow-trout { color: #f472b6; }
    .species-grayling { color: var(--blue); }
    .species-other { color: var(--text-secondary); }

    .species-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
    }
    .species-dot-salmon { background: var(--salmon); }
    .species-dot-brown-trout { background: #a78bfa; }
    .species-dot-sea-trout { background: var(--teal); }
    .species-dot-rainbow-trout { background: #f472b6; }
    .species-dot-grayling { background: var(--blue); }
    .species-dot-other { background: var(--text-secondary); }

    /* ── Stat Card ──────────────────────────────────────────────── */
    .stat-value {
      font-family: var(--font-heading);
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--text-heading);
      line-height: 1;
      animation: countUp 0.6s ease forwards;
    }
    .stat-label {
      font-size: 0.72rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-top: 4px;
    }

    /* ── Bar Chart ─────────────────────────────────────────────── */
    .bar-chart { display: flex; flex-direction: column; gap: 10px; }
    .bar-row { display: flex; align-items: center; gap: 12px; }
    .bar-label {
      width: 100px;
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-align: right;
      flex-shrink: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bar-track {
      flex: 1;
      height: 28px;
      background: rgba(255,255,255,0.03);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
      display: flex;
      align-items: center;
      padding-left: 10px;
      font-size: 0.75rem;
      font-weight: 600;
      color: rgba(0,0,0,0.7);
      min-width: fit-content;
    }

    /* ── Photo Upload ──────────────────────────────────────────── */
    .photo-upload {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .photo-upload:hover, .photo-upload.drag-over {
      border-color: var(--gold);
      background: var(--gold-dim);
    }
    .photo-upload input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .photo-upload-preview {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: var(--radius-sm);
    }
    .photo-upload-icon {
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* ── Map Container ─────────────────────────────────────────── */
    .map-container {
      width: 100%;
      height: 280px;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      position: relative;
    }
    .map-container .leaflet-container {
      height: 100%;
      width: 100%;
      background: var(--bg-deep);
    }
    .map-hint {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(5,8,16,0.85);
      backdrop-filter: blur(8px);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.72rem;
      color: var(--text-secondary);
      z-index: 1000;
      pointer-events: none;
      white-space: nowrap;
    }

    /* ── Warning Banner ────────────────────────────────────────── */
    .warning-banner {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 14px 16px;
      background: rgba(212,165,116,0.08);
      border: 1px solid rgba(212,165,116,0.15);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
    }
    .warning-banner svg {
      color: var(--gold);
      flex-shrink: 0;
      margin-top: 1px;
    }
    .warning-banner p {
      font-size: 0.82rem;
      color: var(--gold-light);
      line-height: 1.5;
    }

    /* ── Catch Card ─────────────────────────────────────────────── */
    .catch-card {
      display: flex;
      gap: 14px;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: all 0.3s ease;
      animation: fadeIn 0.4s ease forwards;
      opacity: 0;
    }
    .catch-card:hover {
      border-color: rgba(255,255,255,0.1);
      background: var(--bg-card-hover);
    }
    .catch-thumb {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-sm);
      background: var(--bg-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
    }
    .catch-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .catch-thumb svg {
      color: var(--text-muted);
    }
    .catch-info { flex: 1; min-width: 0; }
    .catch-species {
      font-family: var(--font-heading);
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-heading);
      margin-bottom: 2px;
    }
    .catch-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .catch-meta-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .catch-angler {
      font-size: 0.78rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    /* ── Login Screen ──────────────────────────────────────────── */
    .login-screen {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }
    .login-screen::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(212,165,116,0.06) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(45,212,191,0.04) 0%, transparent 50%);
      animation: pulse-gold 8s ease infinite;
    }
    .login-card {
      width: 100%;
      max-width: 380px;
      position: relative;
      z-index: 1;
      text-align: center;
    }
    .login-logo {
      font-family: var(--font-heading);
      font-size: 3rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 4px;
    }
    .login-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      letter-spacing: 0.18em;
      text-transform: uppercase;
      margin-bottom: 48px;
    }
    .pin-input-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 32px;
    }
    .pin-digit {
      width: 56px;
      height: 64px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      font-family: var(--font-body);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-heading);
      outline: none;
      transition: all 0.25s ease;
      caret-color: var(--gold);
    }
    .pin-digit:focus {
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(212,165,116,0.12);
      background: var(--bg-elevated);
    }
    .login-error {
      color: var(--salmon);
      font-size: 0.85rem;
      margin-bottom: 16px;
      min-height: 1.2em;
    }

    /* ── Success Animation ─────────────────────────────────────── */
    .success-toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: linear-gradient(135deg, #15803d, #166534);
      color: white;
      padding: 14px 24px;
      border-radius: var(--radius);
      font-weight: 500;
      z-index: 9999;
      transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .success-toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* ── Loading Spinner ───────────────────────────────────────── */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Leaderboard ───────────────────────────────────────────── */
    .leaderboard-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }
    .leaderboard-row:last-child { border-bottom: none; }
    .leaderboard-rank {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .rank-1 { background: linear-gradient(135deg, #d4a574, #c4915a); color: var(--bg-deepest); }
    .rank-2 { background: rgba(192,192,192,0.2); color: #c0c0c0; }
    .rank-3 { background: rgba(205,127,50,0.2); color: #cd7f32; }
    .rank-other { background: var(--bg-elevated); color: var(--text-muted); }
    .leaderboard-name { flex: 1; font-weight: 500; }
    .leaderboard-count {
      font-family: var(--font-heading);
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-heading);
    }

    /* ── Empty State ───────────────────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
    }
    .empty-state svg { color: var(--text-muted); margin-bottom: 16px; }
    .empty-state img { margin-bottom: 16px; opacity: 0.6; }
    .empty-state h3 {
      font-family: var(--font-heading);
      font-size: 1.3rem;
      color: var(--text-heading);
      margin-bottom: 8px;
    }
    .empty-state p {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* ── Tab Bar ────────────────────────────────────────────────── */
    .tab-bar {
      display: flex;
      gap: 4px;
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      padding: 4px;
      margin-bottom: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab-bar::-webkit-scrollbar { display: none; }
    .tab-item {
      flex: 1;
      min-width: fit-content;
      padding: 10px 14px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-family: var(--font-body);
      font-size: 0.78rem;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.25s ease;
      white-space: nowrap;
    }
    .tab-item.active {
      background: var(--bg-elevated);
      color: var(--gold);
    }

    /* ── Water ripple decoration ────────────────────────────────── */
    .water-ripple {
      position: absolute;
      border-radius: 50%;
      border: 1px solid rgba(45,212,191,0.15);
      animation: ripple 3s ease infinite;
    }

    /* ── Utilities ──────────────────────────────────────────────── */
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 8px; }
    .gap-3 { gap: 12px; }
    .gap-4 { gap: 16px; }
    .gap-5 { gap: 20px; }
    .mb-2 { margin-bottom: 8px; }
    .mb-3 { margin-bottom: 12px; }
    .mb-4 { margin-bottom: 16px; }
    .mb-5 { margin-bottom: 20px; }
    .mb-6 { margin-bottom: 24px; }
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    .text-sm { font-size: 0.85rem; }
    .text-xs { font-size: 0.75rem; }
    .text-muted { color: var(--text-muted); }
    .text-secondary { color: var(--text-secondary); }
    .text-gold { color: var(--gold); }
    .text-center { text-align: center; }
    .w-full { width: 100%; }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .hidden { display: none !important; }

    /* ── Leaflet Dark Tiles Fix ─────────────────────────────────── */
    .leaflet-tile-pane { filter: brightness(0.7) contrast(1.1) saturate(0.5); }
    .leaflet-control-zoom a {
      background: var(--bg-card) !important;
      color: var(--text-primary) !important;
      border-color: var(--border) !important;
    }
    .leaflet-popup-content-wrapper {
      background: var(--bg-card) !important;
      color: var(--text-primary) !important;
      border-radius: var(--radius-sm) !important;
      box-shadow: var(--shadow) !important;
    }
    .leaflet-popup-tip { background: var(--bg-card) !important; }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /* ═══════════════════════════════════════════════════════════════
       FISHING SYNDICATE — Single Page Application
       ═══════════════════════════════════════════════════════════════ */

    // ─── CONFIG ─────────────────────────────────────────────────
    const CONFIG = {
      // ⚠️ CHANGE THIS to your Cloudflare Worker URL after deployment
      API_URL: 'https://fishing-syndicate-api.ske-d03.workers.dev',

      // Default map center — set to your stretch of water
      MAP_CENTER: [55.19384108749472, -3.753964317847293],  // Ayrshire area
      MAP_ZOOM: 14,

      SPECIES: [
        { value: 'Salmon', label: 'Salmon', color: '#f87171', dot: 'species-dot-salmon', text: 'species-salmon' },
        { value: 'Brown Trout', label: 'Brown Trout', color: '#a78bfa', dot: 'species-dot-brown-trout', text: 'species-brown-trout' },
        { value: 'Sea Trout', label: 'Sea Trout', color: '#2dd4bf', dot: 'species-dot-sea-trout', text: 'species-sea-trout' },
        { value: 'Rainbow Trout', label: 'Rainbow Trout', color: '#f472b6', dot: 'species-dot-rainbow-trout', text: 'species-rainbow-trout' },
        { value: 'Grayling', label: 'Grayling', color: '#60a5fa', dot: 'species-dot-grayling', text: 'species-grayling' },
        { value: 'Other', label: 'Other', color: '#8b9ab5', dot: 'species-dot-other', text: 'species-other' },
      ],
    };

    function getSpeciesColor(species) {
      const s = CONFIG.SPECIES.find(sp => sp.value === species);
      return s ? s.color : '#8b9ab5';
    }
    function getSpeciesDotClass(species) {
      const s = CONFIG.SPECIES.find(sp => sp.value === species);
      return s ? s.dot : 'species-dot-other';
    }
    function getSpeciesTextClass(species) {
      const s = CONFIG.SPECIES.find(sp => sp.value === species);
      return s ? s.text : 'species-other';
    }

    // ─── STATE ──────────────────────────────────────────────────
    let state = {
      currentPage: 'login',
      user: null,     // { id, name, token }
      catches: [],
      myCatches: [],
      stats: null,
      members: [],
      loading: false,
      toast: null,
    };

    function setState(updates) {
      Object.assign(state, updates);
      render();
    }

    // ─── API ────────────────────────────────────────────────────
    async function api(path, options = {}) {
      const url = CONFIG.API_URL + path;
      const headers = { 'Content-Type': 'application/json' };
      if (state.user?.token) headers['Authorization'] = `Bearer ${state.user.token}`;

      try {
        const res = await fetch(url, { ...options, headers });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Request failed');
        return data;
      } catch (err) {
        console.error('API Error:', err);
        throw err;
      }
    }

    // ─── ICONS (inline SVG) ─────────────────────────────────────
    const icons = {
      home: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
      plus: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
      list: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
      chart: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
      fish: `<img src="https://pub-2ba725f0b0e64c299f9c2af3bdcaa07e.r2.dev/Logo/barjarglogo.png" alt="" style="width:36px;height:36px;object-fit:contain;">`,
      camera: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>`,
      mapPin: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
      calendar: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
      weight: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3a4 4 0 0 0-4 4h8a4 4 0 0 0-4-4z"/><path d="M5 7h14l-1.5 14H6.5L5 7z"/></svg>`,
      ruler: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M2 12h20M6 8v8M10 10v4M14 10v4M18 8v8"/></svg>`,
      trophy: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
      alert: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
      check: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`,
      logout: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
      user: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
      clock: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
      x: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
    };

    // ─── TOAST SYSTEM ───────────────────────────────────────────
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.success-toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'success-toast';
      toast.style.background = type === 'error'
        ? 'linear-gradient(135deg, #991b1b, #7f1d1d)'
        : 'linear-gradient(135deg, #15803d, #166534)';
      toast.innerHTML = `${type === 'error' ? icons.alert : icons.check} ${message}`;
      document.body.appendChild(toast);

      requestAnimationFrame(() => toast.classList.add('show'));
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 500);
      }, 3000);
    }

    // ─── RENDER ENGINE ──────────────────────────────────────────
    function render() {
      const app = document.getElementById('app');
      if (state.currentPage === 'login') {
        app.innerHTML = renderLogin();
        initLogin();
      } else {
        app.innerHTML = renderAppShell();
        initPage();
      }
    }

    // ─── LOGIN PAGE ─────────────────────────────────────────────
    function renderLogin() {
      return `
        <div class="login-screen">
          <div class="water-ripple" style="width:300px;height:300px;top:10%;left:-10%;animation-delay:0s;"></div>
          <div class="water-ripple" style="width:200px;height:200px;bottom:20%;right:-5%;animation-delay:1.5s;"></div>
          <div class="login-card animate-in">
            <img src="https://pub-2ba725f0b0e64c299f9c2af3bdcaa07e.r2.dev/Logo/barjarglogo.png" alt="Barjarg Fishings" style="width:180px;height:auto;margin-bottom:24px;">
            <div class="login-subtitle">Fishings</div>
            <div class="pin-input-group" id="pinGroup">
              <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]*" autofocus>
              <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]*">
              <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]*">
              <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric" pattern="[0-9]*">
            </div>
            <div class="login-error" id="loginError"></div>
            <button class="btn btn-primary btn-block" id="loginBtn" disabled>
              Enter
            </button>
            <p style="margin-top:24px;font-size:0.78rem;color:var(--text-muted);">
              Enter your 4-digit member PIN
            </p>
          </div>
        </div>
      `;
    }

    function initLogin() {
      const inputs = document.querySelectorAll('.pin-digit');
      const loginBtn = document.getElementById('loginBtn');
      const loginError = document.getElementById('loginError');

      inputs.forEach((input, idx) => {
        input.addEventListener('input', (e) => {
          const val = e.target.value.replace(/\D/g, '');
          e.target.value = val;
          if (val && idx < inputs.length - 1) inputs[idx + 1].focus();
          updateLoginBtn();
        });
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && idx > 0) {
            inputs[idx - 1].focus();
          }
          if (e.key === 'Enter') loginBtn.click();
        });
        // Handle paste
        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const pasted = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 4);
          pasted.split('').forEach((ch, i) => {
            if (inputs[i]) inputs[i].value = ch;
          });
          if (pasted.length === 4) inputs[3].focus();
          updateLoginBtn();
        });
      });

      function updateLoginBtn() {
        const pin = Array.from(inputs).map(i => i.value).join('');
        loginBtn.disabled = pin.length !== 4;
      }

      loginBtn.addEventListener('click', async () => {
        const pin = Array.from(inputs).map(i => i.value).join('');
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<div class="spinner"></div>';
        loginError.textContent = '';

        try {
          const data = await api('/api/auth', {
            method: 'POST',
            body: JSON.stringify({ pin }),
          });
          // Save session
          localStorage.setItem('fishing_session', JSON.stringify(data));
          setState({ user: data, currentPage: 'dashboard' });
          loadDashboardData();
        } catch (err) {
          loginError.textContent = 'Invalid PIN. Please try again.';
          loginBtn.disabled = false;
          loginBtn.innerHTML = 'Enter';
          inputs.forEach(i => i.value = '');
          inputs[0].focus();
        }
      });

      // Check for saved session
      const saved = localStorage.getItem('fishing_session');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data.token) {
            state.user = data;
            state.currentPage = 'dashboard';
            render();
            loadDashboardData();
          }
        } catch (e) {}
      }
    }

    // ─── APP SHELL ──────────────────────────────────────────────
    function renderAppShell() {
      let pageContent = '';
      switch (state.currentPage) {
        case 'dashboard': pageContent = renderDashboard(); break;
        case 'log': pageContent = renderLogCatch(); break;
        case 'history': pageContent = renderHistory(); break;
        case 'stats': pageContent = renderStats(); break;
        case 'gallery': pageContent = renderGallery(); break;
        case 'more': pageContent = renderMore(); break;
        case 'guests': pageContent = renderGuests(); break;
        case 'maintenance': pageContent = renderMaintenance(); break;
        default: pageContent = renderDashboard();
      }

      return `
        <div class="header">
          <div>
            <div class="header-brand"><img src="https://pub-2ba725f0b0e64c299f9c2af3bdcaa07e.r2.dev/Logo/barjarglogo.png" alt="Barjarg Fishings" style="height:32px;width:auto;vertical-align:middle;"></div>
          </div>
          <div class="header-user" onclick="handleLogout()" style="cursor:pointer;" title="Tap to logout">
            <div class="header-avatar">${state.user?.name?.charAt(0) || '?'}</div>
            <span>${state.user?.name || 'Angler'}</span>
          </div>
        </div>

        ${pageContent}

        <nav class="bottom-nav">
          <button class="nav-item ${state.currentPage === 'dashboard' ? 'active' : ''}" onclick="navigate('dashboard')">
            ${icons.home}
            Home
          </button>
          <button class="nav-item ${state.currentPage === 'history' ? 'active' : ''}" onclick="navigate('history')">
            ${icons.list}
            Catches
          </button>
          <button class="nav-item nav-item-log" onclick="navigate('log')" title="Log a catch">
            ${icons.plus}
          </button>
          <button class="nav-item ${state.currentPage === 'stats' ? 'active' : ''}" onclick="navigate('stats')">
            ${icons.chart}
            Stats
          </button>
          <button class="nav-item ${['more','gallery','guests','maintenance'].includes(state.currentPage) ? 'active' : ''}" onclick="navigate('more')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            More
          </button>
        </nav>
      `;
    }

    function navigate(page) {
      setState({ currentPage: page });
      window.scrollTo(0, 0);
      if (page === 'dashboard') loadDashboardData();
      if (page === 'history') loadCatches();
      if (page === 'stats') loadStats();
      if (page === 'gallery') loadGallery();
      if (page === 'guests') loadGuestsData();
      if (page === 'maintenance') loadMaintenanceData();
    }

    function handleLogout() {
      localStorage.removeItem('fishing_session');
      setState({ user: null, currentPage: 'login', catches: [], stats: null });
    }

    // ─── DASHBOARD PAGE ─────────────────────────────────────────
    function renderDashboard() {
      const s = state.stats;
      const greeting = getGreeting();

      return `
        <div class="page">
          <div class="animate-in mb-6" style="margin-top:8px;">
            <p class="text-secondary text-sm mb-2">${greeting}</p>
            <div class="flex justify-between items-center">
              <h1 class="heading-xl">${state.user?.name || 'Angler'}</h1>
              <button onclick="showSyndicateRules()" style="background:rgba(212,165,116,0.1);border:1px solid rgba(212,165,116,0.2);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all 0.2s;" title="Syndicate Rules">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
              </button>
            </div>
          </div>

          ${!s ? `
            <div class="text-center" style="padding:48px 0;">
              <div class="spinner" style="margin:0 auto;width:28px;height:28px;color:var(--gold);"></div>
              <p class="text-muted text-sm" style="margin-top:12px;">Loading your dashboard...</p>
            </div>
          ` : `
            <!-- Quick Stats -->
            <div class="grid-2 mb-5 animate-in animate-in-delay-1">
              <div class="card" style="text-align:center;">
                <div class="stat-value">${s.overview?.totalCatches || 0}</div>
                <div class="stat-label">Total Catches</div>
              </div>
              <div class="card" style="text-align:center;">
                <div class="stat-value">${Object.keys(s.overview?.speciesBreakdown || {}).length}</div>
                <div class="stat-label">Species</div>
              </div>
            </div>

            <!-- Check In/Out -->
            <div class="card mb-5 animate-in animate-in-delay-1" id="checkinCard">
              <div class="flex justify-between items-center">
                <div>
                  <div class="section-label flex items-center gap-2">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                    River Status
                  </div>
                  <div id="checkinStatus" class="text-sm text-muted" style="margin-top:4px;">Loading...</div>
                </div>
                <div id="checkinBtnArea"></div>
              </div>
              <div id="onRiverList" style="margin-top:10px;"></div>
            </div>

            <!-- Weather Forecast -->
            <div class="card mb-5 animate-in animate-in-delay-1" id="forecastCard" style="overflow:hidden;">
              <div class="flex justify-between items-center mb-3">
                <div class="section-label" style="margin-bottom:0;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px;"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>
                  Weather Forecast
                </div>
                <span class="text-xs text-muted">Barjarg</span>
              </div>
              <div id="forecastContent">
                <div class="flex items-center gap-2">
                  <div class="spinner" style="width:16px;height:16px;color:var(--teal);"></div>
                  <span class="text-sm text-muted">Loading forecast...</span>
                </div>
              </div>
            </div>

            <!-- Water Level -->
            <div class="card mb-5 animate-in animate-in-delay-1" id="waterLevelCard" style="overflow:hidden;">
              <div class="flex justify-between items-center mb-3">
                <div class="section-label" style="margin-bottom:0;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px;"><path d="M2 12c2-3 4-3 6 0s4 3 6 0 4-3 6 0"/><path d="M2 18c2-3 4-3 6 0s4 3 6 0 4-3 6 0"/></svg>
                  River Level
                </div>
                <a href="https://waterlevels.sepa.org.uk/Station/133156" target="_blank" rel="noopener" class="text-xs" style="color:var(--text-muted);text-decoration:none;">SEPA ↗</a>
              </div>
              <div id="waterLevelContent">
                <div class="flex items-center gap-2">
                  <div class="spinner" style="width:16px;height:16px;color:var(--teal);"></div>
                  <span class="text-sm text-muted">Loading water level...</span>
                </div>
              </div>
            </div>

            ${s.records?.biggestFish ? `
              <div class="card mb-5 animate-in animate-in-delay-2" style="background:linear-gradient(135deg, rgba(212,165,116,0.08), rgba(212,165,116,0.02)); border-color:rgba(212,165,116,0.15);">
                <div class="section-label flex items-center gap-2">${icons.trophy} Biggest Fish</div>
                <div class="flex items-center gap-3">
                  <div>
                    <div class="heading-lg ${getSpeciesTextClass(s.records.biggestFish.species)}">${s.records.biggestFish.species === 'Other' ? (s.records.biggestFish.customSpecies || 'Other') : s.records.biggestFish.species}</div>
                    <div class="text-secondary text-sm">${s.records.biggestFish.weight}lb — caught by ${s.records.biggestFish.memberName}</div>
                    <div class="text-muted text-xs mt-2">${formatDate(s.records.biggestFish.date)}</div>
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- League Table Preview -->
            <div class="animate-in animate-in-delay-2" id="leaguePreview" style="display:none;">
              <div class="flex justify-between items-center mb-3">
                <div class="section-label flex items-center gap-2">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                  League Table
                </div>
                <button class="btn btn-ghost" onclick="navigate('stats')" style="font-size:0.7rem;padding:4px 8px;">View All</button>
              </div>
              <div id="leaguePreviewContent" class="card" style="padding:0;overflow:hidden;"></div>
            </div>

            ${(state.myCatches || []).length > 0 ? `
              <div class="animate-in animate-in-delay-3">
                <div class="section-label mb-3">Your Recent Catches</div>
                <div class="flex flex-col gap-3">
                  ${(state.myCatches || []).slice(0, 5).map((c, i) => renderCatchCard(c, i)).join('')}
                </div>
              </div>
            ` : `
              <div class="empty-state animate-in animate-in-delay-2">
                ${icons.fish}
                <h3>No catches yet</h3>
                <p>Tap the + button to log your first catch</p>
              </div>
            `}

            ${(() => {
              const others = (s.recentCatches || []).filter(c => c.memberId !== state.user?.id).slice(0, 3);
              return others.length > 0 ? `
                <div class="animate-in animate-in-delay-4" style="margin-top:24px;">
                  <div class="section-label mb-3">Syndicate Activity</div>
                  <div class="flex flex-col gap-3">
                    ${others.map((c, i) => renderCatchCard(c, i)).join('')}
                  </div>
                </div>
              ` : '';
            })()}
          `}
        </div>
      `;
    }

    async function loadDashboardData() {
      try {
        const [stats, myCatches] = await Promise.all([
          api('/api/stats'),
          api(`/api/catches?memberId=${state.user?.id}`),
        ]);
        setState({ stats, myCatches });
        // Load thumbnails for user's recent catches on dashboard
        loadCatchThumbnails(myCatches.slice(0, 5));
        // Also load thumbnails for syndicate activity
        const otherCatches = (stats.recentCatches || []).filter(c => c.memberId !== state.user?.id);
        loadCatchThumbnails(otherCatches.slice(0, 3));
      } catch (err) {
        console.error('Failed to load stats:', err);
        setState({ stats: { overview: { totalCatches: 0, speciesBreakdown: {}, uniqueVisitDays: 0, successRate: 0, photoCatches: 0, totalWeight: 0, catchesPerVisitDay: 0, speciesCount: 0 }, records: { biggestFish: null, longestFish: null, speciesRecords: {}, bestDay: null }, memberStats: [], timeAnalysis: { byHour: {}, byDayOfWeek: {}, byMonth: {}, byCalendarMonth: {} }, conditions: { tempRanges: {}, windRanges: {}, byWeatherType: {}, byClarity: {}, waterTempRanges: {}, fightTime: {} }, baitsAndMethods: { baitStats: {}, methodStats: {}, baitBySpecies: {} }, locations: { hotspots: [], bestBySpecies: {} }, recentCatches: [] }, myCatches: [] });
      }
      // Fetch water level, checkins, league, and forecast independently
      try { loadWaterLevel(); } catch (e) {}
      try { loadCheckinStatus(); } catch (e) {}
      try { loadLeaguePreview(); } catch (e) {}
      try { loadWeatherForecast(); } catch (e) {}
    }

    // ─── CHECK IN / OUT ─────────────────────────────────────────
    async function loadCheckinStatus() {
      try {
        const active = await api('/api/checkins');
        const card = document.getElementById('checkinCard');
        const status = document.getElementById('checkinStatus');
        const btnArea = document.getElementById('checkinBtnArea');
        const list = document.getElementById('onRiverList');
        if (!card) return;

        const myCheckin = active.find(c => c.memberId === state.user?.id);
        const others = active.filter(c => c.memberId !== state.user?.id);

        if (myCheckin) {
          const since = new Date(myCheckin.checkInTime).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          const hoursAgo = (Date.now() - new Date(myCheckin.checkInTime).getTime()) / (1000 * 60 * 60);

          if (hoursAgo >= 12) {
            // Stale check-in — show "Still here?" prompt
            status.innerHTML = `<span style="color:var(--gold);">Checked in since ${since} — still on the river?</span>`;
            btnArea.innerHTML = `
              <div class="flex gap-2">
                <button class="btn btn-sm" onclick="confirmStillHere()" style="background:var(--teal);color:var(--bg);font-size:0.7rem;padding:6px 12px;">Still here</button>
                <button class="btn btn-sm" onclick="doCheckout()" style="background:var(--border);color:var(--text-secondary);font-size:0.7rem;padding:6px 12px;">Check out</button>
              </div>
            `;
          } else {
            status.innerHTML = `<span style="color:var(--teal);">You're on the river</span> since ${since}`;
            btnArea.innerHTML = `<button class="btn btn-sm" onclick="doCheckout()" style="background:var(--border);color:var(--text-secondary);font-size:0.7rem;padding:6px 14px;">Check Out</button>`;
          }
        } else {
          status.innerHTML = active.length > 0 ? `<span style="color:var(--gold);">${active.length} angler${active.length > 1 ? 's' : ''} on the river</span>` : 'Nobody on the river';
          btnArea.innerHTML = `<button class="btn btn-sm" onclick="doCheckin()" style="background:var(--teal);color:var(--bg);font-size:0.7rem;padding:6px 14px;">Check In</button>`;
        }

        if (active.length > 0) {
          list.innerHTML = active.map(c => {
            const since = new Date(c.checkInTime).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const isMe = c.memberId === state.user?.id;
            return `<div class="flex items-center gap-2" style="padding:4px 0;">
              <div style="width:6px;height:6px;border-radius:50%;background:var(--teal);"></div>
              <span class="text-xs" style="color:${isMe ? 'var(--teal)' : 'var(--text-secondary)'};">${c.memberName}</span>
              <span class="text-xs text-muted" style="margin-left:auto;">${since}${c.pool ? ' · ' + c.pool : ''}</span>
            </div>`;
          }).join('');
        } else {
          list.innerHTML = '';
        }
      } catch (e) {
        console.error('Checkin load error:', e);
      }
    }

    async function confirmStillHere() {
      // Re-check-in to reset the timer
      try {
        await api('/api/checkout', { method: 'POST', body: JSON.stringify({ memberId: state.user.id, memberName: state.user.name }) });
        await api('/api/checkin', { method: 'POST', body: JSON.stringify({ memberId: state.user.id, memberName: state.user.name }) });
        showToast('Confirmed — tight lines!');
        loadCheckinStatus();
      } catch (e) { showToast('Failed to confirm', 'error'); }
    }

    async function doCheckin() {
      try {
        await api('/api/checkin', { method: 'POST', body: JSON.stringify({ memberId: state.user.id, memberName: state.user.name }) });
        showToast('Checked in — tight lines!');
        loadCheckinStatus();
      } catch (e) { showToast(e.message || 'Failed to check in', 'error'); }
    }

    async function doCheckout() {
      try {
        await api('/api/checkout', { method: 'POST', body: JSON.stringify({ memberId: state.user.id, memberName: state.user.name }) });
        showToast('Checked out');
        loadCheckinStatus();
      } catch (e) { showToast(e.message || 'Failed to check out', 'error'); }
    }

    // ─── LEAGUE TABLE PREVIEW ───────────────────────────────────
    async function loadLeaguePreview() {
      try {
        const league = await api('/api/league');
        const container = document.getElementById('leaguePreviewContent');
        const wrapper = document.getElementById('leaguePreview');
        if (!container || !wrapper) return;
        if (league.length === 0) { wrapper.style.display = 'none'; return; }
        wrapper.style.display = 'block';
        const top5 = league.slice(0, 5);
        container.innerHTML = top5.map((m, i) => {
          const isMe = m.id === state.user?.id;
          const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : '';
          return `<div class="flex items-center gap-3" style="padding:10px 14px;border-bottom:${i < top5.length - 1 ? '1px solid var(--border)' : 'none'};${isMe ? 'background:rgba(212,165,116,0.05);' : ''}">
            <div style="width:22px;text-align:center;font-size:${medal ? '1rem' : '0.75rem'};color:var(--text-muted);font-weight:600;">${medal || (i + 1)}</div>
            <div style="flex:1;min-width:0;">
              <div class="text-sm" style="font-weight:${isMe ? '600' : '500'};${isMe ? 'color:var(--gold);' : ''}">${m.name}</div>
            </div>
            <div class="text-right">
              <div class="text-sm" style="font-weight:600;">${m.totalCatches}</div>
              <div class="text-xs text-muted">catches</div>
            </div>
            <div class="text-right" style="min-width:50px;">
              <div class="text-sm">${m.biggestFish > 0 ? m.biggestFish + 'lb' : '-'}</div>
              <div class="text-xs text-muted">best</div>
            </div>
          </div>`;
        }).join('');
      } catch (e) {
        console.error('League load error:', e);
      }
    }

    async function loadWaterLevel() {
      const container = document.getElementById('waterLevelContent');
      if (!container) return;

      try {
        const data = await api('/api/water-level?period=P2D');

        if (!data || data.error || data.current === null) {
          container.innerHTML = `<p class="text-sm text-muted">Water level data unavailable</p>`;
          return;
        }

        const trendIcon = data.trend === 'rising' ? '↑' : data.trend === 'falling' ? '↓' : '→';
        const trendColor = data.trend === 'rising' ? 'var(--teal)' : data.trend === 'falling' ? 'var(--salmon)' : 'var(--text-secondary)';
        const trendLabel = data.trend.charAt(0).toUpperCase() + data.trend.slice(1);

        // Build mini sparkline SVG from readings
        const chartHtml = buildWaterChart(data.readings);

        container.innerHTML = `
          <div class="flex items-center gap-4 mb-3">
            <div>
              <div style="font-family:var(--font-heading);font-size:2rem;font-weight:700;color:var(--teal);line-height:1;">
                ${data.current.toFixed(2)}<span style="font-size:0.9rem;font-weight:400;color:var(--text-muted);"> ${data.unit}</span>
              </div>
              <div class="text-xs mt-2" style="color:${trendColor};font-weight:600;">
                ${trendIcon} ${trendLabel}
              </div>
            </div>
            <div style="margin-left:auto;text-align:right;">
              <div class="text-xs text-muted">High: <span style="color:var(--text-secondary);">${data.max.toFixed(2)}${data.unit}</span></div>
              <div class="text-xs text-muted">Low: <span style="color:var(--text-secondary);">${data.min.toFixed(2)}${data.unit}</span></div>
              <div class="text-xs text-muted">Avg: <span style="color:var(--text-secondary);">${data.avg.toFixed(2)}${data.unit}</span></div>
            </div>
          </div>
          ${chartHtml}
          <div class="flex justify-between mt-2">
            <span class="text-xs text-muted">${data.river}</span>
            <span class="text-xs text-muted">Updated: ${formatTimestamp(data.lastReading)}</span>
          </div>
        `;
      } catch (err) {
        console.error('Water level fetch failed:', err);
        container.innerHTML = `
          <p class="text-sm text-muted">Could not load water level</p>
          <a href="https://waterlevels.sepa.org.uk/Station/133156" target="_blank" rel="noopener" class="text-xs" style="color:var(--teal);">View on SEPA ↗</a>
        `;
      }
    }

    // ─── WEATHER FORECAST ───────────────────────────────────────
    async function loadWeatherForecast() {
      const container = document.getElementById('forecastContent');
      if (!container) return;
      try {
        const resp = await fetch('https://api.open-meteo.com/v1/forecast?latitude=55.1938&longitude=-3.754&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode,windspeed_10m_max&current=temperature_2m,weathercode,windspeed_10m,relativehumidity_2m&timezone=Europe/London&forecast_days=5');
        const data = await resp.json();
        if (!data.daily) { container.innerHTML = '<p class="text-sm text-muted">Forecast unavailable</p>'; return; }

        const wmoIcon = (code) => {
          if (code <= 1) return '☀️';
          if (code <= 3) return '⛅';
          if (code <= 48) return '☁️';
          if (code <= 55) return '🌧️';
          if (code <= 57) return '🌧️';
          if (code <= 65) return '🌧️';
          if (code <= 67) return '🌧️';
          if (code <= 75) return '🌨️';
          if (code <= 77) return '🌨️';
          if (code <= 82) return '🌧️';
          if (code <= 86) return '🌨️';
          if (code <= 99) return '⛈️';
          return '🌡️';
        };
        const wmoDesc = (code) => {
          if (code <= 1) return 'Clear';
          if (code <= 3) return 'Cloudy';
          if (code <= 48) return 'Overcast';
          if (code <= 55) return 'Drizzle';
          if (code <= 65) return 'Rain';
          if (code <= 67) return 'Freezing rain';
          if (code <= 77) return 'Snow';
          if (code <= 82) return 'Showers';
          if (code <= 99) return 'Thunderstorm';
          return '';
        };

        const d = data.daily;
        const c = data.current;
        const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

        // Current conditions header
        const currentHtml = c ? `
          <div class="flex items-center gap-3 mb-3" style="padding-bottom:10px;border-bottom:1px solid var(--border);">
            <div style="font-size:2rem;">${wmoIcon(c.weathercode)}</div>
            <div style="flex:1;">
              <div style="font-weight:600;font-size:1.1rem;">${Math.round(c.temperature_2m)}°C</div>
              <div class="text-xs text-muted">${wmoDesc(c.weathercode)} · Wind ${Math.round(c.windspeed_10m)} mph · ${c.relativehumidity_2m}% humidity</div>
            </div>
            <div class="text-xs text-muted" style="text-align:right;">Now</div>
          </div>
        ` : '';

        // 5-day forecast strip using same color approach as water level chart
        const maxRain = Math.max(...d.precipitation_sum, 1);
        const forecastHtml = d.time.map((date, i) => {
          const dt = new Date(date + 'T00:00:00');
          const dayLabel = i === 0 ? 'Today' : i === 1 ? 'Tomorrow' : dayNames[dt.getDay()];
          const rain = d.precipitation_sum[i];
          const rainBarH = Math.round((rain / maxRain) * 20);
          const rainColor = rain > 10 ? '#3b82f6' : rain > 5 ? '#60a5fa' : rain > 1 ? '#93c5fd' : 'rgba(147,197,253,0.3)';

          return `<div style="flex:1;min-width:56px;text-align:center;padding:6px 2px;">
            <div class="text-xs" style="font-weight:600;margin-bottom:4px;color:${i === 0 ? 'var(--gold)' : 'var(--text-secondary)'};">${dayLabel}</div>
            <div style="font-size:1.3rem;line-height:1;margin-bottom:4px;">${wmoIcon(d.weathercode[i])}</div>
            <div class="text-xs" style="font-weight:600;">${Math.round(d.temperature_2m_max[i])}°</div>
            <div class="text-xs text-muted">${Math.round(d.temperature_2m_min[i])}°</div>
            <div style="margin:6px auto 2px;width:16px;height:24px;display:flex;align-items:flex-end;justify-content:center;">
              <div style="width:100%;height:${Math.max(rainBarH, 2)}px;background:${rainColor};border-radius:2px 2px 0 0;"></div>
            </div>
            <div class="text-xs text-muted" style="font-size:0.6rem;">${rain.toFixed(1)}mm</div>
            <div class="text-xs text-muted" style="margin-top:2px;font-size:0.6rem;">${Math.round(d.windspeed_10m_max[i])}mph</div>
          </div>`;
        }).join('');

        container.innerHTML = `
          ${currentHtml}
          <div class="flex" style="gap:0;">${forecastHtml}</div>
        `;
      } catch (e) {
        console.error('Forecast error:', e);
        container.innerHTML = '<p class="text-sm text-muted">Could not load forecast</p>';
      }
    }

    function buildWaterChart(readings) {
      if (!readings || readings.length < 2) return '';

      const width = 320;
      const height = 80;
      const padding = { top: 8, bottom: 8, left: 0, right: 0 };

      const values = readings.map(r => r.value);
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = max - min || 0.1;

      const chartW = width - padding.left - padding.right;
      const chartH = height - padding.top - padding.bottom;

      // Build polyline points
      const points = values.map((v, i) => {
        const x = padding.left + (i / (values.length - 1)) * chartW;
        const y = padding.top + chartH - ((v - min) / range) * chartH;
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(' ');

      // Build gradient fill area
      const areaPoints = points +
        ` ${(padding.left + chartW).toFixed(1)},${(padding.top + chartH).toFixed(1)}` +
        ` ${padding.left.toFixed(1)},${(padding.top + chartH).toFixed(1)}`;

      // Average line
      const avg = values.reduce((a, b) => a + b, 0) / values.length;
      const avgY = padding.top + chartH - ((avg - min) / range) * chartH;

      return `
        <svg viewBox="0 0 ${width} ${height}" style="width:100%;height:80px;display:block;" preserveAspectRatio="none">
          <defs>
            <linearGradient id="waterGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="rgba(45,212,191,0.3)"/>
              <stop offset="100%" stop-color="rgba(45,212,191,0.02)"/>
            </linearGradient>
          </defs>
          <polygon points="${areaPoints}" fill="url(#waterGrad)"/>
          <line x1="${padding.left}" y1="${avgY.toFixed(1)}" x2="${padding.left + chartW}" y2="${avgY.toFixed(1)}"
            stroke="rgba(45,212,191,0.2)" stroke-width="1" stroke-dasharray="4,4"/>
          <polyline points="${points}" fill="none" stroke="var(--teal)" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round"/>
        </svg>
      `;
    }

    function formatTimestamp(ts) {
      if (!ts) return '';
      try {
        const d = new Date(ts);
        return d.toLocaleString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
      } catch {
        return ts;
      }
    }

    // ─── LOG CATCH PAGE ─────────────────────────────────────────
    let logMode = 'catch';

    function renderLogCatch() {
      return `
        <div class="page">
          <div class="animate-in mb-4" style="margin-top:8px;">
            <div class="section-label">New Entry</div>
            <div class="flex gap-2 mt-3" style="background:var(--bg-card);border-radius:var(--radius);padding:4px;border:1px solid var(--border);">
              <button class="btn btn-sm btn-block ${logMode === 'catch' ? 'btn-primary' : 'btn-ghost'}" onclick="logMode='catch';render();" style="flex:1;">Log Catch</button>
              <button class="btn btn-sm btn-block ${logMode === 'visit' ? 'btn-primary' : 'btn-ghost'}" onclick="logMode='visit';render();" style="flex:1;">Log Visit</button>
            </div>
          </div>

          ${logMode === 'visit' ? renderVisitForm() : renderCatchForm()}
        </div>
      `;
    }

    function renderVisitForm() {
      return `
        <div id="visitForm" class="animate-in">
          <div class="card mb-4" style="background:linear-gradient(135deg, rgba(45,212,191,0.06), rgba(45,212,191,0.02));border-color:rgba(45,212,191,0.15);">
            <p class="text-sm" style="color:var(--text-secondary);line-height:1.6;">Log a fishing session — even if you blanked. This tracks your effort and helps calculate success rates across the syndicate.</p>
          </div>

          <div class="grid-2">
            <div class="form-group">
              <label class="form-label">Date</label>
              <input class="form-input" type="date" id="visitDate" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="form-group">
              <label class="form-label">Duration (hrs)</label>
              <input class="form-input" type="number" id="visitDuration" step="0.5" min="0" placeholder="e.g. 4">
            </div>
          </div>

          <div class="grid-2">
            <div class="form-group">
              <label class="form-label">Start Time <span class="optional">(opt)</span></label>
              <input class="form-input" type="time" id="visitStartTime">
            </div>
            <div class="form-group">
              <label class="form-label">End Time <span class="optional">(opt)</span></label>
              <input class="form-input" type="time" id="visitEndTime">
            </div>
          </div>

          <div class="grid-2">
            <div class="form-group">
              <label class="form-label">Water Temp (°C) <span class="optional">(opt)</span></label>
              <input class="form-input" type="number" id="visitWaterTemp" step="0.5" min="0" max="30" placeholder="e.g. 12">
            </div>
            <div class="form-group">
              <label class="form-label">Water Clarity <span class="optional">(opt)</span></label>
              <select class="form-select" id="visitWaterClarity">
                <option value="">Select...</option>
                <option value="Crystal Clear">Crystal Clear</option>
                <option value="Clear">Clear</option>
                <option value="Slightly Coloured">Slightly Coloured</option>
                <option value="Coloured">Coloured</option>
                <option value="Muddy">Muddy</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Notes <span class="optional">(optional)</span></label>
            <textarea class="form-textarea" id="visitNotes" placeholder="Conditions, what you tried, why it was quiet..."></textarea>
          </div>

          <button class="btn btn-primary btn-block" id="submitVisitBtn" onclick="submitVisit()">
            Log This Visit
          </button>
          <div style="height:120px;"></div>
        </div>
      `;
    }

    async function submitVisit() {
      const btn = document.getElementById('submitVisitBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;"></div> Logging...';

      try {
        await api('/api/visits', {
          method: 'POST',
          body: JSON.stringify({
            memberId: state.user.id,
            memberName: state.user.name,
            date: document.getElementById('visitDate').value,
            startTime: document.getElementById('visitStartTime').value || null,
            endTime: document.getElementById('visitEndTime').value || null,
            duration: document.getElementById('visitDuration').value || null,
            waterTemp: document.getElementById('visitWaterTemp').value || null,
            waterClarity: document.getElementById('visitWaterClarity').value || null,
            notes: document.getElementById('visitNotes').value || null,
          }),
        });
        showToast('Visit logged!');
        navigate('dashboard');
      } catch (err) {
        showToast('Failed: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Log This Visit';
      }
    }

    function renderCatchForm() {
      return `
          <div id="catchForm" class="animate-in animate-in-delay-1">
            <!-- Species -->
            <div class="form-group">
              <label class="form-label">Species *</label>
              <select class="form-select" id="species" onchange="toggleCustomSpecies()">
                <option value="">Select species...</option>
                ${CONFIG.SPECIES.map(s => `<option value="${s.value}">${s.label}</option>`).join('')}
              </select>
            </div>
            <div class="form-group hidden" id="customSpeciesGroup">
              <label class="form-label">Specify Species</label>
              <input class="form-input" id="customSpecies" placeholder="e.g. Pike, Perch...">
            </div>

            <!-- NDSFB Classification -->
            <div class="form-group hidden" id="keptReleasedGroup">
              <label class="form-label">Kept or Released</label>
              <div class="flex gap-2">
                <button type="button" class="btn btn-secondary btn-sm flex-1" id="btnReleased" onclick="setKeptReleased('Released')" style="padding:10px;">Released</button>
                <button type="button" class="btn btn-secondary btn-sm flex-1" id="btnKept" onclick="setKeptReleased('Kept')" style="padding:10px;">Kept</button>
              </div>
              <input type="hidden" id="keptReleased" value="Released">
            </div>
            <div class="form-group hidden" id="fishTypeGroup">
              <label class="form-label">Fish Type</label>
              <select class="form-select" id="fishType">
                <option value="Wild">Wild fish</option>
                <option value="Farmed">Farmed escape</option>
              </select>
            </div>
            <div class="form-group hidden" id="grilseGroup">
              <label class="form-label">Classification</label>
              <div class="flex gap-2">
                <button type="button" class="btn btn-secondary btn-sm flex-1" id="btnSalmonAdult" onclick="setGrilse(false)" style="padding:10px;">Adult Salmon</button>
                <button type="button" class="btn btn-secondary btn-sm flex-1" id="btnGrilse" onclick="setGrilse(true)" style="padding:10px;">Grilse</button>
              </div>
              <input type="hidden" id="isGrilse" value="false">
            </div>
            <div class="form-group hidden" id="seaTroutTypeGroup">
              <label class="form-label">Classification</label>
              <div class="flex gap-2">
                <button type="button" class="btn btn-secondary btn-sm flex-1" id="btnAdult" onclick="setSeaTroutType('Adult')" style="padding:10px;">Adult</button>
                <button type="button" class="btn btn-secondary btn-sm flex-1" id="btnHerling" onclick="setSeaTroutType('Herling/Finnock')" style="padding:10px;">Herling / Finnock</button>
              </div>
              <input type="hidden" id="seaTroutType" value="Adult">
            </div>

            <!-- Date & Time -->
            <div class="grid-2">
              <div class="form-group">
                <label class="form-label">Date</label>
                <input class="form-input" type="date" id="catchDate" value="${new Date().toISOString().split('T')[0]}">
              </div>
              <div class="form-group">
                <label class="form-label">Time <span class="optional">(optional)</span></label>
                <input class="form-input" type="time" id="catchTime">
              </div>
            </div>

            <!-- Weight & Length -->
            <div class="grid-2">
              <div class="form-group">
                <label class="form-label">Weight (lb) <span class="optional">(optional)</span></label>
                <input class="form-input" type="number" id="weight" step="0.01" min="0" placeholder="e.g. 8.5">
              </div>
              <div class="form-group">
                <label class="form-label">Length (in) <span class="optional">(optional)</span></label>
                <input class="form-input" type="number" id="length" step="0.1" min="0" placeholder="e.g. 24">
              </div>
            </div>

            <!-- Bait & Method -->
            <div class="form-group">
              <label class="form-label">Bait / Fly Used <span class="optional">(optional)</span></label>
              <input class="form-input" id="bait" placeholder="e.g. Mepps Aglia #3, Woolly Bugger...">
            </div>
            <div class="form-group">
              <label class="form-label">Method <span class="optional">(optional)</span></label>
              <select class="form-select" id="method">
                <option value="">Select method...</option>
                <option value="Fly">Fly</option>
                <option value="Spinning">Spinning</option>
                <option value="Bait">Bait</option>
                <option value="Trolling">Trolling</option>
                <option value="Worming">Worming</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Location Map -->
            <div class="form-group">
              <label class="form-label">Location <span class="optional">(tap map to mark)</span></label>
              <div class="map-container" id="mapContainer">
                <div id="catchMap"></div>
                <div class="map-hint" id="mapHint">Tap to mark catch location</div>
              </div>
              <input class="form-input mt-2" id="locationName" placeholder="Pool / beat name (optional)" style="margin-top:8px;">
              <input type="hidden" id="lat">
              <input type="hidden" id="lng">
            </div>

            <!-- Photo -->
            <div class="form-group">
              <label class="form-label">Photograph <span class="optional">(optional)</span></label>

            <!-- Weather (auto-fetched) -->
            <div class="form-group" id="weatherGroup" style="display:none;">
              <label class="form-label">Weather Conditions <span class="optional">(auto-detected)</span></label>
              <div class="card" id="weatherDisplay" style="background:var(--bg-input);padding:14px 16px;">
                <div class="flex items-center gap-3">
                  <div id="weatherIcon" style="font-size:1.6rem;">--</div>
                  <div>
                    <div id="weatherTemp" style="font-weight:600;font-size:1rem;">--</div>
                    <div id="weatherDesc" class="text-muted text-xs">Fetching weather...</div>
                  </div>
                  <div style="margin-left:auto;text-align:right;">
                    <div id="weatherWind" class="text-xs text-secondary">--</div>
                    <div id="weatherExtra" class="text-xs text-muted">--</div>
                  </div>
                </div>
              </div>
              <input type="hidden" id="weatherData">
            </div>
              <div class="photo-upload" id="photoUpload">
                <div id="photoPreview">
                  <div class="flex items-center justify-center gap-3">
                    <div class="photo-upload-icon" style="margin:0;">${icons.camera}</div>
                    <div style="text-align:left;">
                      <p class="text-sm" style="color:var(--text-secondary);">Add a photo</p>
                      <p class="text-muted text-xs">Choose from library or take a photo</p>
                    </div>
                  </div>
                </div>
                <input type="file" accept="image/*" id="photoInput" onchange="handlePhotoSelect(this)">
              </div>
            </div>

            <!-- Water Conditions & Fight -->
            <div class="grid-2">
              <div class="form-group">
                <label class="form-label">Water Temp (°C) <span class="optional">(optional)</span></label>
                <input class="form-input" type="number" id="waterTemp" step="0.5" min="0" max="30" placeholder="e.g. 12">
                <div id="waterTempHint" class="text-xs text-muted" style="margin-top:3px;display:none;"></div>
              </div>
              <div class="form-group">
                <label class="form-label">Fight Time (min) <span class="optional">(optional)</span></label>
                <input class="form-input" type="number" id="fightTime" step="0.5" min="0" placeholder="e.g. 5">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Water Clarity <span class="optional">(optional)</span></label>
              <select class="form-select" id="waterClarity">
                <option value="">Select clarity...</option>
                <option value="Crystal Clear">Crystal Clear</option>
                <option value="Clear">Clear</option>
                <option value="Slightly Coloured">Slightly Coloured</option>
                <option value="Coloured">Coloured</option>
                <option value="Muddy">Muddy</option>
              </select>
              <div id="waterClarityHint" class="text-xs text-muted" style="margin-top:3px;display:none;"></div>
            </div>

            <!-- Tags -->
            <div class="form-group">
              <label class="form-label">Tags <span class="optional">(optional)</span></label>
              <div id="tagContainer" class="flex gap-2" style="flex-wrap:wrap;margin-bottom:8px;"></div>
              <div class="flex gap-2">
                <input class="form-input" id="tagInput" placeholder="e.g. PB, First of season..." style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();addTag();}">
                <button type="button" class="btn btn-secondary btn-sm" onclick="addTag()" style="padding:8px 14px;">Add</button>
              </div>
              <div class="flex gap-2 mt-2" style="flex-wrap:wrap;">
                ${['PB', 'First of Season', 'Specimen', 'Rising Fish', 'Night Fishing', 'High Water', 'Low Water', 'Coloured Water'].map(t =>
                  `<button type="button" class="btn btn-ghost" onclick="addQuickTag('${t}')" style="padding:3px 10px;font-size:0.65rem;border-radius:20px;border:1px solid var(--border);">${t}</button>`
                ).join('')}
              </div>
            </div>

            <!-- Notes -->
            <div class="form-group">
              <label class="form-label">Notes <span class="optional">(optional)</span></label>
              <textarea class="form-textarea" id="notes" placeholder="Conditions, water level, anything notable..."></textarea>
            </div>

            <!-- Missing Fields Warning -->
            <div id="missingWarning" class="warning-banner hidden">
              ${icons.alert}
              <p id="missingText">Some optional fields haven't been filled in.</p>
            </div>

            <!-- Submit -->
            <button class="btn btn-primary btn-block" id="submitBtn" onclick="submitCatch()">
              Log This Catch
            </button>
            <div style="height:120px;"></div>
          </div>
      `;
    }

    let catchMap = null;
    let catchMarker = null;
    let photoData = null;

    function initLogCatchPage() {
      // Reset map if the DOM was rebuilt (mode switch)
      if (catchMap) {
        try { catchMap.remove(); } catch (e) {}
        catchMap = null;
        catchMarker = null;
      }
      photoData = null;

      // Init map (only in catch mode)
      setTimeout(() => {
        const mapEl = document.getElementById('catchMap');
        if (!mapEl) return;

        catchMap = L.map('catchMap', {
          center: CONFIG.MAP_CENTER,
          zoom: CONFIG.MAP_ZOOM,
          zoomControl: true,
          attributionControl: false,
        });

        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
        streetLayer.addTo(catchMap);

        // Add satellite toggle
        const toggleDiv = document.createElement('div');
        toggleDiv.style.cssText = 'position:absolute;top:10px;right:10px;z-index:1000;';
        toggleDiv.innerHTML = `<button id="mapToggle" onclick="toggleMapLayer()" style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;font-size:0.7rem;color:var(--text-secondary);cursor:pointer;font-family:var(--font-body);backdrop-filter:blur(8px);">Satellite</button>`;
        document.getElementById('mapContainer').appendChild(toggleDiv);
        window._catchMapStreet = streetLayer;
        window._catchMapSatellite = satelliteLayer;
        window._catchMapIsSatellite = false;

        catchMap.on('click', (e) => {
          const { lat, lng } = e.latlng;
          document.getElementById('lat').value = lat.toFixed(6);
          document.getElementById('lng').value = lng.toFixed(6);
          document.getElementById('mapHint').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

          if (catchMarker) catchMap.removeLayer(catchMarker);
          catchMarker = L.marker([lat, lng], {
            icon: L.divIcon({
              className: '',
              html: `<div style="width:24px;height:24px;background:var(--gold);border:3px solid white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.4);"></div>`,
              iconSize: [24, 24],
              iconAnchor: [12, 12],
            }),
          }).addTo(catchMap);

          // Fetch weather for this location
          fetchWeather(lat, lng);
        });

        // Auto-fetch weather for default map centre
        fetchWeather(CONFIG.MAP_CENTER[0], CONFIG.MAP_CENTER[1]);

        // Invalidate size after animation
        setTimeout(() => catchMap.invalidateSize(), 500);
      }, 100);
    }

    function toggleMapLayer() {
      if (!catchMap) return;
      if (window._catchMapIsSatellite) {
        catchMap.removeLayer(window._catchMapSatellite);
        window._catchMapStreet.addTo(catchMap);
        document.getElementById('mapToggle').textContent = 'Satellite';
      } else {
        catchMap.removeLayer(window._catchMapStreet);
        window._catchMapSatellite.addTo(catchMap);
        document.getElementById('mapToggle').textContent = 'Standard';
      }
      window._catchMapIsSatellite = !window._catchMapIsSatellite;
    }

    function toggleCustomSpecies() {
      const sel = document.getElementById('species').value;
      const group = document.getElementById('customSpeciesGroup');
      const keptGroup = document.getElementById('keptReleasedGroup');
      const fishTypeGroup = document.getElementById('fishTypeGroup');
      const grilseGroup = document.getElementById('grilseGroup');
      const seaTroutTypeGroup = document.getElementById('seaTroutTypeGroup');

      group.classList.toggle('hidden', sel !== 'Other');

      // Show kept/released for reportable species
      const reportable = ['Salmon', 'Sea Trout', 'Grayling', 'Brown Trout'];
      keptGroup.classList.toggle('hidden', !reportable.includes(sel));

      // Show fish type (wild/farmed) for Salmon only
      fishTypeGroup.classList.toggle('hidden', sel !== 'Salmon');

      // Show grilse toggle for Salmon
      grilseGroup.classList.toggle('hidden', sel !== 'Salmon');

      // Show adult/herling for Sea Trout
      seaTroutTypeGroup.classList.toggle('hidden', sel !== 'Sea Trout');

      // Default to Released
      if (reportable.includes(sel)) {
        setKeptReleased('Released');
      }
      if (sel === 'Salmon') {
        setGrilse(false);
      }
      if (sel === 'Sea Trout') {
        setSeaTroutType('Adult');
      }
    }

    function setKeptReleased(val) {
      document.getElementById('keptReleased').value = val;
      const btnK = document.getElementById('btnKept');
      const btnR = document.getElementById('btnReleased');
      btnR.style.background = val === 'Released' ? 'var(--teal)' : '';
      btnR.style.color = val === 'Released' ? 'var(--bg)' : '';
      btnR.style.borderColor = val === 'Released' ? 'var(--teal)' : '';
      btnK.style.background = val === 'Kept' ? 'var(--gold)' : '';
      btnK.style.color = val === 'Kept' ? 'var(--bg)' : '';
      btnK.style.borderColor = val === 'Kept' ? 'var(--gold)' : '';
    }

    function setGrilse(isGrilse) {
      document.getElementById('isGrilse').value = isGrilse;
      const btnA = document.getElementById('btnSalmonAdult');
      const btnG = document.getElementById('btnGrilse');
      btnA.style.background = !isGrilse ? 'var(--gold)' : '';
      btnA.style.color = !isGrilse ? 'var(--bg)' : '';
      btnA.style.borderColor = !isGrilse ? 'var(--gold)' : '';
      btnG.style.background = isGrilse ? 'var(--gold)' : '';
      btnG.style.color = isGrilse ? 'var(--bg)' : '';
      btnG.style.borderColor = isGrilse ? 'var(--gold)' : '';
    }

    function setSeaTroutType(type) {
      document.getElementById('seaTroutType').value = type;
      const btnA = document.getElementById('btnAdult');
      const btnH = document.getElementById('btnHerling');
      btnA.style.background = type === 'Adult' ? 'var(--teal)' : '';
      btnA.style.color = type === 'Adult' ? 'var(--bg)' : '';
      btnA.style.borderColor = type === 'Adult' ? 'var(--teal)' : '';
      btnH.style.background = type === 'Herling/Finnock' ? 'var(--teal)' : '';
      btnH.style.color = type === 'Herling/Finnock' ? 'var(--bg)' : '';
      btnH.style.borderColor = type === 'Herling/Finnock' ? 'var(--teal)' : '';
    }

    let catchTags = [];
    function addTag() {
      const input = document.getElementById('tagInput');
      const val = (input?.value || '').trim();
      if (!val || catchTags.includes(val)) { input.value = ''; return; }
      catchTags.push(val);
      input.value = '';
      renderTags();
    }
    function addQuickTag(tag) {
      if (catchTags.includes(tag)) return;
      catchTags.push(tag);
      renderTags();
    }
    function removeTag(tag) {
      catchTags = catchTags.filter(t => t !== tag);
      renderTags();
    }
    function renderTags() {
      const c = document.getElementById('tagContainer');
      if (!c) return;
      c.innerHTML = catchTags.map(t =>
        `<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(212,165,116,0.12);border-radius:20px;font-size:0.7rem;color:var(--gold);font-weight:500;">
          ${t} <span onclick="removeTag('${t.replace(/'/g,"\\'")}')" style="cursor:pointer;opacity:0.6;font-size:0.8rem;">&times;</span>
        </span>`
      ).join('');
    }

    function handlePhotoSelect(input) {
      const file = input.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        showToast('Photo must be under 5MB', 'error');
        return;
      }

      // Read as data URL for preview/upload
      const reader = new FileReader();
      reader.onload = (e) => {
        photoData = e.target.result;
        document.getElementById('photoPreview').innerHTML = `
          <img src="${photoData}" class="photo-upload-preview" alt="Catch photo">
          <p class="text-muted text-xs" style="margin-top:6px;">Tap to change photo</p>
        `;
      };
      reader.readAsDataURL(file);

      // Read as ArrayBuffer for EXIF extraction
      const exifReader = new FileReader();
      exifReader.onload = (e) => {
        const exif = extractExifData(e.target.result);
        if (!exif) return;

        const hasCoords = exif.lat && exif.lng;
        const hasDate = exif.date;
        const hasTime = exif.time;

        // Check if user already has values set
        const existingLat = document.getElementById('lat').value;
        const existingDate = document.getElementById('catchDate').value;
        const existingTime = document.getElementById('catchTime').value;
        const todayStr = new Date().toISOString().split('T')[0];
        const dateIsDefault = existingDate === todayStr;

        // Collect what we can offer
        const offers = [];
        if (hasCoords) offers.push('location');
        if (hasDate) offers.push('date');
        if (hasTime) offers.push('time');

        if (offers.length === 0) return;

        // If fields are empty/default, apply silently
        const fieldsAlreadySet = (existingLat && hasCoords) || (!dateIsDefault && hasDate) || (existingTime && hasTime);

        if (fieldsAlreadySet) {
          // Show prompt
          showExifPrompt(exif, offers);
        } else {
          // Apply silently
          applyExifData(exif);
        }
      };
      exifReader.readAsArrayBuffer(file);
    }

    function showExifPrompt(exif, offers) {
      const items = [];
      if (offers.includes('location') && exif.lat) items.push(`Location: ${exif.lat.toFixed(4)}, ${exif.lng.toFixed(4)}`);
      if (offers.includes('date') && exif.date) items.push(`Date: ${exif.date}`);
      if (offers.includes('time') && exif.time) items.push(`Time: ${exif.time}`);

      const banner = document.createElement('div');
      banner.id = 'exifBanner';
      banner.style.cssText = 'background:rgba(212,165,116,0.1);border:1px solid rgba(212,165,116,0.2);border-radius:var(--radius);padding:12px 14px;margin-top:8px;animation:fadeIn 0.3s ease;';
      banner.innerHTML = `
        <div class="text-xs" style="color:var(--gold);font-weight:600;margin-bottom:6px;">Photo metadata detected</div>
        <div class="text-xs text-muted" style="margin-bottom:8px;">${items.join(' · ')}</div>
        <div class="flex gap-2">
          <button class="btn btn-sm" onclick="applyExifData(window._pendingExif);document.getElementById('exifBanner')?.remove();" style="background:var(--gold);color:var(--bg);font-size:0.7rem;padding:6px 12px;">Apply to form</button>
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('exifBanner')?.remove();" style="font-size:0.7rem;padding:6px 12px;">Keep current values</button>
        </div>
      `;
      window._pendingExif = exif;

      // Insert after photo upload
      const existing = document.getElementById('exifBanner');
      if (existing) existing.remove();
      const photoUpload = document.getElementById('photoUpload');
      if (photoUpload) photoUpload.parentNode.insertBefore(banner, photoUpload.nextSibling);
    }

    function applyExifData(exif) {
      if (!exif) return;
      if (exif.lat && exif.lng) {
        document.getElementById('lat').value = exif.lat.toFixed(6);
        document.getElementById('lng').value = exif.lng.toFixed(6);
        document.getElementById('mapHint').textContent = `${exif.lat.toFixed(4)}, ${exif.lng.toFixed(4)} (from photo)`;
        if (catchMap) {
          if (catchMarker) catchMap.removeLayer(catchMarker);
          catchMarker = L.marker([exif.lat, exif.lng], {
            icon: L.divIcon({
              className: '',
              html: `<div style="width:24px;height:24px;background:var(--gold);border:3px solid white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.4);"></div>`,
              iconSize: [24, 24],
              iconAnchor: [12, 12],
            }),
          }).addTo(catchMap);
          catchMap.setView([exif.lat, exif.lng], 16);
        }
        fetchWeather(exif.lat, exif.lng);
      }
      if (exif.date) {
        document.getElementById('catchDate').value = exif.date;
      }
      if (exif.time) {
        document.getElementById('catchTime').value = exif.time;
      }
      showToast('Photo metadata applied');
    }

    // ─── EXIF Data Extractor (GPS + DateTime, no dependencies) ──
    function extractExifData(buffer) {
      try {
        const view = new DataView(buffer);
        if (view.getUint16(0) !== 0xFFD8) return null;

        let offset = 2;
        while (offset < view.byteLength - 1) {
          const marker = view.getUint16(offset);
          if (marker === 0xFFE1) {
            return parseExifFull(view, offset + 4);
          }
          if ((marker & 0xFF00) !== 0xFF00) break;
          const len = view.getUint16(offset + 2);
          offset += 2 + len;
        }
      } catch (e) {}
      return null;
    }

    function parseExifFull(view, start) {
      try {
        if (view.getUint32(start) !== 0x45786966 || view.getUint16(start + 4) !== 0x0000) return null;

        const tiffStart = start + 6;
        const byteOrder = view.getUint16(tiffStart);
        const le = byteOrder === 0x4949;
        const g = (o, s) => s === 2 ? view.getUint16(o, le) : view.getUint32(o, le);

        let ifdOffset = tiffStart + g(tiffStart + 4, 4);
        const ifd0Count = g(ifdOffset, 2);

        let gpsIFDOffset = null;
        let exifIFDOffset = null;
        let dateTimeOriginal = null;

        for (let i = 0; i < ifd0Count; i++) {
          const entryOffset = ifdOffset + 2 + i * 12;
          const tag = g(entryOffset, 2);
          if (tag === 0x8825) gpsIFDOffset = tiffStart + g(entryOffset + 8, 4);
          if (tag === 0x8769) exifIFDOffset = tiffStart + g(entryOffset + 8, 4);
          // 0x0132 = DateTime in IFD0
          if (tag === 0x0132 && !dateTimeOriginal) {
            const strOffset = tiffStart + g(entryOffset + 8, 4);
            dateTimeOriginal = readExifString(view, strOffset, 19);
          }
        }

        // Check ExifIFD for DateTimeOriginal (0x9003) which is more accurate
        if (exifIFDOffset) {
          try {
            const exifCount = g(exifIFDOffset, 2);
            for (let i = 0; i < exifCount; i++) {
              const entryOffset = exifIFDOffset + 2 + i * 12;
              const tag = g(entryOffset, 2);
              if (tag === 0x9003) { // DateTimeOriginal
                const strOffset = tiffStart + g(entryOffset + 8, 4);
                dateTimeOriginal = readExifString(view, strOffset, 19);
                break;
              }
            }
          } catch (e) {}
        }

        // Parse GPS
        let lat = null, lng = null;
        if (gpsIFDOffset) {
          const gpsCount = g(gpsIFDOffset, 2);
          let latRef = null, lngRef = null, latData = null, lngData = null;
          for (let i = 0; i < gpsCount; i++) {
            const entryOffset = gpsIFDOffset + 2 + i * 12;
            const tag = g(entryOffset, 2);
            const valueOffset = tiffStart + g(entryOffset + 8, 4);
            if (tag === 1) latRef = String.fromCharCode(view.getUint8(entryOffset + 8));
            else if (tag === 2) latData = readRationals(view, valueOffset, 3, le);
            else if (tag === 3) lngRef = String.fromCharCode(view.getUint8(entryOffset + 8));
            else if (tag === 4) lngData = readRationals(view, valueOffset, 3, le);
          }
          if (latData && lngData && latRef && lngRef) {
            lat = latData[0] + latData[1] / 60 + latData[2] / 3600;
            lng = lngData[0] + lngData[1] / 60 + lngData[2] / 3600;
            if (latRef === 'S') lat = -lat;
            if (lngRef === 'W') lng = -lng;
            if (lat === 0 && lng === 0) { lat = null; lng = null; }
          }
        }

        // Parse date/time from "YYYY:MM:DD HH:MM:SS"
        let date = null, time = null;
        if (dateTimeOriginal && dateTimeOriginal.length >= 19) {
          const parts = dateTimeOriginal.split(' ');
          if (parts.length >= 2) {
            date = parts[0].replace(/:/g, '-'); // "2025-03-15"
            time = parts[1].substring(0, 5);     // "14:30"
          }
        }

        if (!lat && !date) return null;
        return { lat, lng, date, time };
      } catch (e) {}
      return null;
    }

    function readExifString(view, offset, maxLen) {
      let str = '';
      for (let i = 0; i < maxLen; i++) {
        const ch = view.getUint8(offset + i);
        if (ch === 0) break;
        str += String.fromCharCode(ch);
      }
      return str;
    }

    function readRationals(view, offset, count, le) {
      const vals = [];
      for (let i = 0; i < count; i++) {
        const num = view.getUint32(offset + i * 8, le);
        const den = view.getUint32(offset + i * 8 + 4, le);
        vals.push(den === 0 ? 0 : num / den);
      }
      return vals;
    }

    function checkMissingFields() {
      const missing = [];
      if (!document.getElementById('weight').value) missing.push('weight');
      if (!document.getElementById('length').value) missing.push('length');
      if (!document.getElementById('bait').value) missing.push('bait/fly');
      if (!document.getElementById('method').value) missing.push('method');
      if (!document.getElementById('lat').value) missing.push('location');
      if (!photoData) missing.push('photo');
      if (!document.getElementById('notes').value) missing.push('notes');

      const warning = document.getElementById('missingWarning');
      const text = document.getElementById('missingText');

      if (missing.length > 0 && missing.length < 7) {
        warning.classList.remove('hidden');
        text.textContent = `Optional fields not filled: ${missing.join(', ')}. You can still submit.`;
      } else {
        warning.classList.add('hidden');
      }
      return missing;
    }

    async function submitCatch() {
      const species = document.getElementById('species').value;
      if (!species) {
        showToast('Please select a species', 'error');
        return;
      }

      checkMissingFields();

      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Submitting...';

      const weatherRaw = document.getElementById('weatherData')?.value;
      let weather = null;
      try { weather = weatherRaw ? JSON.parse(weatherRaw) : null; } catch (e) {}

      const payload = {
        memberId: state.user.id,
        memberName: state.user.name,
        species,
        customSpecies: species === 'Other' ? document.getElementById('customSpecies').value : null,
        date: document.getElementById('catchDate').value,
        time: document.getElementById('catchTime').value || null,
        weight: document.getElementById('weight').value || null,
        length: document.getElementById('length').value || null,
        bait: document.getElementById('bait').value || null,
        method: document.getElementById('method').value || null,
        lat: document.getElementById('lat').value || null,
        lng: document.getElementById('lng').value || null,
        locationName: document.getElementById('locationName').value || null,
        notes: document.getElementById('notes').value || null,
        photo: photoData || null,
        weather,
        waterTemp: document.getElementById('waterTemp').value || null,
        waterClarity: document.getElementById('waterClarity').value || null,
        fightTime: document.getElementById('fightTime').value || null,
        // NDSFB fields
        keptReleased: document.getElementById('keptReleased')?.value || null,
        fishType: document.getElementById('fishType')?.value || null,
        isGrilse: document.getElementById('isGrilse')?.value === 'true' ? true : false,
        seaTroutType: document.getElementById('seaTroutType')?.value || null,
        tags: catchTags.length > 0 ? catchTags : [],
      };

      try {
        await api('/api/catches', {
          method: 'POST',
          body: JSON.stringify(payload),
        });

        showToast('Catch logged successfully!');
        photoData = null;
        catchTags = [];
        catchMarker = null;
        catchMap = null;
        navigate('dashboard');
      } catch (err) {
        showToast('Failed to log catch: ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = 'Log This Catch';
      }
    }

    // ─── HISTORY PAGE ───────────────────────────────────────────
    function renderHistory() {
      return `
        <div class="page">
          <div class="animate-in mb-4" style="margin-top:8px;">
            <div class="section-label">Catch Log</div>
            <h1 class="heading-xl">All Catches</h1>
          </div>

          <div class="tab-bar animate-in animate-in-delay-1" id="historyFilter">
            <button class="tab-item active" data-filter="all" onclick="filterHistory('all', this)">All</button>
            <button class="tab-item" data-filter="mine" onclick="filterHistory('mine', this)">Mine</button>
            ${CONFIG.SPECIES.slice(0, 5).map(s =>
              `<button class="tab-item" data-filter="${s.value}" onclick="filterHistory('${s.value}', this)">${s.label.split(' ')[0]}</button>`
            ).join('')}
          </div>

          <div id="catchesList" class="flex flex-col gap-3 animate-in animate-in-delay-2">
            <div class="text-center" style="padding:32px;">
              <div class="spinner" style="margin:0 auto;width:24px;height:24px;color:var(--gold);"></div>
            </div>
          </div>
        </div>
      `;
    }

    let allCatches = [];
    let currentFilter = 'all';

    async function loadCatches() {
      try {
        allCatches = await api('/api/catches');
        renderCatchesList(allCatches);
      } catch (err) {
        console.error('Failed to load catches:', err);
      }
    }

    function filterHistory(filter, el) {
      currentFilter = filter;
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      el.classList.add('active');

      let filtered = allCatches;
      if (filter === 'mine') {
        filtered = allCatches.filter(c => c.memberId === state.user.id);
      } else if (filter !== 'all') {
        filtered = allCatches.filter(c => c.species === filter);
      }
      renderCatchesList(filtered);
    }

    function renderCatchesList(catches) {
      const container = document.getElementById('catchesList');
      if (!container) return;

      if (catches.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            ${icons.fish}
            <h3>No catches found</h3>
            <p>Adjust your filter or log a new catch</p>
          </div>
        `;
        return;
      }

      container.innerHTML = catches.map((c, i) => renderCatchCard(c, i)).join('');
      loadCatchThumbnails(catches);
    }

    function renderCatchCard(c, i) {
      const speciesLabel = c.species === 'Other' ? (c.customSpecies || 'Other') : c.species;
      const delay = Math.min(i * 0.05, 0.5);

      return `
        <div class="catch-card" style="animation-delay:${delay}s;" onclick="viewCatchDetail('${c.id}')">
          <div class="catch-thumb" id="cthumb-${c.id}">
            ${c.hasPhoto
              ? `<div class="spinner" style="width:14px;height:14px;color:var(--text-muted);"></div>`
              : `<div style="color:${getSpeciesColor(c.species)}">${icons.fish}</div>`
            }
          </div>
          <div class="catch-info">
            <div class="catch-species">
              <span class="species-dot ${getSpeciesDotClass(c.species)}"></span>
              ${speciesLabel}
            </div>
            <div class="catch-angler">${c.memberName}</div>
            <div class="catch-meta">
              ${c.weight ? `<span class="catch-meta-item">${c.weight}lb</span>` : ''}
              ${c.length ? `<span class="catch-meta-item">${c.length}″</span>` : ''}
              ${c.bait ? `<span class="catch-meta-item">${c.bait}</span>` : ''}
              ${c.weather ? `<span class="catch-meta-item">${c.weather.icon} ${c.weather.temperature}°C</span>` : ''}
              <span class="catch-meta-item">${icons.clock} ${formatDate(c.date)}</span>
            </div>
          </div>
        </div>
      `;
    }

    // Lazy-load thumbnails for catch cards with photos
    function loadCatchThumbnails(catches) {
      (catches || []).filter(c => c.hasPhoto).forEach(async (c) => {
        try {
          const data = await api(`/api/photo?id=${c.id}`);
          const thumb = document.getElementById(`cthumb-${c.id}`);
          if (thumb && data.photo) {
            thumb.innerHTML = `<img src="${data.photo}" alt="${c.species}">`;
          }
        } catch (e) {}
      });
    }

    function viewPhotoFullscreen(src) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;padding:16px;animation:fadeIn 0.2s ease;cursor:pointer;';
      overlay.onclick = () => overlay.remove();
      overlay.innerHTML = `
        <img src="${src}" style="max-width:100%;max-height:100%;object-fit:contain;border-radius:4px;" alt="Full size photo">
        <div style="position:absolute;top:16px;right:16px;color:white;font-size:1.5rem;opacity:0.7;">✕</div>
      `;
      document.body.appendChild(overlay);
    }

    function showSyndicateRules() {
      const rules = [
        'The season for Salmon & Sea Trout runs from 25th February until 30th November, for Brown Trout 15th March until 6th October, dates inclusive.',
        'Grayling can be fished for during the closed season, until 15th March and on Sundays.',
        'Graeme Lightbody is the Syndicate Captain and shall have final say in the event of any queries, questions, concerns and or pish.',
        'All members must always notify their intention of date and time of arrival to fish on the WhatsApp group a reasonable timescale in advance.',
        'Members may bring a guest rod to fish, by prior notice and agreement on the Barjarg Fishings WhatsApp group.',
        'Repeat guests may only be allowed to fish on no more than three occasions throughout the angling season.',
        'Syndicate, family, member guests (age 21 & under) do not count as part of the guest allocation, however, must be always accompanied by a syndicate member whilst on the river.',
        'All catches to be recorded in the catch record book.',
        'The river is currently "Grade 3" status thus all Salmon to be returned. Sea Trout over 3lb to be returned with all fish handled with the utmost care, prior to returning to the water.',
        'A daily limit to take 1 Sea Trout or 1 Brown Trout per day per angler is allowed, in line with the Nith District Salmon Fishery Board (NDSFB) Conservation Policy.',
        'When more than one angler is in attendance, agreement of who fishes and where to be mutually agreed or lots drawn and pools fished on rotation to give fair chance.',
        'Ask permission from your fellow fisherman if you would like to go into a pool in front of them if they are fishing or intending to start fishing a pool.',
        'Cast and take a minimum of one step to ensure everyone gets a chance to fish the pool out in a timely, sportingly, manner.',
        'Please be courteous with Closeburn Castle anglers. Any issues, do not engage, be courteous — take a description, pool, time and date, and report to Graeme who shall deal with Closeburn Castle & Barndennoch Syndicate Captains.',
        'Be courteous and minded about disturbance of the close neighbours.',
        'All legal methods allowed appropriate to river height.',
        'Sensible wading please, be thoughtful to pool disturbance in low water and your personal safety in high water.',
        'All anglers to always act in a safe manner.',
        'Dogs must be always kept under control.',
        'Leave all field gates in the position you find them.',
        'Report any pollution or dead fish/wildlife to Syndicate Captain, take pictures but do not touch.',
        'All litter to be taken to cabin and put in waste bin (and feel free to empty the cabin bins every now and again i.e. take home and dispose of in your household general waste bin).',
        'Cabin to be kept clean and tidy, ensure heating and water is left appropriate to the season, and all locked up after each visit.',
        'Rod store to be always kept tidy and locked.',
        'Your gear is left at your own risk.',
        'Strimming and bank maintenance is required, some pre-arranged days shall be notified to members at the start of the Summer, please make every attempt to attend and help.',
        'Ensure you familiarise yourself and adhere to the Nith District Salmon Fishery Board (NDSFB) Conservation Policy.',
        'Be mindful not to waste the pools by wading and fishing in low water during the peak of the sea trout run and potentially spooking the sea trout, potentially spoiling the night fishing for the sea trout, particularly on a Friday evening.',
        'Enjoy your fishing, tight lines & happy hunting!',
        'AGM will be held in November to discuss plans for the following season i.e. proposed new members and will be on a vote basis, with each and every current members vote being equal.',
      ];

      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);overflow-y:auto;padding:20px;animation:fadeIn 0.3s ease;';
      modal.innerHTML = `
        <div style="max-width:540px;margin:20px auto;padding-bottom:40px;">
          <div class="flex justify-between items-center mb-5">
            <div class="flex items-center gap-3">
              <img src="https://pub-2ba725f0b0e64c299f9c2af3bdcaa07e.r2.dev/Logo/barjarglogo.png" alt="" style="width:36px;height:36px;object-fit:contain;">
              <div>
                <h2 style="font-family:var(--font-heading);font-size:1.2rem;font-weight:700;color:var(--text-heading);line-height:1.2;">Syndicate Rules</h2>
                <div class="text-xs text-muted" style="margin-top:2px;">Guidelines & Etiquette — 2024</div>
              </div>
            </div>
            <button class="btn btn-ghost" onclick="this.closest('div[style*=fixed]').remove()" style="padding:8px;">${icons.x}</button>
          </div>

          <div style="display:flex;flex-direction:column;gap:0;">
            ${rules.map((text, i) => `
              <div style="display:flex;gap:14px;padding:13px 16px;background:var(--bg-card);border:1px solid var(--border);border-top:${i === 0 ? '1px' : '0'} solid var(--border);${i === 0 ? 'border-radius:var(--radius) var(--radius) 0 0;' : i === rules.length - 1 ? 'border-radius:0 0 var(--radius) var(--radius);' : ''}">
                <div style="flex-shrink:0;width:24px;height:24px;border-radius:50%;background:rgba(212,165,116,0.1);display:flex;align-items:center;justify-content:center;margin-top:1px;">
                  <span style="font-size:0.65rem;font-weight:700;color:var(--gold);font-family:var(--font-heading);">${i + 1}</span>
                </div>
                <div style="flex:1;min-width:0;">
                  <span class="text-sm" style="color:var(--text-secondary);line-height:1.65;">${text}</span>
                </div>
              </div>
            `).join('')}
          </div>

          <div style="margin-top:24px;">
            <div class="text-xs text-muted" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px;padding-left:4px;">Useful Links</div>
            <div style="display:flex;flex-direction:column;gap:0;">
              <a href="https://www.river-nith.com/conservation-policy/" target="_blank" rel="noopener" style="display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius) var(--radius) 0 0;text-decoration:none;transition:background 0.2s;">
                <div>
                  <div class="text-sm" style="color:var(--text-heading);font-weight:500;">NDSFB Conservation Policy</div>
                  <div class="text-xs text-muted" style="margin-top:2px;">river-nith.com</div>
                </div>
                <span style="color:var(--text-muted);font-size:0.8rem;">↗</span>
              </a>
              <a href="https://www.river-nith.com/" target="_blank" rel="noopener" style="display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:var(--bg-card);border:1px solid var(--border);border-top:0;text-decoration:none;transition:background 0.2s;">
                <div>
                  <div class="text-sm" style="color:var(--text-heading);font-weight:500;">Nith District Salmon Fishery Board</div>
                  <div class="text-xs text-muted" style="margin-top:2px;">river-nith.com</div>
                </div>
                <span style="color:var(--text-muted);font-size:0.8rem;">↗</span>
              </a>
              <a href="https://waterlevels.sepa.org.uk/Station/133156" target="_blank" rel="noopener" style="display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:var(--bg-card);border:1px solid var(--border);border-top:0;text-decoration:none;transition:background 0.2s;">
                <div>
                  <div class="text-sm" style="color:var(--text-heading);font-weight:500;">SEPA Water Levels — Friars Carse</div>
                  <div class="text-xs text-muted" style="margin-top:2px;">waterlevels.sepa.org.uk</div>
                </div>
                <span style="color:var(--text-muted);font-size:0.8rem;">↗</span>
              </a>
              <a href="https://www.metoffice.gov.uk/weather/forecast/gfhwk8xe0" target="_blank" rel="noopener" style="display:flex;align-items:center;justify-content:space-between;padding:13px 16px;background:var(--bg-card);border:1px solid var(--border);border-top:0;border-radius:0 0 var(--radius) var(--radius);text-decoration:none;transition:background 0.2s;">
                <div>
                  <div class="text-sm" style="color:var(--text-heading);font-weight:500;">Met Office Forecast — Thornhill</div>
                  <div class="text-xs text-muted" style="margin-top:2px;">metoffice.gov.uk</div>
                </div>
                <span style="color:var(--text-muted);font-size:0.8rem;">↗</span>
              </a>
            </div>
          </div>

          <div style="text-align:center;margin-top:20px;padding:12px;opacity:0.5;">
            <span class="text-xs text-muted">Nith at Friars Carse — Barjarg Estate</span>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    async function viewCatchDetail(catchId) {
      const c = allCatches.find(x => x.id === catchId) ||
                (state.myCatches || []).find(x => x.id === catchId) ||
                (state.stats?.recentCatches || []).find(x => x.id === catchId);
      if (!c) return;

      // Load photo if exists
      let photoHtml = '';
      if (c.hasPhoto) {
        try {
          const data = await api(`/api/photo?id=${c.id}`);
          if (data.photo) {
            photoHtml = `<img src="${data.photo}" onclick="viewPhotoFullscreen(this.src)" style="width:100%;height:auto;border-radius:var(--radius);margin-bottom:16px;cursor:pointer;" alt="Catch photo">`;
          }
        } catch (e) {}
      }

      const speciesLabel = c.species === 'Other' ? (c.customSpecies || 'Other') : c.species;

      // Show modal
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);overflow-y:auto;padding:20px;animation:fadeIn 0.3s ease;';
      modal.innerHTML = `
        <div style="max-width:500px;margin:40px auto;">
          <div class="flex justify-between items-center mb-4">
            <h2 class="heading-lg">${speciesLabel}</h2>
            <button class="btn btn-ghost" onclick="this.closest('div[style*=fixed]').remove()" style="padding:8px;">${icons.x}</button>
          </div>
          ${photoHtml}
          <div class="card mb-3">
            <div class="grid-2 gap-4" style="gap:20px;">
              <div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Angler</div>
                <div class="text-sm">${c.memberName}</div>
              </div>
              <div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Date</div>
                <div class="text-sm">${formatDate(c.date)}${c.time ? ` at ${c.time}` : ''}</div>
              </div>
              ${c.weight ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Weight</div>
                <div class="text-sm">${c.weight} lb</div>
              </div>` : ''}
              ${c.length ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Length</div>
                <div class="text-sm">${c.length}″</div>
              </div>` : ''}
              ${c.bait ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Bait / Fly</div>
                <div class="text-sm">${c.bait}</div>
              </div>` : ''}
              ${c.method ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Method</div>
                <div class="text-sm">${c.method}</div>
              </div>` : ''}
              ${c.fightTime ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Fight Time</div>
                <div class="text-sm">${c.fightTime} min</div>
              </div>` : ''}
              ${c.waterTemp ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Water Temp</div>
                <div class="text-sm">${c.waterTemp}°C</div>
              </div>` : ''}
              ${c.waterClarity ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Water Clarity</div>
                <div class="text-sm">${c.waterClarity}</div>
              </div>` : ''}
              ${c.locationName ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Location</div>
                <div class="text-sm">${c.locationName}</div>
              </div>` : ''}
              ${c.keptReleased ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Fate</div>
                <div class="text-sm"><span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:600;background:${c.keptReleased === 'Released' ? 'rgba(45,212,191,0.15);color:var(--teal)' : 'rgba(212,165,116,0.15);color:var(--gold)'};">${c.keptReleased}</span></div>
              </div>` : ''}
              ${c.fishType && c.species === 'Salmon' ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Fish Type</div>
                <div class="text-sm">${c.isGrilse ? 'Grilse' : 'Salmon'} — ${c.fishType}</div>
              </div>` : ''}
              ${c.seaTroutType && c.species === 'Sea Trout' ? `<div>
                <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">Classification</div>
                <div class="text-sm">${c.seaTroutType}</div>
              </div>` : ''}
            </div>
          </div>
          ${c.tags && c.tags.length > 0 ? `
            <div class="card mb-3">
              <div class="text-muted text-xs mb-2" style="text-transform:uppercase;letter-spacing:0.1em;">Tags</div>
              <div class="flex gap-2" style="flex-wrap:wrap;">
                ${c.tags.map(t => `<span style="padding:3px 10px;background:rgba(212,165,116,0.1);border-radius:20px;font-size:0.7rem;color:var(--gold);font-weight:500;">${t}</span>`).join('')}
              </div>
            </div>
          ` : ''}
          ${c.weather ? `
            <div class="card mb-3" style="background:linear-gradient(135deg, rgba(45,212,191,0.06), rgba(45,212,191,0.02));border-color:rgba(45,212,191,0.12);">
              <div class="text-muted text-xs mb-2" style="text-transform:uppercase;letter-spacing:0.1em;">Weather Conditions</div>
              <div class="flex items-center gap-3">
                <div style="font-size:1.8rem;">${c.weather.icon || '🌡️'}</div>
                <div>
                  <div style="font-weight:600;">${c.weather.temperature}°C — ${c.weather.description}</div>
                  <div class="text-muted text-xs" style="margin-top:2px;">Wind: ${c.weather.windSpeed} mph · Humidity: ${c.weather.humidity}% · Pressure: ${c.weather.pressure} hPa</div>
                </div>
              </div>
            </div>
          ` : ''}
          ${c.notes ? `<div class="card mb-3"><div class="text-muted text-xs mb-2" style="text-transform:uppercase;letter-spacing:0.1em;">Notes</div><p class="text-sm">${c.notes}</p></div>` : ''}
          ${c.lat && c.lng ? `
            <div class="card mb-3" style="padding:0;overflow:hidden;position:relative;">
              <div id="detailMap" style="height:300px;width:100%;"></div>
              ${c.locationName ? `<div style="padding:10px 14px;border-top:1px solid var(--border);">
                <div class="flex items-center gap-2">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                  <span class="text-sm" style="font-weight:500;">${c.locationName}</span>
                </div>
              </div>` : ''}
            </div>
          ` : ''}
          <div class="card mb-3" id="detailRiverLevel" style="display:none;">
            <div class="flex items-center gap-2 mb-2">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="2"><path d="M2 12c2-3 4-3 6 0s4 3 6 0 4-3 6 0"/><path d="M2 18c2-3 4-3 6 0s4 3 6 0 4-3 6 0"/></svg>
              <div class="text-muted text-xs" style="text-transform:uppercase;letter-spacing:0.1em;">River Level on ${formatDate(c.date)}</div>
            </div>
            <div id="detailRiverContent">
              <div class="flex items-center gap-2">
                <div class="spinner" style="width:14px;height:14px;color:var(--teal);"></div>
                <span class="text-xs text-muted">Loading river data...</span>
              </div>
            </div>
          </div>
          ${c.memberId === state.user?.id ? `
            <button class="btn btn-block" id="deleteCatchBtn" onclick="confirmDeleteCatch('${c.id}')"
              style="background:rgba(248,113,113,0.1);color:var(--salmon);border:1px solid rgba(248,113,113,0.2);margin-top:12px;">
              Delete This Catch
            </button>
          ` : ''}
        </div>
      `;
      document.body.appendChild(modal);

      // Init detail map
      if (c.lat && c.lng) {
        setTimeout(() => {
          const dm = L.map('detailMap', { center: [c.lat, c.lng], zoom: 16, zoomControl: true, attributionControl: false });
          const detStreet = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
          const detSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
          detStreet.addTo(dm);
          let isSat = false;

          // Satellite toggle
          const tgl = document.createElement('div');
          tgl.style.cssText = 'position:absolute;top:10px;right:10px;z-index:1000;';
          tgl.innerHTML = `<button id="detMapToggle" style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 10px;font-size:0.7rem;color:var(--text-secondary);cursor:pointer;font-family:var(--font-body);backdrop-filter:blur(8px);">Satellite</button>`;
          document.getElementById('detailMap').parentElement.appendChild(tgl);
          document.getElementById('detMapToggle').onclick = () => {
            if (isSat) { dm.removeLayer(detSatellite); detStreet.addTo(dm); document.getElementById('detMapToggle').textContent = 'Satellite'; }
            else { dm.removeLayer(detStreet); detSatellite.addTo(dm); document.getElementById('detMapToggle').textContent = 'Standard'; }
            isSat = !isSat;
          };

          L.marker([c.lat, c.lng], {
            icon: L.divIcon({
              className: '',
              html: `<div style="width:24px;height:24px;background:${getSpeciesColor(c.species)};border:3px solid white;border-radius:50%;box-shadow:0 2px 12px rgba(0,0,0,0.5);"></div>`,
              iconSize: [24, 24],
              iconAnchor: [12, 12],
            }),
          }).addTo(dm);
          setTimeout(() => dm.invalidateSize(), 100);
        }, 200);
      }

      // Fetch river level for this catch date
      loadDetailRiverLevel(c.date, c.time);

      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // ─── DETAIL RIVER LEVEL ───────────────────────────────────
    async function loadDetailRiverLevel(dateStr, timeStr) {
      const card = document.getElementById('detailRiverLevel');
      const container = document.getElementById('detailRiverContent');
      if (!card || !container) return;

      try {
        // Query the full day of the catch
        const from = `${dateStr}T00:00:00`;
        const nextDay = new Date(new Date(dateStr + 'T00:00:00').getTime() + 86400000).toISOString().split('T')[0];
        const to = `${nextDay}T00:00:00`;

        const data = await api(`/api/water-level?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);

        if (!data || data.error || !data.readings || data.readings.length === 0) {
          container.innerHTML = `<p class="text-xs text-muted">No river data available for this date</p>`;
          card.style.display = 'block';
          return;
        }

        // Find the reading closest to the catch time
        let closestReading = null;
        if (timeStr && data.readings.length > 0) {
          const catchHour = parseInt(timeStr.split(':')[0]);
          const catchMin = parseInt(timeStr.split(':')[1] || '0');
          const catchMins = catchHour * 60 + catchMin;
          let minDiff = Infinity;
          data.readings.forEach(r => {
            try {
              const rTime = new Date(r.timestamp);
              const rMins = rTime.getHours() * 60 + rTime.getMinutes();
              const diff = Math.abs(rMins - catchMins);
              if (diff < minDiff) { minDiff = diff; closestReading = r; }
            } catch (e) {}
          });
        }

        const atCatch = closestReading ? closestReading.value.toFixed(2) : null;
        const trendIcon = data.trend === 'rising' ? '↑' : data.trend === 'falling' ? '↓' : '→';
        const trendColor = data.trend === 'rising' ? 'var(--teal)' : data.trend === 'falling' ? 'var(--salmon)' : 'var(--text-secondary)';

        // Build compact sparkline
        const chartHtml = buildDetailWaterChart(data.readings, closestReading);

        container.innerHTML = `
          <div class="flex items-center gap-4 mb-2">
            <div>
              <div style="font-family:var(--font-heading);font-size:1.5rem;font-weight:700;color:var(--teal);line-height:1;">
                ${atCatch || data.avg?.toFixed(2) || '—'}<span style="font-size:0.8rem;font-weight:400;color:var(--text-muted);"> ${data.unit}</span>
              </div>
              <div class="text-xs mt-1" style="color:var(--text-muted);">
                ${atCatch ? 'at time of catch' : 'daily average'}
                <span style="color:${trendColor};font-weight:600;margin-left:6px;">${trendIcon} ${data.trend}</span>
              </div>
            </div>
            <div style="margin-left:auto;text-align:right;">
              <div class="text-xs text-muted">High: <span style="color:var(--text-secondary);">${data.max?.toFixed(2)}${data.unit}</span></div>
              <div class="text-xs text-muted">Low: <span style="color:var(--text-secondary);">${data.min?.toFixed(2)}${data.unit}</span></div>
            </div>
          </div>
          ${chartHtml}
        `;
        card.style.display = 'block';
      } catch (err) {
        console.error('Detail river level failed:', err);
        container.innerHTML = `<p class="text-xs text-muted">Could not load river data</p>`;
        card.style.display = 'block';
      }
    }

    function buildDetailWaterChart(readings, highlight) {
      if (!readings || readings.length < 2) return '';

      const width = 320;
      const height = 60;
      const padding = { top: 6, bottom: 14, left: 0, right: 0 };
      const values = readings.map(r => r.value);
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = max - min || 0.1;
      const chartW = width - padding.left - padding.right;
      const chartH = height - padding.top - padding.bottom;

      const points = values.map((v, i) => {
        const x = padding.left + (i / (values.length - 1)) * chartW;
        const y = padding.top + chartH - ((v - min) / range) * chartH;
        return `${x.toFixed(1)},${y.toFixed(1)}`;
      }).join(' ');

      const areaPoints = points +
        ` ${(padding.left + chartW).toFixed(1)},${(padding.top + chartH).toFixed(1)}` +
        ` ${padding.left.toFixed(1)},${(padding.top + chartH).toFixed(1)}`;

      // Highlight dot for catch time
      let highlightDot = '';
      if (highlight) {
        const idx = readings.findIndex(r => r.timestamp === highlight.timestamp);
        if (idx >= 0) {
          const hx = padding.left + (idx / (values.length - 1)) * chartW;
          const hy = padding.top + chartH - ((highlight.value - min) / range) * chartH;
          highlightDot = `<circle cx="${hx.toFixed(1)}" cy="${hy.toFixed(1)}" r="4" fill="var(--gold)" stroke="white" stroke-width="2"/>`;
        }
      }

      // Time labels
      const firstTime = new Date(readings[0].timestamp);
      const lastTime = new Date(readings[readings.length - 1].timestamp);
      const fmtTime = d => d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');

      return `
        <svg viewBox="0 0 ${width} ${height}" style="width:100%;height:60px;display:block;" preserveAspectRatio="none">
          <defs>
            <linearGradient id="detailWaterGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="rgba(45,212,191,0.25)"/>
              <stop offset="100%" stop-color="rgba(45,212,191,0.02)"/>
            </linearGradient>
          </defs>
          <polygon points="${areaPoints}" fill="url(#detailWaterGrad)"/>
          <polyline points="${points}" fill="none" stroke="rgba(45,212,191,0.6)" stroke-width="1.5" stroke-linejoin="round"/>
          ${highlightDot}
          <text x="${padding.left + 2}" y="${height - 2}" fill="var(--text-muted)" font-size="9" font-family="var(--font-body)">${fmtTime(firstTime)}</text>
          <text x="${padding.left + chartW - 2}" y="${height - 2}" fill="var(--text-muted)" font-size="9" font-family="var(--font-body)" text-anchor="end">${fmtTime(lastTime)}</text>
        </svg>
      `;
    }

    // ─── DELETE CATCH ──────────────────────────────────────────
    function confirmDeleteCatch(catchId) {
      const btn = document.getElementById('deleteCatchBtn');
      if (btn.dataset.confirmed === 'true') {
        deleteCatch(catchId);
        return;
      }
      btn.dataset.confirmed = 'true';
      btn.textContent = 'Tap again to confirm delete';
      btn.style.background = 'rgba(248,113,113,0.25)';
      // Reset after 3 seconds if not confirmed
      setTimeout(() => {
        if (btn) {
          btn.dataset.confirmed = '';
          btn.textContent = 'Delete This Catch';
          btn.style.background = 'rgba(248,113,113,0.1)';
        }
      }, 3000);
    }

    async function deleteCatch(catchId) {
      const btn = document.getElementById('deleteCatchBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;"></div> Deleting...';
      try {
        await api('/api/catches/delete', {
          method: 'POST',
          body: JSON.stringify({ catchId }),
        });
        // Remove from local arrays
        allCatches = allCatches.filter(c => c.id !== catchId);
        // Close modal
        const modal = btn.closest('div[style*=fixed]');
        if (modal) modal.remove();
        showToast('Catch deleted');
        // Refresh current page
        if (state.currentPage === 'history') renderCatchesList(allCatches);
        if (state.currentPage === 'dashboard') loadDashboardData();
        if (state.currentPage === 'gallery') loadGallery();
      } catch (err) {
        showToast('Failed to delete: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Delete This Catch';
      }
    }

    // ─── STATS PAGE ─────────────────────────────────────────────
    function renderStats() {
      return `
        <div class="page">
          <div class="animate-in mb-4" style="margin-top:8px;">
            <div class="section-label">Analytics</div>
            <h1 class="heading-xl">Statistics</h1>
          </div>
          <div class="flex justify-end gap-2 mb-4 animate-in" style="flex-wrap:wrap;">
            <button class="btn btn-secondary btn-sm" onclick="exportNDSFB()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              NDSFB Return
            </button>
            <button class="btn btn-secondary btn-sm" onclick="exportCSV()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export CSV
            </button>
          </div>
          <div id="statsContent">
            <div class="text-center" style="padding:48px;">
              <div class="spinner" style="margin:0 auto;width:28px;height:28px;color:var(--gold);"></div>
              <p class="text-muted text-sm" style="margin-top:12px;">Crunching the numbers...</p>
            </div>
          </div>
          <div id="fullLeagueTable" style="margin-top:24px;"></div>
        </div>
      `;
    }

    async function loadStats() {
      hotspotsMapInit = false;
      try {
        const stats = await api('/api/stats');
        setState({ stats });
        renderStatsContent(stats);
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
      try { loadFullLeagueTable(); } catch (e) {}
    }

    async function loadFullLeagueTable() {
      try {
        const league = await api('/api/league');
        const container = document.getElementById('fullLeagueTable');
        if (!container || league.length === 0) return;
        container.innerHTML = `
          <div class="section-label mb-3 flex items-center gap-2">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            Season League Table
          </div>
          <div class="card" style="padding:0;overflow:hidden;">
            ${league.map((m, i) => {
              const isMe = m.id === state.user?.id;
              const medal = i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : '';
              return `<div style="padding:12px 14px;border-bottom:${i < league.length - 1 ? '1px solid var(--border)' : 'none'};${isMe ? 'background:rgba(212,165,116,0.05);' : ''}">
                <div class="flex items-center gap-3">
                  <div style="width:24px;text-align:center;font-size:${medal ? '1.1rem' : '0.8rem'};color:var(--text-muted);font-weight:700;">${medal || (i + 1)}</div>
                  <div style="flex:1;min-width:0;">
                    <div class="text-sm" style="font-weight:${isMe ? '700' : '500'};${isMe ? 'color:var(--gold);' : ''}">${m.name}</div>
                    <div class="text-xs text-muted" style="margin-top:2px;">${m.species.join(', ') || 'No catches yet'}</div>
                  </div>
                  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;">
                    <div><div class="text-sm" style="font-weight:600;">${m.totalCatches}</div><div class="text-xs text-muted">fish</div></div>
                    <div><div class="text-sm">${m.biggestFish > 0 ? m.biggestFish + 'lb' : '-'}</div><div class="text-xs text-muted">best</div></div>
                    <div><div class="text-sm">${m.catchRate}</div><div class="text-xs text-muted">per day</div></div>
                  </div>
                </div>
              </div>`;
            }).join('')}
          </div>
        `;
      } catch (e) { console.error('Full league error:', e); }
    }

    // Expandable card helper
    function statCard(id, icon, title, summary, detail, delay = 0) {
      return `
        <div class="card mb-4 animate-in" style="animation-delay:${delay}s;cursor:pointer;transition:border-color 0.2s;" onclick="toggleStatCard('${id}')" id="sc-${id}">
          <div class="flex justify-between items-center">
            <div class="section-label" style="margin-bottom:0;">${icon} ${title}</div>
            <div id="sc-arrow-${id}" style="color:var(--text-muted);transition:transform 0.3s;font-size:1.2rem;">▸</div>
          </div>
          <div class="mt-3">${summary}</div>
          <div id="sc-detail-${id}" style="max-height:0;overflow:hidden;transition:max-height 0.4s ease;"></div>
        </div>
      `;
    }

    function toggleStatCard(id) {
      const detail = document.getElementById('sc-detail-' + id);
      const arrow = document.getElementById('sc-arrow-' + id);
      const card = document.getElementById('sc-' + id);
      if (!detail) return;
      const isOpen = detail.style.maxHeight && detail.style.maxHeight !== '0px';
      if (isOpen) {
        detail.style.maxHeight = '0px';
        arrow.style.transform = 'rotate(0deg)';
        card.style.borderColor = 'var(--border)';
      } else {
        detail.style.maxHeight = detail.scrollHeight + 200 + 'px';
        arrow.style.transform = 'rotate(90deg)';
        card.style.borderColor = 'rgba(212,165,116,0.3)';
        // Lazy-load map if needed
        if (id === 'locations') setTimeout(() => initHotspotsMap(), 200);
      }
    }

    function barChart(entries, maxVal, color = 'var(--gold)') {
      return entries.map(([label, count]) => `
        <div class="bar-row">
          <div class="bar-label">${label}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width:${(count / maxVal) * 100}%;background:${color};">${count}</div>
          </div>
        </div>
      `).join('');
    }

    function renderStatsContent(s) {
      const container = document.getElementById('statsContent');
      if (!container) return;

      const o = s.overview || {};
      const r = s.records || {};
      const t = s.timeAnalysis || {};
      const co = s.conditions || {};
      const bm = s.baitsAndMethods || {};
      const lo = s.locations || {};
      const ms = s.memberStats || [];
      const ft = co.fightTime || {};

      if ((o.totalCatches || 0) === 0 && (o.uniqueVisitDays || 0) === 0) {
        container.innerHTML = `
          <div class="empty-state">
            ${icons.chart}
            <h3>No data yet</h3>
            <p>Start logging catches and visits to see your syndicate stats</p>
          </div>
        `;
        return;
      }

      // ── 1. OVERVIEW CARD ──
      const overviewSummary = `
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;">
          <div>
            <div style="font-family:var(--font-heading);font-size:1.8rem;font-weight:700;color:var(--gold);">${o.totalCatches || 0}</div>
            <div class="text-xs text-muted">Catches</div>
          </div>
          <div>
            <div style="font-family:var(--font-heading);font-size:1.8rem;font-weight:700;color:var(--teal);">${o.uniqueVisitDays || 0}</div>
            <div class="text-xs text-muted">Visit Days</div>
          </div>
          <div>
            <div style="font-family:var(--font-heading);font-size:1.8rem;font-weight:700;color:${(o.successRate||0) >= 50 ? 'var(--teal)' : 'var(--salmon)'};">${o.successRate || 0}%</div>
            <div class="text-xs text-muted">Success</div>
          </div>
        </div>
      `;
      const overviewDetail = `
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="text-sm"><span class="text-muted">Successful days:</span> <strong style="color:var(--teal);">${o.successfulDays || 0}</strong></div>
            <div class="text-sm"><span class="text-muted">Blank days:</span> <strong style="color:var(--salmon);">${o.blankDays || 0}</strong></div>
            <div class="text-sm"><span class="text-muted">Avg per trip:</span> <strong>${o.catchesPerVisitDay || 0}</strong></div>
            <div class="text-sm"><span class="text-muted">Species caught:</span> <strong>${o.speciesCount || 0}</strong></div>
            <div class="text-sm"><span class="text-muted">Photos taken:</span> <strong>${o.photoCatches || 0}</strong></div>
            <div class="text-sm"><span class="text-muted">Total weight:</span> <strong>${o.totalWeight || 0}lb</strong></div>
            <div class="text-sm"><span class="text-muted">Avg weight:</span> <strong>${o.avgWeight || '—'}lb</strong></div>
            <div class="text-sm"><span class="text-muted">Median weight:</span> <strong>${o.medianWeight || '—'}lb</strong></div>
          </div>
          <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:12px;background:rgba(212,165,116,0.06);border-radius:var(--radius-sm);border:1px solid rgba(212,165,116,0.12);">
            <div>
              <div class="text-xs text-muted" style="text-transform:uppercase;letter-spacing:0.08em;">This Month</div>
              <div class="text-sm mt-1"><strong>${o.catchesThisMonth || 0}</strong> catches · <strong>${o.visitsThisMonth || 0}</strong> visits</div>
            </div>
            <div>
              <div class="text-xs text-muted" style="text-transform:uppercase;letter-spacing:0.08em;">Last Month</div>
              <div class="text-sm mt-1"><strong>${o.catchesLastMonth || 0}</strong> catches · <strong>${o.visitsLastMonth || 0}</strong> visits</div>
            </div>
          </div>
          ${r.bestDay ? `
            <div style="margin-top:12px;padding:12px;background:rgba(45,212,191,0.06);border-radius:var(--radius-sm);border:1px solid rgba(45,212,191,0.12);">
              <div class="text-xs text-muted" style="text-transform:uppercase;letter-spacing:0.08em;">Best Day</div>
              <div class="text-sm mt-1"><strong>${r.bestDay.count} catches</strong> on ${formatDate(r.bestDay.date)}</div>
            </div>
          ` : ''}
          ${r.worstProductiveDay && r.worstProductiveDay !== r.bestDay ? `
            <div style="margin-top:8px;padding:12px;background:rgba(248,113,113,0.06);border-radius:var(--radius-sm);border:1px solid rgba(248,113,113,0.12);">
              <div class="text-xs text-muted" style="text-transform:uppercase;letter-spacing:0.08em;">Worst Fishing Day</div>
              <div class="text-sm mt-1"><strong>${r.worstProductiveDay.count} catch${r.worstProductiveDay.count !== 1 ? 'es' : ''}</strong> on ${formatDate(r.worstProductiveDay.date)}</div>
            </div>
          ` : ''}
        </div>
      `;

      // ── 2. RECORDS CARD ──
      const recordsSummary = `
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;">
          ${r.biggestFish ? `<div>
            <div style="font-family:var(--font-heading);font-size:1.4rem;font-weight:700;color:var(--gold);">${r.biggestFish.weight}lb</div>
            <div class="text-xs text-muted">Heaviest</div>
          </div>` : '<div></div>'}
          ${r.longestFish ? `<div>
            <div style="font-family:var(--font-heading);font-size:1.4rem;font-weight:700;color:var(--teal);">${r.longestFish.length}″</div>
            <div class="text-xs text-muted">Longest</div>
          </div>` : '<div></div>'}
          ${ft.longest ? `<div>
            <div style="font-family:var(--font-heading);font-size:1.4rem;font-weight:700;color:var(--salmon);">${ft.longest.time}m</div>
            <div class="text-xs text-muted">Longest Fight</div>
          </div>` : '<div></div>'}
        </div>
      `;
      const speciesRecordHtml = Object.entries(r.speciesRecords || {}).map(([species, pb]) => `
        <div style="padding:10px 0;border-bottom:1px solid var(--border);">
          <div class="flex justify-between items-center">
            <span class="text-sm" style="font-weight:500;color:${getSpeciesColor(species)}">${species}</span>
            <span class="text-xs text-muted">${pb.count} caught</span>
          </div>
          <div class="flex gap-4 text-xs text-muted mt-1">
            ${pb.heaviest ? `<span>Best: ${pb.heaviest.weight}lb (${pb.heaviest.memberName})</span>` : ''}
            ${pb.avgWeight ? `<span>Avg: ${pb.avgWeight}lb</span>` : ''}
          </div>
        </div>
      `).join('');
      const recordsDetail = `
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
          ${r.biggestFish ? `<div class="text-sm mb-2">Heaviest: <strong>${r.biggestFish.weight}lb ${r.biggestFish.species}</strong> by ${r.biggestFish.memberName} (${formatDate(r.biggestFish.date)})</div>` : ''}
          ${r.longestFish ? `<div class="text-sm mb-2">Longest: <strong>${r.longestFish.length}″ ${r.longestFish.species}</strong> by ${r.longestFish.memberName}</div>` : ''}
          ${ft.longest ? `<div class="text-sm mb-2">Longest fight: <strong>${ft.longest.time} min ${ft.longest.species}</strong> by ${ft.longest.memberName}</div>` : ''}
          <div class="text-sm mb-2">Total weight landed: <strong>${o.totalWeight || 0}lb</strong></div>
          <div class="text-sm mb-4">Average weight: <strong>${o.avgWeight || '—'}lb</strong> · Avg length: <strong>${o.avgLength || '—'}″</strong> · Avg fight: <strong>${ft.avg || '—'}min</strong></div>
          ${r.mostSpeciesDay ? `<div class="text-sm mb-4" style="padding:10px;background:rgba(212,165,116,0.06);border-radius:var(--radius-sm);">Most species in one day: <strong>${r.mostSpeciesDay.count}</strong> (${r.mostSpeciesDay.species.join(', ')}) on ${formatDate(r.mostSpeciesDay.date)}</div>` : ''}
          ${speciesRecordHtml ? `<div class="section-label mb-2" style="font-size:0.7rem;">Species Records</div>${speciesRecordHtml}` : ''}
        </div>
      `;

      // ── 3. LEADERBOARD CARD ──
      const topAnglers = ms.filter(m => m.totalCatches > 0).slice(0, 10);
      const leaderSummary = topAnglers.slice(0, 3).map((a, i) => {
        const medals = ['🥇', '🥈', '🥉'];
        return `<div class="flex justify-between items-center" style="padding:6px 0;"><span class="text-sm">${medals[i]} ${a.name}</span><span class="text-sm" style="font-weight:600;">${a.totalCatches}</span></div>`;
      }).join('') || '<p class="text-sm text-muted">No catches yet</p>';
      const leaderDetail = `
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
          ${topAnglers.slice(3).map((a, i) => `
            <div class="flex justify-between items-center" style="padding:6px 0;border-bottom:1px solid var(--border);">
              <span class="text-sm text-muted">#${i + 4} ${a.name}</span>
              <span class="text-sm">${a.totalCatches}</span>
            </div>
          `).join('')}
          <div class="section-label mt-4 mb-2" style="font-size:0.7rem;">By Success Rate</div>
          ${ms.filter(m => m.totalVisits > 0).sort((a, b) => b.successRate - a.successRate).slice(0, 5).map(m => `
            <div class="flex justify-between items-center text-sm" style="padding:4px 0;">
              <span>${m.name}</span>
              <span style="color:${m.successRate >= 50 ? 'var(--teal)' : 'var(--salmon)'};">${m.successRate}%</span>
            </div>
          `).join('')}
          <div class="section-label mt-4 mb-2" style="font-size:0.7rem;">By Avg Catches/Trip</div>
          ${ms.filter(m => m.totalVisits > 0).sort((a, b) => b.avgCatchesPerVisit - a.avgCatchesPerVisit).slice(0, 5).map(m => `
            <div class="flex justify-between items-center text-sm" style="padding:4px 0;">
              <span>${m.name}</span>
              <span style="font-weight:600;">${m.avgCatchesPerVisit}</span>
            </div>
          `).join('')}
          <div class="section-label mt-4 mb-2" style="font-size:0.7rem;">By Biggest Fish</div>
          ${ms.filter(m => m.biggestFish).sort((a, b) => parseFloat(b.biggestFish.weight||0) - parseFloat(a.biggestFish.weight||0)).slice(0, 5).map(m => `
            <div class="flex justify-between items-center text-sm" style="padding:4px 0;">
              <span>${m.name}</span>
              <span style="color:var(--gold);">${m.biggestFish.weight}lb ${m.biggestFish.species}</span>
            </div>
          `).join('')}
          <div class="section-label mt-4 mb-2" style="font-size:0.7rem;">Current Streaks (consecutive successful visits)</div>
          ${ms.filter(m => m.currentStreak > 0).sort((a, b) => b.currentStreak - a.currentStreak).map(m => `
            <div class="flex justify-between items-center text-sm" style="padding:4px 0;">
              <span>${m.name}</span>
              <span style="color:var(--teal);">🔥 ${m.currentStreak} visit${m.currentStreak !== 1 ? 's' : ''}</span>
            </div>
          `).join('') || '<p class="text-xs text-muted">No active streaks</p>'}
        </div>
      `;

      // ── 4. TIME ANALYSIS CARD ──
      const timeSummary = `
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;">
          <div>
            <div class="text-sm" style="font-weight:700;color:var(--gold);">${t.bestHour ? t.bestHour.hour + ':00' : '—'}</div>
            <div class="text-xs text-muted">Best Hour</div>
          </div>
          <div>
            <div class="text-sm" style="font-weight:700;color:var(--teal);">${t.bestDayOfWeek ? t.bestDayOfWeek.day : '—'}</div>
            <div class="text-xs text-muted">Best Day</div>
          </div>
          <div>
            <div class="text-sm" style="font-weight:700;color:var(--salmon);">${t.bestCalendarMonth ? t.bestCalendarMonth.month : '—'}</div>
            <div class="text-xs text-muted">Best Month</div>
          </div>
        </div>
      `;
      const hourEntries = Object.entries(t.byHour || {}).sort((a, b) => parseInt(a[0]) - parseInt(b[0])).map(([h, c]) => [h + ':00', c]);
      const dowEntries = Object.entries(t.byDayOfWeek || {}).sort((a, b) => b[1] - a[1]);
      const calMonthEntries = Object.entries(t.byCalendarMonth || {}).filter(e => e[1] > 0);
      const trendEntries = Object.entries(t.byMonth || {}).sort((a, b) => a[0].localeCompare(b[0])).slice(-12).map(([m, c]) => {
        try { return [new Date(m + '-01').toLocaleDateString('en-GB', { month: 'short', year: '2-digit' }), c]; } catch { return [m, c]; }
      });
      const timeDetail = `
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
          ${hourEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Catches by Hour</div><div class="bar-chart mb-4">${barChart(hourEntries, Math.max(...hourEntries.map(e => e[1])), 'var(--gold)')}</div>` : ''}
          ${dowEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Catches by Day of Week</div><div class="bar-chart mb-4">${barChart(dowEntries, Math.max(...dowEntries.map(e => e[1])), 'var(--teal)')}</div>` : ''}
          ${calMonthEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Catches by Month (All Time)</div><div class="bar-chart mb-4">${barChart(calMonthEntries, Math.max(...calMonthEntries.map(e => e[1])), 'var(--salmon)')}</div>` : ''}
          ${trendEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Monthly Trend</div><div class="bar-chart">${barChart(trendEntries, Math.max(...trendEntries.map(e => e[1])), 'var(--gold)')}</div>` : ''}
        </div>
      `;

      // ── 5. CONDITIONS CARD ──
      const topWeather = Object.entries(co.byWeatherType || {}).sort((a, b) => b[1] - a[1])[0];
      const topClarity = Object.entries(co.byClarity || {}).sort((a, b) => b[1] - a[1])[0];
      const condSummary = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div class="text-sm"><span class="text-muted">Best weather:</span> <strong>${topWeather ? topWeather[0] : '—'}</strong></div>
          <div class="text-sm"><span class="text-muted">Best clarity:</span> <strong>${topClarity ? topClarity[0] : '—'}</strong></div>
          ${co.avgWaterTemp ? `<div class="text-sm"><span class="text-muted">Avg water temp:</span> <strong>${co.avgWaterTemp}°C</strong></div>` : ''}
          ${ft.avg ? `<div class="text-sm"><span class="text-muted">Avg fight time:</span> <strong>${ft.avg} min</strong></div>` : ''}
        </div>
      `;
      const weatherEntries = Object.entries(co.byWeatherType || {}).sort((a, b) => b[1] - a[1]);
      const airTempEntries = Object.entries(co.tempRanges || {}).filter(e => e[1] > 0);
      const windEntries = Object.entries(co.windRanges || {}).filter(e => e[1] > 0);
      const clarityEntries = Object.entries(co.byClarity || {}).sort((a, b) => b[1] - a[1]);
      const waterTempEntries = Object.entries(co.waterTempRanges || {}).filter(e => e[1] > 0);
      const fightBySpeciesEntries = Object.entries(ft.bySpecies || {}).sort((a, b) => b[1] - a[1]);
      const condDetail = `
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
          ${weatherEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Weather Conditions</div><div class="bar-chart mb-4">${barChart(weatherEntries.slice(0, 8), Math.max(...weatherEntries.map(e => e[1])), 'var(--teal)')}</div>` : ''}
          ${airTempEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Air Temperature</div><div class="bar-chart mb-4">${barChart(airTempEntries, Math.max(...airTempEntries.map(e => e[1])), 'var(--gold)')}</div>` : ''}
          ${windEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Wind Speed (mph)</div><div class="bar-chart mb-4">${barChart(windEntries, Math.max(...windEntries.map(e => e[1])), 'var(--text-secondary)')}</div>` : ''}
          ${clarityEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Water Clarity</div><div class="bar-chart mb-4">${barChart(clarityEntries, Math.max(...clarityEntries.map(e => e[1])), 'var(--teal)')}</div>` : ''}
          ${waterTempEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Water Temperature</div><div class="bar-chart mb-4">${barChart(waterTempEntries, Math.max(...waterTempEntries.map(e => e[1])), 'rgba(45,212,191,0.7)')}</div>` : ''}
          ${fightBySpeciesEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Avg Fight Time by Species (min)</div>${fightBySpeciesEntries.map(([sp, t]) => `<div class="flex justify-between text-sm" style="padding:4px 0;"><span style="color:${getSpeciesColor(sp)}">${sp}</span><span>${t} min</span></div>`).join('')}` : ''}
          ${weatherEntries.length === 0 && clarityEntries.length === 0 ? '<p class="text-sm text-muted">No conditions data yet. Log catches with weather and water conditions to see analysis.</p>' : ''}
        </div>
      `;

      // ── 6. BAIT & METHOD CARD ──
      const topBait = Object.entries(bm.baitStats || {}).sort((a, b) => b[1].count - a[1].count)[0];
      const topMethod = Object.entries(bm.methodStats || {}).sort((a, b) => b[1].count - a[1].count)[0];
      const baitSummary = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div class="text-sm"><span class="text-muted">Top bait:</span> <strong>${topBait ? topBait[0] : '—'}</strong></div>
          <div class="text-sm"><span class="text-muted">Top method:</span> <strong>${topMethod ? topMethod[0] : '—'}</strong></div>
        </div>
      `;
      const baitEntries = Object.entries(bm.baitStats || {}).sort((a, b) => b[1].count - a[1].count).slice(0, 10).map(([name, info]) => [name, info.count]);
      const methodEntries = Object.entries(bm.methodStats || {}).sort((a, b) => b[1].count - a[1].count).map(([name, info]) => [name, info.count]);
      const bestBaitHtml = Object.entries(bm.baitBySpecies || {}).map(([sp, baits]) => {
        const top = Object.entries(baits).sort((a, b) => b[1] - a[1])[0];
        return top ? `<div class="text-sm" style="padding:4px 0;"><span style="color:${getSpeciesColor(sp)}">${sp}</span>: <strong>${top[0]}</strong> <span class="text-muted">(${top[1]})</span></div>` : '';
      }).join('');
      // Show bait avg weight where available
      const baitWeightHtml = Object.entries(bm.baitStats || {}).filter(([_, info]) => info.avgWeight).sort((a, b) => b[1].avgWeight - a[1].avgWeight).slice(0, 5).map(([name, info]) => `
        <div class="flex justify-between text-sm" style="padding:4px 0;"><span>${name}</span><span style="font-weight:600;">${info.avgWeight}lb avg</span></div>
      `).join('');
      const baitDetail = `
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
          ${baitEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">All Baits/Flies</div><div class="bar-chart mb-4">${barChart(baitEntries, Math.max(...baitEntries.map(e => e[1])), 'var(--teal)')}</div>` : ''}
          ${methodEntries.length > 0 ? `<div class="section-label mb-2" style="font-size:0.7rem;">Methods</div><div class="bar-chart mb-4">${barChart(methodEntries, Math.max(...methodEntries.map(e => e[1])), 'var(--gold)')}</div>` : ''}
          ${bestBaitHtml ? `<div class="section-label mb-2" style="font-size:0.7rem;">Best Bait per Species</div>${bestBaitHtml}` : ''}
          ${baitWeightHtml ? `<div class="section-label mt-3 mb-2" style="font-size:0.7rem;">Heaviest Average by Bait</div>${baitWeightHtml}` : ''}
        </div>
      `;

      // ── 7. SPECIES BREAKDOWN CARD ──
      const speciesEntries = Object.entries(o.speciesBreakdown || {}).sort((a, b) => b[1] - a[1]);
      const maxSp = speciesEntries.length > 0 ? speciesEntries[0][1] : 1;
      const speciesSummary = speciesEntries.slice(0, 4).map(([sp, ct]) => `
        <div class="flex justify-between items-center" style="padding:4px 0;">
          <span class="text-sm" style="color:${getSpeciesColor(sp)}">${sp}</span>
          <span class="text-sm" style="font-weight:600;">${ct}</span>
        </div>
      `).join('');
      const speciesDetail = `
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
          <div class="bar-chart">
            ${speciesEntries.map(([sp, ct]) => `
              <div class="bar-row">
                <div class="bar-label">${sp}</div>
                <div class="bar-track">
                  <div class="bar-fill" style="width:${(ct / maxSp) * 100}%;background:${getSpeciesColor(sp)};">${ct}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // ── 8. LOCATIONS CARD ──
      const hotspots = lo.hotspots || [];
      const locationSummary = `
        <div class="text-sm">${hotspots.length} location${hotspots.length !== 1 ? 's' : ''} recorded${hotspots.length > 0 ? ` · Top: <strong>${hotspots[0].locationName || 'Unnamed'}</strong> (${hotspots[0].count})` : ''}</div>
      `;
      const bestLocHtml = Object.entries(lo.bestBySpecies || {}).map(([sp, info]) => `
        <div class="text-sm" style="padding:4px 0;"><span style="color:${getSpeciesColor(sp)}">${sp}</span>: <strong>${info.name}</strong> <span class="text-muted">(${info.count})</span></div>
      `).join('');
      const locationDetail = `
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
          ${hotspots.length > 0 ? `<div class="map-container mb-4" id="hotspotsMapContainer" style="height:280px;"><div id="hotspotsMap"></div></div>` : ''}
          ${hotspots.slice(0, 8).map(h => `
            <div class="flex justify-between items-center" style="padding:6px 0;border-bottom:1px solid var(--border);">
              <div>
                <span class="text-sm">${h.locationName || 'Unnamed'}</span>
                ${h.avgWeight ? `<span class="text-xs text-muted" style="margin-left:8px;">(avg ${h.avgWeight}lb)</span>` : ''}
              </div>
              <span class="text-sm text-muted">${h.count} catch${h.count !== 1 ? 'es' : ''}</span>
            </div>
          `).join('')}
          ${bestLocHtml ? `<div class="section-label mt-4 mb-2" style="font-size:0.7rem;">Best Location per Species</div>${bestLocHtml}` : ''}
        </div>
      `;

      // ── 9. MEMBER PROFILES ──
      const memberCards = ms.filter(m => m.totalCatches > 0 || m.totalVisits > 0).map((m, i) => {
        const isHot = m.recentCatches >= 3;
        return `
          <div class="card mb-3" style="cursor:pointer;transition:border-color 0.2s;" onclick="toggleStatCard('member-${m.id}')" id="sc-member-${m.id}">
            <div class="flex justify-between items-center">
              <div>
                <span class="text-sm" style="font-weight:600;">${m.name}</span>
                ${isHot ? '<span style="font-size:0.7rem;margin-left:6px;" title="On fire recently!">🔥</span>' : ''}
              </div>
              <div class="flex items-center gap-3">
                <span class="text-sm" style="font-weight:600;color:var(--gold);">${m.totalCatches}</span>
                <div id="sc-arrow-member-${m.id}" style="color:var(--text-muted);transition:transform 0.3s;font-size:1rem;">▸</div>
              </div>
            </div>
            <div class="flex gap-3 text-xs text-muted mt-2">
              <span>${m.successRate}% success</span>
              <span>${m.avgCatchesPerVisit}/trip</span>
              ${m.biggestFish ? `<span>PB: ${m.biggestFish.weight}lb</span>` : ''}
            </div>
            <div id="sc-detail-member-${m.id}" style="max-height:0;overflow:hidden;transition:max-height 0.4s ease;">
              <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div class="text-sm"><span class="text-muted">Visits:</span> <strong>${m.totalVisits}</strong></div>
                <div class="text-sm"><span class="text-muted">Blanks:</span> <strong style="color:var(--salmon);">${m.blankDays}</strong></div>
                <div class="text-sm"><span class="text-muted">Fav species:</span> <strong>${m.favouriteSpecies?.value || '—'}</strong></div>
                <div class="text-sm"><span class="text-muted">Fav bait:</span> <strong>${m.favouriteBait?.value || '—'}</strong></div>
                <div class="text-sm"><span class="text-muted">Best streak:</span> <strong>${m.bestStreak} day${m.bestStreak !== 1 ? 's' : ''}</strong></div>
                <div class="text-sm"><span class="text-muted">Current streak:</span> <strong style="color:${m.currentStreak > 0 ? 'var(--teal)' : 'var(--text-muted)'};">${m.currentStreak}</strong></div>
                <div class="text-sm"><span class="text-muted">Last 30 days:</span> <strong>${m.recentCatches} catch${m.recentCatches !== 1 ? 'es' : ''}</strong></div>
                ${m.avgWeight ? `<div class="text-sm"><span class="text-muted">Avg weight:</span> <strong>${m.avgWeight}lb</strong></div>` : ''}
              </div>
              ${Object.keys(m.speciesBreakdown || {}).length > 0 ? `
                <div style="margin-top:12px;">
                  <div class="section-label mb-2" style="font-size:0.65rem;">Species Split</div>
                  ${Object.entries(m.speciesBreakdown).sort((a, b) => b[1] - a[1]).map(([sp, ct]) => `
                    <div class="flex justify-between text-xs" style="padding:3px 0;">
                      <span style="color:${getSpeciesColor(sp)}">${sp}</span><span>${ct}</span>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              ${Object.keys(m.personalBests || {}).length > 0 ? `
                <div style="margin-top:12px;">
                  <div class="section-label mb-2" style="font-size:0.65rem;">Personal Bests</div>
                  ${Object.entries(m.personalBests).map(([sp, c]) => `
                    <div class="flex justify-between text-xs" style="padding:3px 0;">
                      <span style="color:${getSpeciesColor(sp)}">${sp}</span>
                      <span>${c.weight}lb${c.date ? ' · ' + formatDate(c.date) : ''}</span>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');

      // ── ASSEMBLE PAGE ──
      container.innerHTML = `
        ${statCard('overview', '📊', 'Season Overview', overviewSummary, overviewDetail, 0)}
        ${statCard('records', '🏆', 'Records & PBs', recordsSummary, recordsDetail, 0.05)}
        ${statCard('leaderboard', '🎣', 'Leaderboard', leaderSummary, leaderDetail, 0.1)}
        ${statCard('species', '🐟', 'Species Breakdown', speciesSummary, speciesDetail, 0.15)}
        ${statCard('time', '⏰', 'Time Analysis', timeSummary, timeDetail, 0.2)}
        ${statCard('conditions', '🌤️', 'Conditions', condSummary, condDetail, 0.25)}
        ${statCard('bait', '🪝', 'Bait & Method', baitSummary, baitDetail, 0.3)}
        ${statCard('locations', '📍', 'Locations', locationSummary, locationDetail, 0.35)}
        <div class="section-label mb-3 mt-5" style="animation:fadeIn 0.5s ease 0.4s forwards;opacity:0;">Members</div>
        <div style="animation:fadeIn 0.5s ease 0.4s forwards;opacity:0;">
          ${memberCards}
        </div>
        <div style="height:100px;"></div>
      `;

      // Load detail content into expandable sections
      document.querySelectorAll('[id^="sc-detail-"]').forEach(el => {
        const id = el.id.replace('sc-detail-', '');
        const detailMap = {
          'overview': overviewDetail,
          'records': recordsDetail,
          'leaderboard': leaderDetail,
          'species': speciesDetail,
          'time': timeDetail,
          'conditions': condDetail,
          'bait': baitDetail,
          'locations': locationDetail,
        };
        if (detailMap[id]) el.innerHTML = detailMap[id];
      });
    }

    // Hotspots map (lazy loaded when locations card expanded)
    let hotspotsMapInit = false;
    function initHotspotsMap() {
      if (hotspotsMapInit) return;
      const hmEl = document.getElementById('hotspotsMap');
      if (!hmEl) return;
      hotspotsMapInit = true;

      const s = state.stats;
      const spots = s?.locations?.hotspots || [];
      if (spots.length === 0) return;

      const hm = L.map('hotspotsMap', { center: CONFIG.MAP_CENTER, zoom: CONFIG.MAP_ZOOM, attributionControl: false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(hm);

      const bounds = [];
      spots.forEach(spot => {
        const size = Math.max(16, Math.min(40, 12 + spot.count * 6));
        const topSpecies = Object.entries(spot.species).sort((a, b) => b[1] - a[1])[0];
        const color = topSpecies ? getSpeciesColor(topSpecies[0]) : 'var(--gold)';
        L.marker([spot.lat, spot.lng], {
          icon: L.divIcon({
            className: '',
            html: `<div style="width:${size}px;height:${size}px;background:${color};border:3px solid rgba(255,255,255,0.8);border-radius:50%;box-shadow:0 2px 12px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:rgba(0,0,0,0.7);">${spot.count}</div>`,
            iconSize: [size, size], iconAnchor: [size / 2, size / 2],
          }),
        }).addTo(hm).bindPopup(`<div style="font-family:var(--font-body);font-size:13px;"><strong>${spot.locationName || 'Location'}</strong><br>${spot.count} catch${spot.count !== 1 ? 'es' : ''}<br>${Object.entries(spot.species).map(([sp, ct]) => `${sp}: ${ct}`).join('<br>')}</div>`);
        bounds.push([spot.lat, spot.lng]);
      });
      if (bounds.length > 1) hm.fitBounds(bounds, { padding: [30, 30] });
      setTimeout(() => hm.invalidateSize(), 300);
    }

    // ─── WEATHER FETCH ─────────────────────────────────────────
    const WMO_CODES = {
      0: ['Clear sky', '☀️'], 1: ['Mainly clear', '🌤️'], 2: ['Partly cloudy', '⛅'],
      3: ['Overcast', '☁️'], 45: ['Fog', '🌫️'], 48: ['Rime fog', '🌫️'],
      51: ['Light drizzle', '🌦️'], 53: ['Drizzle', '🌧️'], 55: ['Heavy drizzle', '🌧️'],
      61: ['Light rain', '🌦️'], 63: ['Rain', '🌧️'], 65: ['Heavy rain', '🌧️'],
      66: ['Light freezing rain', '🌨️'], 67: ['Freezing rain', '🌨️'],
      71: ['Light snow', '🌨️'], 73: ['Snow', '❄️'], 75: ['Heavy snow', '❄️'],
      77: ['Snow grains', '❄️'], 80: ['Light showers', '🌦️'], 81: ['Showers', '🌧️'],
      82: ['Heavy showers', '🌧️'], 85: ['Snow showers', '🌨️'], 86: ['Heavy snow showers', '🌨️'],
      95: ['Thunderstorm', '⛈️'], 96: ['Thunderstorm + hail', '⛈️'], 99: ['Thunderstorm + heavy hail', '⛈️'],
    };

    async function fetchWeather(lat, lng) {
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,pressure_msl&daily=precipitation_sum&wind_speed_unit=mph&timezone=Europe%2FLondon&past_days=2&forecast_days=1`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.current) {
          const c = data.current;
          const wmo = WMO_CODES[c.weather_code] || ['Unknown', '🌡️'];

          const weatherObj = {
            temperature: c.temperature_2m,
            humidity: c.relative_humidity_2m,
            windSpeed: c.wind_speed_10m,
            windDirection: c.wind_direction_10m,
            pressure: c.pressure_msl,
            weatherCode: c.weather_code,
            description: wmo[0],
            icon: wmo[1],
          };

          // Update weather UI
          const group = document.getElementById('weatherGroup');
          if (group) {
            group.style.display = 'block';
            document.getElementById('weatherIcon').textContent = wmo[1];
            document.getElementById('weatherTemp').textContent = `${c.temperature_2m}°C`;
            document.getElementById('weatherDesc').textContent = wmo[0];
            document.getElementById('weatherWind').textContent = `Wind: ${c.wind_speed_10m} mph`;
            document.getElementById('weatherExtra').textContent = `Humidity: ${c.relative_humidity_2m}% · ${c.pressure_msl} hPa`;
            document.getElementById('weatherData').value = JSON.stringify(weatherObj);
          }

          // Auto-fill water temp from air temp if field is empty
          const waterTempField = document.getElementById('waterTemp');
          const waterTempHint = document.getElementById('waterTempHint');
          if (waterTempField && !waterTempField.value) {
            // River temp is typically a few degrees below air temp in Scotland
            const airTemp = c.temperature_2m;
            const estimatedWaterTemp = Math.round((airTemp - 2) * 2) / 2; // round to 0.5
            const clampedTemp = Math.max(1, Math.min(25, estimatedWaterTemp));
            waterTempField.value = clampedTemp;
            if (waterTempHint) {
              waterTempHint.style.display = 'block';
              waterTempHint.innerHTML = `Estimated from ${airTemp}°C air temp — overtype if you have a reading`;
            }
            waterTempField.addEventListener('input', function handler() {
              if (waterTempHint) waterTempHint.style.display = 'none';
              waterTempField.removeEventListener('input', handler);
            }, { once: true });
          }

          // Auto-fill water clarity from recent rainfall
          const clarityField = document.getElementById('waterClarity');
          const clarityHint = document.getElementById('waterClarityHint');
          if (clarityField && !clarityField.value && data.daily?.precipitation_sum) {
            const precip = data.daily.precipitation_sum;
            // Sum last 2 days of rainfall
            const recentRain = precip.slice(0, -1).reduce((a, b) => a + (b || 0), 0);
            let estimated = '';
            let reason = '';
            if (recentRain > 20) { estimated = 'Muddy'; reason = `${recentRain.toFixed(0)}mm rain in 48hrs`; }
            else if (recentRain > 10) { estimated = 'Coloured'; reason = `${recentRain.toFixed(0)}mm rain in 48hrs`; }
            else if (recentRain > 4) { estimated = 'Slightly Coloured'; reason = `${recentRain.toFixed(0)}mm rain in 48hrs`; }
            else if (recentRain > 1) { estimated = 'Clear'; reason = 'light recent rain'; }
            else { estimated = 'Clear'; reason = 'little/no recent rain'; }

            clarityField.value = estimated;
            if (clarityHint) {
              clarityHint.style.display = 'block';
              clarityHint.innerHTML = `Estimated: ${reason} — change if different on the day`;
            }
            clarityField.addEventListener('change', function handler() {
              if (clarityHint) clarityHint.style.display = 'none';
              clarityField.removeEventListener('change', handler);
            }, { once: true });
          }
        }
      } catch (err) {
        console.error('Weather fetch failed:', err);
      }
    }

    // ─── GALLERY PAGE ───────────────────────────────────────────
    function renderGallery() {
      return `
        <div class="page">
          <div class="animate-in mb-4" style="margin-top:8px;">
            <div class="section-label">Photo Gallery</div>
            <h1 class="heading-xl">Catches</h1>
          </div>
          <div id="galleryGrid" class="animate-in animate-in-delay-1">
            <div class="text-center" style="padding:48px;">
              <div class="spinner" style="margin:0 auto;width:28px;height:28px;color:var(--gold);"></div>
              <p class="text-muted text-sm" style="margin-top:12px;">Loading gallery...</p>
            </div>
          </div>
        </div>
      `;
    }

    let galleryCache = [];

    async function loadGallery() {
      try {
        const catches = await api('/api/catches?hasPhoto=true');
        galleryCache = catches;
        renderGalleryGrid(catches);
      } catch (err) {
        console.error('Failed to load gallery:', err);
      }
    }

    async function renderGalleryGrid(catches) {
      const container = document.getElementById('galleryGrid');
      if (!container) return;

      if (catches.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            ${icons.camera}
            <h3>No photos yet</h3>
            <p>Photos will appear here when catches are logged with images</p>
          </div>
        `;
        return;
      }

      // Create masonry grid, then lazy-load photos
      container.innerHTML = `
        <div id="galleryMasonry" style="columns:2;column-gap:6px;">
          ${catches.map((c, i) => `
            <div class="gallery-tile" id="gtile-${c.id}" onclick="viewCatchDetail('${c.id}')" style="break-inside:avoid;margin-bottom:6px;background:var(--bg-card);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;border-radius:var(--radius-sm);animation:fadeIn 0.4s ease ${Math.min(i * 0.05, 0.5)}s forwards;opacity:0;min-height:140px;">
              <div class="spinner" style="width:16px;height:16px;color:var(--text-muted);"></div>
              <div style="position:absolute;bottom:0;left:0;right:0;padding:8px 10px;background:linear-gradient(transparent,rgba(0,0,0,0.75));z-index:2;pointer-events:none;">
                <div style="font-size:0.75rem;font-weight:600;color:white;">${c.species === 'Other' ? (c.customSpecies || 'Other') : c.species}</div>
                <div style="font-size:0.65rem;color:rgba(255,255,255,0.6);">${c.memberName}${c.weight ? ` · ${c.weight}lb` : ''} · ${formatDate(c.date)}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      // Also add these to allCatches so viewCatchDetail works
      catches.forEach(c => {
        if (!allCatches.find(x => x.id === c.id)) allCatches.push(c);
      });

      // Lazy-load photos
      for (const c of catches) {
        try {
          const data = await api(`/api/photo?id=${c.id}`);
          if (data.photo) {
            const tile = document.getElementById(`gtile-${c.id}`);
            if (tile) {
              tile.style.minHeight = '0';
              tile.innerHTML = `
                <img src="${data.photo}" style="width:100%;height:auto;display:block;border-radius:var(--radius-sm);" alt="${c.species}">
                <div style="position:absolute;bottom:0;left:0;right:0;padding:8px 10px;background:linear-gradient(transparent,rgba(0,0,0,0.75));z-index:2;pointer-events:none;">
                  <div style="font-size:0.75rem;font-weight:600;color:white;">${c.species === 'Other' ? (c.customSpecies || 'Other') : c.species}</div>
                  <div style="font-size:0.65rem;color:rgba(255,255,255,0.6);">${c.memberName}${c.weight ? ` · ${c.weight}lb` : ''} · ${formatDate(c.date)}</div>
                </div>
              `;
            }
          }
        } catch (e) {}
      }
    }

    // ─── MORE PAGE ────────────────────────────────────────────
    function renderMore() {
      return `
        <div class="page">
          <div class="animate-in mb-4" style="margin-top:8px;">
            <div class="section-label">Barjarg Fishings</div>
            <h1 class="heading-xl">More</h1>
          </div>
          <div class="flex flex-col gap-2 animate-in animate-in-delay-1">
            ${[
              { page: 'gallery', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>', label: 'Photo Gallery', desc: 'Browse catch photos' },
              { page: 'guests', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>', label: 'Guest Book', desc: 'Log & track guest visits' },
              { page: 'maintenance', icon: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>', label: 'Maintenance', desc: 'Report & track tasks' },
            ].map(item => `
              <button class="card flex items-center gap-3" onclick="navigate('${item.page}')" style="cursor:pointer;text-align:left;width:100%;border:1px solid var(--border);background:var(--bg-card);">
                <div style="color:var(--gold);">${item.icon}</div>
                <div style="flex:1;">
                  <div class="text-sm" style="font-weight:600;">${item.label}</div>
                  <div class="text-xs text-muted">${item.desc}</div>
                </div>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
              </button>
            `).join('')}
          </div>

          <div class="animate-in animate-in-delay-2" style="margin-top:24px;">
            <div class="section-label mb-3">Quick Actions</div>
            <div class="flex gap-2" style="flex-wrap:wrap;">
              <button class="btn btn-secondary btn-sm" onclick="showSyndicateRules()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/></svg>
                Rules
              </button>
              <button class="btn btn-secondary btn-sm" onclick="exportCSV()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                CSV
              </button>
              <button class="btn btn-secondary btn-sm" onclick="exportNDSFB()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                NDSFB
              </button>
              <button class="btn btn-secondary btn-sm" onclick="handleLogout()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Log Out
              </button>
            </div>
          </div>
          <div style="height:120px;"></div>
        </div>
      `;
    }

    // ─── GUEST MANAGEMENT ────────────────────────────────────────
    function renderGuests() {
      return `
        <div class="page">
          <div class="animate-in mb-4" style="margin-top:8px;">
            <button class="btn btn-ghost btn-sm mb-2" onclick="navigate('more')" style="padding:4px 0;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
              Back
            </button>
            <div class="flex justify-between items-center">
              <div>
                <div class="section-label">Guest Book</div>
                <h1 class="heading-xl">Guests</h1>
              </div>
              <button class="btn btn-sm" onclick="showAddGuestModal()" style="background:var(--gold);color:var(--bg);">Add Guest</button>
            </div>
          </div>
          <div id="guestsList" class="animate-in animate-in-delay-1">
            <div class="text-center" style="padding:48px;">
              <div class="spinner" style="margin:0 auto;width:24px;height:24px;color:var(--gold);"></div>
            </div>
          </div>
          <div style="height:120px;"></div>
        </div>
      `;
    }

    async function loadGuestsData() {
      try {
        const guests = await api('/api/guests');
        const container = document.getElementById('guestsList');
        if (!container) return;
        if (guests.length === 0) {
          container.innerHTML = '<div class="empty-state"><h3>No guest visits logged</h3><p>Tap "Add Guest" to record a guest visit</p></div>';
          return;
        }
        // Group by guest name and count visits
        const guestCounts = {};
        guests.forEach(g => {
          if (!guestCounts[g.guestName]) guestCounts[g.guestName] = { visits: [], broughtBy: g.broughtByName, type: g.guestType || 'guest' };
          guestCounts[g.guestName].visits.push(g);
          // Use most recent type if it changes
          if (g.guestType) guestCounts[g.guestName].type = g.guestType;
        });

        container.innerHTML = `
          <div class="card mb-3" style="background:linear-gradient(135deg, rgba(212,165,116,0.06), rgba(212,165,116,0.02));border-color:rgba(212,165,116,0.12);">
            <div class="text-xs text-muted" style="line-height:1.6;">
              <strong style="color:var(--gold);">Rule 6:</strong> Repeat guests may only visit <strong style="color:var(--gold);">3 times</strong> per season.<br>
              <strong style="color:var(--teal);">Rule 7:</strong> Family/junior guests (21 & under) are <strong style="color:var(--teal);">exempt</strong> — must be accompanied by a member.
            </div>
          </div>
          ${Object.entries(guestCounts).map(([name, data]) => {
            const isFamily = data.type === 'family';
            const countableVisits = data.visits.filter(v => (v.guestType || 'guest') === 'guest').length;
            const overLimit = !isFamily && countableVisits >= 3;
            const badgeText = isFamily ? 'Family / Junior' : `${countableVisits}/3 visits`;
            const badgeBg = isFamily ? 'rgba(45,212,191,0.15);color:var(--teal)' : (overLimit ? 'rgba(248,113,113,0.15);color:#f87171' : 'rgba(45,212,191,0.15);color:var(--teal)');
            return `
              <div class="card mb-2">
                <div class="flex justify-between items-start">
                  <div>
                    <div class="text-sm" style="font-weight:600;">${name}</div>
                    <div class="text-xs text-muted">Guest of ${data.broughtBy}${isFamily ? ' · <span style="color:var(--teal);">Exempt from limit</span>' : ''}</div>
                  </div>
                  <span style="padding:2px 10px;border-radius:20px;font-size:0.65rem;font-weight:600;background:${badgeBg};">
                    ${badgeText}
                  </span>
                </div>
                <div style="margin-top:8px;">
                  ${data.visits.map(v => `<div class="text-xs text-muted" style="padding:2px 0;">${formatDate(v.date)}${v.notes ? ' — ' + v.notes : ''}${v.guestType === 'family' ? ' <span style="color:var(--teal);">(family)</span>' : ''}</div>`).join('')}
                </div>
              </div>
            `;
          }).join('')}
        `;
      } catch (e) {
        console.error('Guest load error:', e);
      }
    }

    function showAddGuestModal() {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);display:flex;align-items:flex-end;justify-content:center;animation:fadeIn 0.2s ease;';
      modal.innerHTML = `
        <div style="max-width:540px;width:100%;background:var(--bg-card);border-radius:var(--radius) var(--radius) 0 0;padding:24px;max-height:80vh;overflow-y:auto;">
          <div class="flex justify-between items-center mb-4">
            <h3 style="font-family:var(--font-heading);font-weight:700;font-size:1.1rem;">Log Guest Visit</h3>
            <button class="btn btn-ghost" onclick="this.closest('div[style*=fixed]').remove()" style="padding:4px;">${icons.x}</button>
          </div>
          <div class="form-group">
            <label class="form-label">Guest Type</label>
            <div class="flex gap-2">
              <button type="button" class="btn btn-secondary btn-sm flex-1" id="gTypeGuest" onclick="setGuestType('guest')" style="padding:8px;background:var(--gold);color:var(--bg);border-color:var(--gold);">Guest</button>
              <button type="button" class="btn btn-secondary btn-sm flex-1" id="gTypeFamily" onclick="setGuestType('family')" style="padding:8px;">Family / Junior</button>
            </div>
            <input type="hidden" id="guestTypeInput" value="guest">
            <div id="guestTypeHint" class="text-xs text-muted" style="margin-top:4px;">Counts toward 3-visit season limit (Rule 6)</div>
          </div>
          <div class="form-group">
            <label class="form-label">Guest Name</label>
            <input class="form-input" id="guestNameInput" placeholder="Guest's full name">
          </div>
          <div class="form-group">
            <label class="form-label">Date</label>
            <input class="form-input" type="date" id="guestDateInput" value="${new Date().toISOString().split('T')[0]}">
          </div>
          <div class="form-group">
            <label class="form-label">Notes <span class="optional">(optional)</span></label>
            <input class="form-input" id="guestNotesInput" placeholder="e.g. Relationship, experience level...">
          </div>
          <button class="btn btn-primary btn-block" onclick="submitGuest(this)">Log Guest Visit</button>
        </div>
      `;
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
      document.body.appendChild(modal);
    }

    function setGuestType(type) {
      document.getElementById('guestTypeInput').value = type;
      const btnG = document.getElementById('gTypeGuest');
      const btnF = document.getElementById('gTypeFamily');
      const hint = document.getElementById('guestTypeHint');
      if (type === 'guest') {
        btnG.style.background = 'var(--gold)'; btnG.style.color = 'var(--bg)'; btnG.style.borderColor = 'var(--gold)';
        btnF.style.background = ''; btnF.style.color = ''; btnF.style.borderColor = '';
        if (hint) hint.textContent = 'Counts toward 3-visit season limit (Rule 6)';
      } else {
        btnF.style.background = 'var(--teal)'; btnF.style.color = 'var(--bg)'; btnF.style.borderColor = 'var(--teal)';
        btnG.style.background = ''; btnG.style.color = ''; btnG.style.borderColor = '';
        if (hint) hint.innerHTML = 'Age 21 & under — <strong style="color:var(--teal);">does not count</strong> toward the 3-visit limit (Rule 7). Must be accompanied by a member.';
      }
    }

    async function submitGuest(btn) {
      const name = document.getElementById('guestNameInput')?.value?.trim();
      if (!name) { showToast('Please enter guest name', 'error'); return; }
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;"></div>';
      try {
        await api('/api/guests', { method: 'POST', body: JSON.stringify({
          guestName: name,
          broughtBy: state.user.id,
          broughtByName: state.user.name,
          date: document.getElementById('guestDateInput')?.value || new Date().toISOString().split('T')[0],
          notes: document.getElementById('guestNotesInput')?.value || null,
          guestType: document.getElementById('guestTypeInput')?.value || 'guest',
        })});
        btn.closest('div[style*=fixed]').remove();
        showToast('Guest visit logged');
        loadGuestsData();
      } catch (e) { showToast(e.message || 'Failed to log guest', 'error'); btn.disabled = false; btn.textContent = 'Log Guest Visit'; }
    }

    // ─── MAINTENANCE TRACKER ─────────────────────────────────────
    function renderMaintenance() {
      return `
        <div class="page">
          <div class="animate-in mb-4" style="margin-top:8px;">
            <button class="btn btn-ghost btn-sm mb-2" onclick="navigate('more')" style="padding:4px 0;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
              Back
            </button>
            <div class="flex justify-between items-center">
              <div>
                <div class="section-label">Cabin & Banks</div>
                <h1 class="heading-xl">Maintenance</h1>
              </div>
              <button class="btn btn-sm" onclick="showAddMaintenanceModal()" style="background:var(--gold);color:var(--bg);">Report Issue</button>
            </div>
          </div>
          <div id="maintenanceList" class="animate-in animate-in-delay-1">
            <div class="text-center" style="padding:48px;">
              <div class="spinner" style="margin:0 auto;width:24px;height:24px;color:var(--gold);"></div>
            </div>
          </div>
          <div style="height:120px;"></div>
        </div>
      `;
    }

    async function loadMaintenanceData() {
      try {
        const tasks = await api('/api/maintenance');
        const container = document.getElementById('maintenanceList');
        if (!container) return;
        if (tasks.length === 0) {
          container.innerHTML = '<div class="empty-state"><h3>No maintenance tasks</h3><p>Tap "Report Issue" to create one</p></div>';
          return;
        }
        const open = tasks.filter(t => t.status === 'open');
        const done = tasks.filter(t => t.status === 'done');
        container.innerHTML = `
          ${open.length > 0 ? `
            <div class="section-label mb-2">Open Tasks (${open.length})</div>
            ${open.map(t => renderMaintenanceCard(t)).join('')}
          ` : '<div class="card mb-3" style="text-align:center;"><div class="text-sm text-muted">All clear — no open tasks</div></div>'}
          ${done.length > 0 ? `
            <div class="section-label mb-2" style="margin-top:20px;">Completed (${done.length})</div>
            ${done.slice(0, 10).map(t => renderMaintenanceCard(t)).join('')}
          ` : ''}
        `;
      } catch (e) {
        console.error('Maintenance load error:', e);
      }
    }

    function renderMaintenanceCard(t) {
      const isDone = t.status === 'done';
      const priorityColor = t.priority === 'high' ? '#f87171' : t.priority === 'low' ? 'var(--text-muted)' : 'var(--gold)';
      return `
        <div class="card mb-2" style="${isDone ? 'opacity:0.6;' : ''}">
          <div class="flex items-start gap-3">
            <button onclick="toggleMaintenanceStatus('${t.id}', '${isDone ? 'open' : 'done'}')" style="flex-shrink:0;width:22px;height:22px;border-radius:50%;border:2px solid ${isDone ? 'var(--teal)' : 'var(--border)'};background:${isDone ? 'var(--teal)' : 'transparent'};cursor:pointer;display:flex;align-items:center;justify-content:center;margin-top:2px;">
              ${isDone ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : ''}
            </button>
            <div style="flex:1;min-width:0;">
              <div class="text-sm" style="font-weight:600;${isDone ? 'text-decoration:line-through;' : ''}">${t.title}</div>
              ${t.description ? `<div class="text-xs text-muted" style="margin-top:2px;">${t.description}</div>` : ''}
              <div class="text-xs text-muted" style="margin-top:4px;">
                ${isDone ? `Done by ${t.completedByName || 'Unknown'} · ${formatDate(t.completedAt?.split('T')[0])}` : `Reported by ${t.createdByName || 'Unknown'} · ${formatDate(t.createdAt?.split('T')[0])}`}
              </div>
            </div>
            <div style="flex-shrink:0;">
              <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${priorityColor};" title="${t.priority} priority"></span>
            </div>
          </div>
        </div>
      `;
    }

    async function toggleMaintenanceStatus(taskId, newStatus) {
      try {
        await api('/api/maintenance/update', { method: 'POST', body: JSON.stringify({ taskId, status: newStatus, memberId: state.user.id, memberName: state.user.name }) });
        showToast(newStatus === 'done' ? 'Task completed' : 'Task reopened');
        loadMaintenanceData();
      } catch (e) { showToast('Failed to update task', 'error'); }
    }

    function showAddMaintenanceModal() {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);display:flex;align-items:flex-end;justify-content:center;animation:fadeIn 0.2s ease;';
      modal.innerHTML = `
        <div style="max-width:540px;width:100%;background:var(--bg-card);border-radius:var(--radius) var(--radius) 0 0;padding:24px;max-height:80vh;overflow-y:auto;">
          <div class="flex justify-between items-center mb-4">
            <h3 style="font-family:var(--font-heading);font-weight:700;font-size:1.1rem;">Report Issue</h3>
            <button class="btn btn-ghost" onclick="this.closest('div[style*=fixed]').remove()" style="padding:4px;">${icons.x}</button>
          </div>
          <div class="form-group">
            <label class="form-label">What needs done?</label>
            <input class="form-input" id="maintTitleInput" placeholder="e.g. Cabin door hinge broken">
          </div>
          <div class="form-group">
            <label class="form-label">Details <span class="optional">(optional)</span></label>
            <textarea class="form-textarea" id="maintDescInput" placeholder="Any extra info or location details..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Priority</label>
            <div class="flex gap-2">
              <button type="button" class="btn btn-secondary btn-sm flex-1" id="prioLow" onclick="setMaintPriority('low')" style="padding:8px;">Low</button>
              <button type="button" class="btn btn-secondary btn-sm flex-1" id="prioNormal" onclick="setMaintPriority('normal')" style="padding:8px;background:var(--gold);color:var(--bg);border-color:var(--gold);">Normal</button>
              <button type="button" class="btn btn-secondary btn-sm flex-1" id="prioHigh" onclick="setMaintPriority('high')" style="padding:8px;">Urgent</button>
            </div>
            <input type="hidden" id="maintPriority" value="normal">
          </div>
          <button class="btn btn-primary btn-block" onclick="submitMaintenance(this)">Report Issue</button>
        </div>
      `;
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
      document.body.appendChild(modal);
    }

    function setMaintPriority(p) {
      document.getElementById('maintPriority').value = p;
      ['low','normal','high'].forEach(v => {
        const btn = document.getElementById('prio' + v.charAt(0).toUpperCase() + v.slice(1));
        if (!btn) return;
        const isActive = v === p;
        const color = v === 'high' ? '#f87171' : v === 'low' ? 'var(--text-muted)' : 'var(--gold)';
        btn.style.background = isActive ? color : '';
        btn.style.color = isActive ? (v === 'low' ? 'white' : 'var(--bg)') : '';
        btn.style.borderColor = isActive ? color : '';
      });
    }

    async function submitMaintenance(btn) {
      const title = document.getElementById('maintTitleInput')?.value?.trim();
      if (!title) { showToast('Please describe the issue', 'error'); return; }
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;"></div>';
      try {
        await api('/api/maintenance', { method: 'POST', body: JSON.stringify({
          title,
          description: document.getElementById('maintDescInput')?.value || null,
          priority: document.getElementById('maintPriority')?.value || 'normal',
          createdBy: state.user.id,
          createdByName: state.user.name,
        })});
        btn.closest('div[style*=fixed]').remove();
        showToast('Issue reported');
        loadMaintenanceData();
      } catch (e) { showToast(e.message || 'Failed to report', 'error'); btn.disabled = false; btn.textContent = 'Report Issue'; }
    }

    // ─── CSV EXPORT ─────────────────────────────────────────────
    function exportCSV() {
      const url = CONFIG.API_URL + '/api/export/csv';
      window.open(url, '_blank');
    }

    function exportNDSFB() {
      const url = CONFIG.API_URL + '/api/export/ndsfb';
      window.open(url, '_blank');
    }

    // ─── UTILITIES ──────────────────────────────────────────────
    function formatDate(dateStr) {
      if (!dateStr) return '';
      try {
        const d = new Date(dateStr + 'T00:00:00');
        return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
      } catch {
        return dateStr;
      }
    }

    function getGreeting() {
      const h = new Date().getHours();
      if (h < 12) return 'Good morning';
      if (h < 17) return 'Good afternoon';
      return 'Good evening';
    }

    // ─── PAGE INIT ──────────────────────────────────────────────
    function initPage() {
      if (state.currentPage === 'log') {
        initLogCatchPage();
      }
    }

    // ─── BOOT ───────────────────────────────────────────────────
    render();
  </script>
</body>
</html>
