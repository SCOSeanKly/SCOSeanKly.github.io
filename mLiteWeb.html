<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>mLite Web</title>
  <style>
    :root { 
      --bg: #2c3541;
      --card: #3a4452;
      --text: #f3f3f3;
      --muted: #9ca3af;
      --accent: #5b9cf5;
      --bad: #ef5350;
      --btn-bg: #4a5568;
      --disabled: #6b7280;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', Ubuntu, Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }

    .header { display:flex; justify-content:flex-end; align-items:center; padding:20px 24px; gap:16px; position:relative; z-index:100; }
    .logo { font-size:24px; font-weight:700; color:var(--text); letter-spacing:-0.5px; margin-right:auto; }
    .license-btn {
      padding:10px 20px; background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);
      border:none; border-radius:20px; color:white; font-size:13px; font-weight:600;
      cursor:pointer; transition:all .3s ease; box-shadow:0 4px 12px rgba(245,158,11,.3); white-space:nowrap;
    }
    .license-btn.active { background:linear-gradient(135deg,#10b981 0%,#059669 100%); box-shadow:0 4px 12px rgba(16,185,129,.3); }
    .license-btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .menu-container { position:relative; display:none; }
    .menu-container.show { display:block; }
    .menu-container.hidden { display:none; }
    .menu-toggle {
      width:50px; height:50px; border-radius:50%; background:var(--btn-bg); border:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center; color:var(--text);
      transition:all .3s cubic-bezier(.4,0,.2,1); box-shadow:0 4px 12px rgba(0,0,0,.3);
    }
    .menu-toggle:hover { background:#5a6578; transform:scale(1.05); }
    .menu-toggle.active { background: var(--accent); }
    .menu-icon { width:20px; height:20px; position:relative; display:flex; flex-direction:column; justify-content:space-between; }
    .menu-icon span { display:block; height:2px; width:100%; background: var(--text); border-radius:2px; transition: all .3s ease; }
    .menu-toggle.active .menu-icon span:nth-child(1){ transform: translateY(9px) rotate(45deg); }
    .menu-toggle.active .menu-icon span:nth-child(2){ opacity:0; }
    .menu-toggle.active .menu-icon span:nth-child(3){ transform: translateY(-9px) rotate(-45deg); }

    .menu-items { position:absolute; top:60px; right:0; display:flex; flex-direction:column; gap:12px; opacity:0; pointer-events:none; transform:translateY(-10px); transition:all .3s cubic-bezier(.4,0,.2,1); }
    .menu-items.active { opacity:1; pointer-events:all; transform:translateY(0); }
    .menu-btn {
      display:flex; align-items:center; gap:12px; padding:14px 20px; background:var(--btn-bg); border:none; border-radius:25px;
      color:var(--text); font-size:14px; font-weight:500; cursor:pointer; white-space:nowrap;
      box-shadow:0 4px 12px rgba(0,0,0,.3); transition:all .3s ease; animation: slideIn .3s ease forwards; opacity:0;
    }
    .menu-items.active .menu-btn:nth-child(1){ animation-delay:.05s } 
    .menu-items.active .menu-btn:nth-child(2){ animation-delay:.1s } 
    .menu-items.active .menu-btn:nth-child(3){ animation-delay:.15s } 
    .menu-items.active .menu-btn:nth-child(4){ animation-delay:.2s } 
    .menu-items.active .menu-btn:nth-child(5){ animation-delay:.25s } 
    @keyframes slideIn { from{opacity:0; transform:translateX(20px)} to{opacity:1; transform:translateX(0)} }
    .menu-btn:hover:not(.disabled) { background:#5a6578; transform:translateX(-5px); }
    .menu-btn svg { width:18px; height:18px; stroke: currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
    .menu-btn.disabled, .menu-btn[disabled]{ opacity:.45; cursor:not-allowed; pointer-events:none; }
    input[type=file]{ display:none; }

    .canvas-container { flex:1; display:flex; justify-content:center; align-items:center; padding:20px; overflow:hidden; position:relative; }

    .license-panel {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      pointer-events: none;
    }
    .license-card {
      pointer-events: all;
      width: min(560px, 92vw);
      background: rgba(26, 32, 44, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 22px;
      box-shadow: 0 8px 32px rgba(0,0,0,.45);
      display: none;
    }
    .license-card.show { display: block; }
    .license-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .license-sub { font-size: 14px; color: var(--muted); margin-bottom: 14px; }
    .license-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
    }
    .license-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.15);
      background: #2f3846;
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    .license-input.error { border-color:#ef5350; }
    .license-input.success { border-color:#10b981; }
    .modal-btn { padding:10px 14px; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px; }
    .modal-btn.primary { background:#5b9cf5; color:#fff; }
    .modal-btn.secondary { background:#4a5568; color:#fff; }

    .mockup-showcase {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.35;
      pointer-events: none;
      overflow: hidden;
      display: flex;
      align-items: center;
      z-index: 0;
    }
    .mockup-track { display:flex; gap:40px; animation: scroll 60s linear infinite; will-change: transform; }
    @keyframes scroll { from{transform: translateX(0)} to{transform: translateX(-50%)} }
    .mockup-item { flex-shrink:0; width:512px; height:512px; border-radius:16px; object-fit:contain; filter:grayscale(30%) brightness(0.8); }

    canvas { 
      max-width:100%; 
      max-height:100%; 
      border-radius:16px; 
      box-shadow:0 8px 32px rgba(0,0,0,.4); 
      background:var(--card);
      position: relative;
      z-index: 1;
    }

    .empty-state { 
      position:absolute; 
      text-align:center; 
      max-width:600px; 
      padding:40px; 
      pointer-events:none; 
      transition:opacity .5s ease, visibility .5s ease;
      z-index: 2;
    }
    .empty-state.hidden { opacity:0; visibility:hidden; }
    .empty-state h2 { font-size:32px; margin:0 0 16px 0; color:var(--text); font-weight:600; }
    .empty-state p { font-size:16px; color:var(--muted); line-height:1.6; margin:0 0 12px 0; }
    .empty-state .subtitle { font-size:18px; color:var(--muted); margin:0 0 24px 0; line-height:1.5; }
    .empty-state .license-notice { display:inline-block; margin-top:24px; padding:12px 20px; background:rgba(245,158,11,.1); border:1px solid rgba(245,158,11,.3); border-radius:8px; color:#f59e0b; font-size:14px; font-weight:500; }
    .empty-state .license-notice.active { background:rgba(16,185,129,.1); border-color:rgba(16,185,129,.3); color:#10b981; }

    .action-buttons { position:fixed; bottom:30px; right:30px; display:flex; flex-direction:column; gap:16px; z-index:50; }
    .action-btn { width:56px; height:56px; border-radius:16px; background:var(--accent); border:none; cursor:pointer; display:flex;
      align-items:center; justify-content:center; color:white; box-shadow:0 4px 16px rgba(91,156,245,.4); transition:all .3s ease; }
    .action-btn:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(91,156,245,.6); }
    .action-btn:active { transform:scale(.98); }
    .action-btn.secondary { background:var(--btn-bg); color:var(--text); box-shadow:0 4px 16px rgba(0,0,0,.3); }
    .action-btn.active { outline:3px solid rgba(91,156,245,.6); }
    .action-btn:disabled { opacity:.4; cursor:not-allowed; }
    .action-btn svg { width:22px; height:22px; stroke: currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }

    @keyframes pulseRingRed {
      0%   { box-shadow: 0 0 0 0 rgba(230,69,69,.55), 0 0 0 6px rgba(230,69,69,.0); }
      70%  { box-shadow: 0 0 0 6px rgba(230,69,69,.0), 0 0 0 12px rgba(230,69,69,.0); }
      100% { box-shadow: 0 0 0 0 rgba(230,69,69,.0), 0 0 0 0 rgba(230,69,69,.0); }
    }
    body.editing .action-buttons .action-btn:not(#editBtn) { opacity:.35; pointer-events:auto; }
    body.editing #editBtn { 
      animation: pulseRingRed 1.5s ease-out infinite; 
      background: linear-gradient(135deg, #ff6b6b 0%, #e64545 100%);
      box-shadow: 0 4px 16px rgba(230,69,69,.4);
    }

    .status-toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); padding:12px 24px; border-radius:25px; font-size:14px; font-weight:500; box-shadow:0 4px 16px rgba(0,0,0,.3); transition:transform .3s ease, opacity .3s ease; opacity:0; z-index:1000; pointer-events:none; }
    .status-toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
    .status-toast.idle { background:var(--btn-bg); color:var(--text); }
    .status-toast.loading { background:var(--accent); color:white; }
    .status-toast.success { background:#66bb6a; color:white; }
    .status-toast.error { background:var(--bad); color:white; }
    .error-container { position:fixed; top:80px; left:50%; transform:translateX(-50%); max-width:500px; width:90%; padding:16px 20px; background:rgba(239,83,80,.95); color:white; border-radius:12px; box-shadow:0 4px 16px rgba(239,83,80,.4); font-size:14px; z-index:1000; display:none; }
    .error-container.show { display:block; }

    .footer { padding:16px 24px; text-align:center; color:var(--muted); font-size:13px; border-top:1px solid rgba(255,255,255,.05); background:rgba(0,0,0,.2); }
    .footer a { color:var(--accent); text-decoration:none; }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">mLite Web</div>
    <button class="license-btn" id="licenseBtn">ðŸ”’ Get License</button>

    <div class="menu-container hidden" id="menuContainer">
      <button class="menu-toggle" id="menuToggle" aria-label="Menu">
        <div class="menu-icon">
          <span></span><span></span><span></span>
        </div>
      </button>
      <div class="menu-items" id="menuItems">
        <label class="menu-btn" id="btnImportTemplate" for="templateFile">
          <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/><path d="M4 19h16a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1H9l-5 5v8a1 1 0 0 0 1 1z"/></svg>
          <input id="templateFile" type="file" accept="image/png">
          <span>Import Template</span>
        </label>
        <label class="menu-btn" id="btnImportMl" for="mliteFile">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16l4-4h10a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
          <input id="mliteFile" type="file" accept=".mlite,application/json">
          <span>Import .mlite</span>
        </label>
        <label class="menu-btn disabled" id="btnImportShot" data-disabled="true">
          <svg viewBox="0 0 24 24"><path d="M4 7h4l2-3h4l2 3h4v12H4z"/><path d="M12 10v6M9 13h6"/></svg>
          <input id="shotFile" type="file" accept="image/*" disabled>
          <span>Import Screenshot</span>
        </label>
        <button class="menu-btn disabled" id="saveBtn" disabled>
          <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5-5 5 5"/><path d="M12 15V5"/></svg>
          <span>Save Mockup Image</span>
        </button>
        <button class="menu-btn" id="websiteBtn">
          <svg viewBox="0 0 24 24"><path d="M12 3a9 9 0 1 0 0 18 9 9 0 0 0 0-18z"/><path d="M3 12h18"/><path d="M12 3c2.5 2.7 4 6 4 9s-1.5 6.3-4 9m0-18c-2.5 2.7-4 6-4 9s1.5 6.3 4 9"/></svg>
          <span>showcreative.co.uk</span>
        </button>
      </div>
    </div>
  </div>

  <div class="canvas-container">
    <div class="mockup-showcase" id="mockupShowcase">
      <div class="mockup-track" id="mockupTrack"></div>
    </div>

    <div class="license-panel">
      <div class="license-card" id="licenseCard">
        <div class="license-title">Activate License</div>
        <div class="license-sub">Enter your license key to remove watermarks and unlock full features.</div>
        <div class="license-row">
          <input type="text" class="license-input" id="licenseInput" placeholder="XXXXXXXX-XXXXXXXX-XXXXXXXX-XXXXXXXX" maxlength="39">
          <button class="modal-btn secondary" id="purchaseBtn">Purchase</button>
          <button class="modal-btn primary" id="activateBtn">Activate</button>
        </div>
      </div>
    </div>

    <div class="empty-state" id="emptyState">
      <h2>Welcome to mLite Web</h2>
      <p class="subtitle">Import a Template PNG or a .mlite file, then import a screenshot to warp.</p>
      <p>â€¢ Screenshot auto-warps to your quad<br>â€¢ Toggle Edit to drag blue corner dots</p>
      <div class="license-notice" id="licenseNotice">ðŸ”’ License required to render and export images</div>
    </div>
    <canvas id="canvas" width="1024" height="1024"></canvas>
  </div>

  <div class="action-buttons">
    <button class="action-btn" id="editBtn" title="Toggle Edit (E)" aria-label="Edit" disabled>
      <svg id="editIcon" viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
    </button>
    <button class="action-btn secondary" id="exportMlBtn" title="Export .mlite" aria-label="Export .mlite" disabled>
      <svg viewBox="0 0 24 24"><path d="M12 5v10m0 0l-4-4m4 4 4-4M5 19h14"/></svg>
    </button>
    <button class="action-btn secondary" id="browseBtn" title="Community" aria-label="Community">
      <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4v-6a4 4 0 0 1 4-4"/><path d="M8 3h8a4 4 0 0 1 4 4v1"/><path d="M12 12h.01"/></svg>
    </button>
  </div>

  <div class="status-toast idle" id="statusToast">Ready</div>
  <div class="error-container" id="errorContainer"></div>

  <footer class="footer">
    <p>Â© <span id="currentYear"></span> <a href="https://showcreative.co.uk" target="_blank">ShowCreative</a> â€¢ Made with mLite</p>
  </footer>

<script>
const CONFIG = {
  GUMROAD_PRODUCT_URL: 'https://seankly.gumroad.com/l/gnvdnh',
  CLOUDFLARE_WORKER_URL: 'https://mlite-web-worker.ske-d03.workers.dev',
};

const MOCKUP_IMAGES = [
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup1.jpg',
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup2.jpg',
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup3.jpg',
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup4.jpg',
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup5.jpg',
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup6.jpg',
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup7.jpg',
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup8.jpg',
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup9.jpg',
  'https://raw.githubusercontent.com/SCOSeanKly/mLiteWeb/main/mockup10.jpg',
];

const els = {
  template: document.getElementById('templateFile'),
  mlite: document.getElementById('mliteFile'),
  shot: document.getElementById('shotFile'),
  btnImportTemplate: document.getElementById('btnImportTemplate'),
  btnImportMl: document.getElementById('btnImportMl'),
  btnImportShot: document.getElementById('btnImportShot'),
  save: document.getElementById('saveBtn'),
  browse: document.getElementById('browseBtn'),
  canvas: document.getElementById('canvas'),
  emptyState: document.getElementById('emptyState'),
  licenseNotice: document.getElementById('licenseNotice'),
  currentYear: document.getElementById('currentYear'),
  menuToggle: document.getElementById('menuToggle'),
  menuItems: document.getElementById('menuItems'),
  menuContainer: document.getElementById('menuContainer'),
  statusToast: document.getElementById('statusToast'),
  errorContainer: document.getElementById('errorContainer'),
  licenseBtn: document.getElementById('licenseBtn'),
  licenseInput: document.getElementById('licenseInput'),
  activateBtn: document.getElementById('activateBtn'),
  purchaseBtn: document.getElementById('purchaseBtn'),
  website: document.getElementById('websiteBtn'),
  editBtn: document.getElementById('editBtn'),
  exportMlBtn: document.getElementById('exportMlBtn'),
  editIcon: document.getElementById('editIcon'),
  mockupShowcase: document.getElementById('mockupShowcase'),
  mockupTrack: document.getElementById('mockupTrack'),
  licenseCard: document.getElementById('licenseCard'),
};

const ctx = els.canvas.getContext('2d', { alpha: false });
ctx.imageSmoothingEnabled = true;
ctx.imageSmoothingQuality = 'high';

function initMockupShowcase() {
  if (MOCKUP_IMAGES.length === 0) return;
  const all = [...MOCKUP_IMAGES, ...MOCKUP_IMAGES];
  els.mockupTrack.innerHTML = '';
  all.forEach(url => {
    const img = document.createElement('img');
    img.src = url;
    img.className = 'mockup-item';
    img.alt = 'Mockup example';
    els.mockupTrack.appendChild(img);
  });
}

const MESH_DETAIL_IDLE = 35;
const MESH_DETAIL_DRAG = 0;
let meshDetail = MESH_DETAIL_IDLE;
const DST_EPS = 1.5;
const SRC_EPS = 1.0;
const ACCENT = '#5b9cf5';

let state = {
  overlayImg: null,
  overlayW: 1024,
  overlayH: 1024,
  screenshotImg: null,
  quad: null,
  screenshotOnTop: false,
  cornerRadius: 0,
  hasLicense: false,
  licenseKey: null,
  editMode: false,
  activeHandle: -1,
  originalOverlayBase64: null,
  sourceType: null,
};

function updateEmptyState() {
  const hasContent = state.overlayImg || state.screenshotImg;
  els.emptyState.classList.toggle('hidden', !!hasContent);
}

function readyForEdit(){ return !!(state.overlayImg && state.screenshotImg && state.quad) && state.hasLicense; }
function readyForExport(){ return !!(state.overlayImg && state.quad) && state.hasLicense; }

function updateActionStates(){
  // Enable/disable edit button
  els.editBtn.disabled = !readyForEdit();
  
  // Enable save button if we have all required components:
  // 1. Valid license
  // 2. Overlay loaded (template PNG or .mlite)
  // 3. Screenshot imported
  // 4. Quad defined
  const canSave = state.hasLicense && 
                  state.overlayImg && 
                  state.screenshotImg && 
                  state.quad;
  
  // CRITICAL: Must update BOTH disabled attribute AND CSS class
  els.save.disabled = !canSave;
  if (canSave) {
    els.save.classList.remove('disabled');
  } else {
    els.save.classList.add('disabled');
  }
  
  // Enable screenshot import if template/mlite loaded and licensed
  const shotReady = !!state.overlayImg && state.hasLicense;
  els.shot.disabled = !shotReady;
  els.btnImportShot.dataset.disabled = shotReady ? '' : 'true';
  els.btnImportShot.classList.toggle('disabled', !shotReady);
  
  // Prevent importing both template and mlite (only one source type)
  if (state.sourceType === 'template') {
    els.btnImportMl.classList.add('disabled');
  } else if (state.sourceType === 'mlite') {
    els.btnImportTemplate.classList.add('disabled');
  } else {
    els.btnImportMl.classList.remove('disabled');
    els.btnImportTemplate.classList.remove('disabled');
  }
  
  // Enable .mlite export if overlay + quad exist and not in edit mode
const canExportMl = state.sourceType === 'template' &&  // âœ… MUST be template PNG
                    state.overlayImg && 
                    state.quad && 
                    state.hasLicense && 
                    !state.editMode;
els.exportMlBtn.disabled = !canExportMl;
}

let statusTimeout;
function setStatus(text, type='idle'){
  clearTimeout(statusTimeout);
  els.statusToast.textContent = text;
  els.statusToast.className = `status-toast ${type} show`;
  if (type==='success'||type==='error') {
    statusTimeout = setTimeout(()=>els.statusToast.classList.remove('show'), 2500);
  }
}

function setError(text){
  if (!text) return els.errorContainer.classList.remove('show');
  els.errorContainer.textContent = text;
  els.errorContainer.classList.add('show');
  setTimeout(()=>els.errorContainer.classList.remove('show'), 4000);
}

els.licenseInput.addEventListener('input', (e)=>{
  let value = e.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
  let formatted = value.match(/.{1,8}/g)?.join('-') || value;
  e.target.value = formatted;
});

els.licenseBtn.addEventListener('click', () => {
  window.open(CONFIG.GUMROAD_PRODUCT_URL, '_blank');
});

els.purchaseBtn.addEventListener('click', ()=> window.open(CONFIG.GUMROAD_PRODUCT_URL, '_blank'));

async function validateLicenseKey(key, silent=false){
  if (!silent) setStatus('Validating licenseâ€¦','loading');
  try{
    const response = await fetch(CONFIG.CLOUDFLARE_WORKER_URL + '/verify-license', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ license_key: key })
    });
    const data = await response.json();
    if (data.success){
      state.hasLicense = true;
      state.licenseKey = key;
      localStorage.setItem('mlite_license_key', key);
      els.licenseBtn.textContent = 'âœ“ Licensed';
      els.licenseBtn.classList.add('active');
      els.menuContainer.classList.add('show');
      els.menuContainer.classList.remove('hidden');
      updateLicenseUI();
      if (!silent) setStatus('License activated!','success');
      updateActionStates();
      return true;
    } else {
      throw new Error(data.message || 'Invalid license key');
    }
  }catch(err){
    els.licenseInput.classList.add('error');
    if (!silent){ setError('Invalid license key.'); setStatus('Activation failed','error'); }
    return false;
  }
}

function checkExistingLicense(){
  const savedKey = localStorage.getItem('mlite_license_key');
  if (savedKey) validateLicenseKey(savedKey, true);
}

function updateLicenseUI(){
  if (state.hasLicense){
    els.licenseNotice.textContent = 'âœ“ License activated - Ready to create!';
    els.licenseNotice.classList.add('active');
    els.licenseCard.classList.remove('show');
  } else {
    els.licenseNotice.textContent = 'ðŸ”’ License required to render and export images';
    els.licenseNotice.classList.remove('active');
    els.licenseCard.classList.add('show');
  }
}

els.activateBtn.addEventListener('click', async () => {
  const key = els.licenseInput.value.trim();
  if (!key) {
    setError("Please enter a license key");
    return;
  }
  await validateLicenseKey(key);
});

els.menuToggle.addEventListener('click', ()=>{
  els.menuToggle.classList.toggle('active');
  els.menuItems.classList.toggle('active');
});

document.addEventListener('click', (e)=>{
  if (!els.menuContainer.contains(e.target)) {
    els.menuToggle.classList.remove('active');
    els.menuItems.classList.remove('active');
  }
});

function normalizeQuad(points) {
  const pts = points.slice();
  pts.sort((a,b)=>a.y-b.y);
  const top = pts.slice(0,2).sort((a,b)=>a.x-b.x);
  const bot = pts.slice(2,4).sort((a,b)=>a.x-b.x);
  return [top[0], top[1], bot[1], bot[0]];
}

function drawTriangle(ctx, img, sx0, sy0, sx1, sy1, sx2, sy2, dx0, dy0, dx1, dy1, dx2, dy2) {
  const cx = (dx0 + dx1 + dx2) / 3, cy = (dy0 + dy1 + dy2) / 3;
  function expand(x,y){ 
    const dx = x - cx, dy = y - cy; 
    const len = Math.hypot(dx,dy) || 1; 
    const k = (len + DST_EPS) / len; 
    return [cx + dx*k, cy + dy*k]; 
  }
  const [edx0, edy0] = expand(dx0, dy0);
  const [edx1, edy1] = expand(dx1, dy1);
  const [edx2, edy2] = expand(dx2, dy2);
  
  ctx.save();
  ctx.globalCompositeOperation = 'source-over';
  ctx.beginPath();
  ctx.moveTo(edx0, edy0); 
  ctx.lineTo(edx1, edy1); 
  ctx.lineTo(edx2, edy2);
  ctx.closePath(); 
  ctx.clip();
  
  const denom = (sx0*(sy1-sy2)+sx1*(sy2-sy0)+sx2*(sy0-sy1));
  if (Math.abs(denom) < 1e-8) { ctx.restore(); return; }
  
  const a11=(edx0*(sy1-sy2)+edx1*(sy2-sy0)+edx2*(sy0-sy1))/denom;
  const a12=(edx0*(sx2-sx1)+edx1*(sx0-sx2)+edx2*(sx1-sx0))/denom;
  const a13=(edx0*(sx1*sy2-sx2*sy1)+edx1*(sx2*sy0-sx0*sy2)+edx2*(sx0*sy1-sx1*sy0))/denom;
  const a21=(edy0*(sy1-sy2)+edy1*(sy2-sy0)+edy2*(sy0-sy1))/denom;
  const a22=(edy0*(sx2-sx1)+edy1*(sx0-sx2)+edy2*(sx1-sx0))/denom;
  const a23=(edy0*(sx1*sy2-sx2*sy1)+edy1*(sx2*sy0-sx0*sy2)+edy2*(sx0*sy1-sx1*sy0))/denom;
  
  ctx.setTransform(a11,a21,a12,a22,a13,a23);
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  const iw = (img.naturalWidth||img.width), ih = (img.naturalHeight||img.height);
  ctx.drawImage(img, -SRC_EPS, -SRC_EPS, iw + SRC_EPS*2, ih + SRC_EPS*2);
  ctx.restore();
}

function warpImageToQuad(ctx, img, dstQuad, steps) {
  const w = img.naturalWidth || img.width, h = img.naturalHeight || img.height;
  const s = Math.max(2, steps|0);
  function lerp(a,b,t){ return [a[0]*(1-t)+b[0]*t, a[1]*(1-t)+b[1]*t]; }
  function toPt(p){ return {x:p[0], y:p[1]}; }
  function mix(p,q,t){ return {x:p.x*(1-t)+q.x*t, y:p.y*(1-t)+q.y*t}; }
  
  for (let yi=0; yi<s; yi++) {
    const v0=yi/s, v1=(yi+1)/s;
    const l0 = toPt( lerp(dstQuad[0], dstQuad[3], v0) );
    const r0 = toPt( lerp(dstQuad[1], dstQuad[2], v0) );
    const l1 = toPt( lerp(dstQuad[0], dstQuad[3], v1) );
    const r1 = toPt( lerp(dstQuad[1], dstQuad[2], v1) );
    
    for (let xi=0; xi<s; xi++) {
      const u0=xi/s, u1=(xi+1)/s;
      const p00 = mix(l0,r0,u0);
      const p10 = mix(l0,r0,u1);
      const p01 = mix(l1,r1,u0);
      const p11 = mix(l1,r1,u1);
      
      const sx0=u0*w, sy0=v0*h; 
      const sx1=u1*w, sy1=v0*h; 
      const sx2=u0*w, sy2=v1*h; 
      const sx3=u1*w, sy3=v1*h;
      
      drawTriangle(ctx,img,sx0,sy0,sx1,sy1,sx3,sy3,p00.x,p00.y,p10.x,p10.y,p11.x,p11.y);
      drawTriangle(ctx,img,sx0,sy0,sx3,sy3,sx2,sy2,p00.x,p00.y,p11.x,p11.y,p01.x,p01.y);
    }
  }
}

function doRender(drawHandles=true){
  if (!state.hasLicense || !state.overlayImg || !state.quad) return;
  const w = state.overlayW, h = state.overlayH;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.clearRect(0,0,w,h);
  
  const quadArr = [
    [state.quad[0].x, state.quad[0].y],
    [state.quad[1].x, state.quad[1].y],
    [state.quad[2].x, state.quad[2].y],
    [state.quad[3].x, state.quad[3].y],
  ];
  
  if (state.screenshotImg) {
    if (state.screenshotOnTop) { 
      ctx.drawImage(state.overlayImg, 0, 0); 
      warpImageToQuad(ctx, state.screenshotImg, quadArr, meshDetail); 
    } else { 
      warpImageToQuad(ctx, state.screenshotImg, quadArr, meshDetail); 
      ctx.drawImage(state.overlayImg, 0, 0); 
    }
  } else {
    ctx.drawImage(state.overlayImg, 0, 0);
  }
  
  if (state.editMode && drawHandles) drawEditHandles();
  setStatus(state.editMode ? 'Edit mode: drag blue corners' : (state.screenshotImg ? 'Rendered âœ“' : 'Template loaded âœ“'), state.editMode ? 'loading' : 'success');
}

function drawEditHandles(){
  const r = Math.max(5, Math.min(state.overlayW, state.overlayH) * 0.010);
  ctx.save();
  ctx.lineWidth = 6.00;
  ctx.strokeStyle = ACCENT;
  ctx.globalAlpha = 0.95;
  ctx.fillStyle = ACCENT;
  ctx.beginPath();
  ctx.moveTo(state.quad[0].x, state.quad[0].y);
  ctx.lineTo(state.quad[1].x, state.quad[1].y);
  ctx.lineTo(state.quad[2].x, state.quad[2].y);
  ctx.lineTo(state.quad[3].x, state.quad[3].y);
  ctx.closePath();
  ctx.stroke();
  
  for (let i=0;i<4;i++) {
    const p = state.quad[i];
    ctx.beginPath();
    ctx.arc(p.x, p.y, r, 0, Math.PI*2);
    ctx.fill();
    ctx.lineWidth = 1.25;
    ctx.strokeStyle = 'white';
    ctx.stroke();
  }
  ctx.restore();
}

function clientToCanvas(ev){
  const rect = els.canvas.getBoundingClientRect();
  const scaleX = els.canvas.width / rect.width;
  const scaleY = els.canvas.height / rect.height;
  const clientX = (ev.touches ? ev.touches[0].clientX : ev.clientX);
  const clientY = (ev.touches ? ev.touches[0].clientY : ev.clientY);
  return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
}

function hitTestHandle(x,y){
  const r = Math.max(5, Math.min(state.overlayW, state.overlayH) * 0.010);
  for (let i=0;i<4;i++){ 
    const p = state.quad[i]; 
    const dx=x-p.x, dy=y-p.y; 
    if (dx*dx+dy*dy <= (r*1.6)*(r*1.6)) return i; 
  }
  return -1;
}

let dragging=false;

function handlePointerDown(ev){
  if (!state.editMode) return;
  const pt = clientToCanvas(ev);
  const idx = hitTestHandle(pt.x, pt.y);
  if (idx !== -1) {
    state.activeHandle = idx;
    dragging = true;
    meshDetail = MESH_DETAIL_DRAG;
    doRender(true);
    ev.preventDefault();
  }
}

function handlePointerMove(ev){
  if (!state.editMode || !dragging) return;
  const pt = clientToCanvas(ev);
  const i = state.activeHandle;
  state.quad[i].x = Math.max(0, Math.min(state.overlayW, pt.x));
  state.quad[i].y = Math.max(0, Math.min(state.overlayH, pt.y));
  doRender(true);
  ev.preventDefault();
}

function doRender(drawHandles=true, skipWarp=false){
  if (!state.hasLicense || !state.overlayImg || !state.quad) return;
  const w = state.overlayW, h = state.overlayH;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.clearRect(0,0,w,h);
  
  const quadArr = [
    [state.quad[0].x, state.quad[0].y],
    [state.quad[1].x, state.quad[1].y],
    [state.quad[2].x, state.quad[2].y],
    [state.quad[3].x, state.quad[3].y],
  ];
  
  if (state.screenshotImg && !skipWarp) {  // <-- Add skipWarp check
    if (state.screenshotOnTop) { 
      ctx.drawImage(state.overlayImg, 0, 0); 
      warpImageToQuad(ctx, state.screenshotImg, quadArr, meshDetail); 
    } else { 
      warpImageToQuad(ctx, state.screenshotImg, quadArr, meshDetail); 
      ctx.drawImage(state.overlayImg, 0, 0); 
    }
  } else {
    ctx.drawImage(state.overlayImg, 0, 0);
  }
  
  if (state.editMode && drawHandles) drawEditHandles();
  setStatus(state.editMode ? 'Edit mode: drag blue corners' : (state.screenshotImg ? 'Rendered âœ“' : 'Template loaded âœ“'), state.editMode ? 'loading' : 'success');
}

function handlePointerMove(ev){
  if (!state.editMode || !dragging) return;
  const pt = clientToCanvas(ev);
  const i = state.activeHandle;
  state.quad[i].x = Math.max(0, Math.min(state.overlayW, pt.x));
  state.quad[i].y = Math.max(0, Math.min(state.overlayH, pt.y));
  doRender(true, true); // <-- Pass true to skip warp during drag
  ev.preventDefault();
}

function handlePointerUp(ev){
  if (!state.editMode) return;
  dragging = false;
  state.activeHandle = -1;
  meshDetail = MESH_DETAIL_IDLE;
  doRender(true, false); // <-- Full render with warp on release
  ev.preventDefault();
}

els.canvas.addEventListener('mousedown', handlePointerDown);
window.addEventListener('mousemove', handlePointerMove);
window.addEventListener('mouseup', handlePointerUp);
els.canvas.addEventListener('touchstart', handlePointerDown, {passive:false});
window.addEventListener('touchmove', handlePointerMove, {passive:false});
window.addEventListener('touchend', handlePointerUp);

function toggleEdit(on){
  const next = (on===undefined) ? !state.editMode : !!on;
  if (!state.hasLicense || !state.overlayImg || !state.quad) return;
  if (next === state.editMode) return;
  state.editMode = next;
  document.body.classList.toggle('editing', state.editMode);
  els.canvas.style.cursor = state.editMode ? 'pointer' : 'default';
  meshDetail = state.editMode ? MESH_DETAIL_DRAG : MESH_DETAIL_IDLE;
  els.editIcon.innerHTML = state.editMode
    ? '<path d="M3 3v6M3 3h6M21 3h-6M21 3v6M3 21v-6M3 21h6M21 21h-6M21 21v-6"/><path d="M9 9l-6-6M15 9l6-6M9 15l-6 6M15 15l6 6"/>'
    : '<path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>';
  updateActionStates();
  doRender(true);
}

els.editBtn.addEventListener('click', ()=>{ if (!els.editBtn.disabled) toggleEdit(); });
window.addEventListener('keydown', (e)=>{ if (e.key.toLowerCase()==='e' && !els.editBtn.disabled) toggleEdit(); });

function ensureDataUrl(str) {
  if (/^data:image\//.test(str)) return str;
  const head = str.slice(0,10);
  let mime = 'image/png';
  if (head.startsWith('iVBOR')) mime = 'image/png';
  else if (head.startsWith('/9j/')) mime = 'image/jpeg';
  else if (head.startsWith('R0lGOD')) mime = 'image/gif';
  else if (head.startsWith('PHN2Zy')) mime = 'image/svg+xml';
  else if (head.startsWith('AAAB')) mime = 'image/x-icon';
  return `data:${mime};base64,${str}`;
}

// Create default screenshot quad centered in overlay
function createDefaultScreenshotQuad() {
  const W = state.overlayW;
  const H = state.overlayH;
  const centerX = W / 2;
  const centerY = H / 2;
  const size = 512;
  const halfSize = size / 2;
  
  return normalizeQuad([
    { x: centerX - halfSize, y: centerY - halfSize },
    { x: centerX + halfSize, y: centerY - halfSize },
    { x: centerX + halfSize, y: centerY + halfSize },
    { x: centerX - halfSize, y: centerY + halfSize }
  ]);
}

document.getElementById('btnImportShot').addEventListener('click', (e)=>{
  if (!state.hasLicense) { 
    setStatus('Activate your license to import images','error'); 
    e.preventDefault(); 
    e.stopPropagation(); 
    return; 
  }
  if (e.currentTarget.dataset.disabled) { 
    setStatus('Import a Template PNG or .mlite first','error'); 
    e.preventDefault(); 
    e.stopPropagation(); 
  }
});

// Import Template PNG
els.template.addEventListener('change', async (e)=>{
  if (!state.hasLicense) { 
    setStatus('Please activate your license first.','error'); 
    e.target.value=''; 
    return; 
  }
  const file = e.target.files[0];
  if (!file) return;
  if (!/\.png$/i.test(file.name)) { setError('Template must be a PNG.'); return; }
  setStatus('Loading templateâ€¦','loading');
  try{
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      const overlayImg = new Image();
      overlayImg.onload = () => {
        state.overlayImg = overlayImg;
        state.overlayW = overlayImg.naturalWidth;
        state.overlayH = overlayImg.naturalHeight;
        els.canvas.width = state.overlayW;
        els.canvas.height = state.overlayH;
        state.originalOverlayBase64 = String(dataUrl).split(',')[1] || '';
        state.sourceType = 'template';

        const inset = Math.round(Math.min(state.overlayW, state.overlayH) * 0.08);
        const W = state.overlayW, H = state.overlayH;
        state.quad = normalizeQuad([
          { x: inset,     y: inset },
          { x: W - inset, y: inset },
          { x: W - inset, y: H - inset },
          { x: inset,     y: H - inset }
        ]);
        state.screenshotOnTop = false;
        state.cornerRadius = 0;

        updateEmptyState();
        updateActionStates();
        doRender(false);
        setStatus('Template loaded âœ“','success');
      };
      overlayImg.onerror = ()=> setError('Failed to decode template PNG');
      overlayImg.src = dataUrl;
    };
    reader.onerror = ()=> setError('Failed to read template file');
    reader.readAsDataURL(file);
  }catch(err){
    setError('Template import failed: ' + err.message);
  }
  e.target.value = '';
});

// Import .mlite
els.mlite.addEventListener('change', async (e)=>{
  if (!state.hasLicense) { 
    setStatus('Please activate your license first.','error'); 
    e.target.value=''; 
    return; 
  }
  const file = e.target.files[0]; 
  if (!file) return;
  setStatus('Loading .mliteâ€¦','loading');
  
  try{
    const txt = await file.text();
    const obj = JSON.parse(txt);
    let ovl = obj.customDeviceMockupBase64;
    if (!ovl) throw new Error('customDeviceMockupBase64 missing');
    state.originalOverlayBase64 = ovl;
    ovl = ensureDataUrl(ovl);
    state.sourceType = 'mlite';
    
    const overlayImg = new Image();
    overlayImg.onload = () => {
      state.overlayImg = overlayImg;
      state.overlayW = overlayImg.naturalWidth;
      state.overlayH = overlayImg.naturalHeight;
      els.canvas.width = state.overlayW;
      els.canvas.height = state.overlayH;
      
      const pv = obj.projectionValues || {};
      const H = state.overlayH, W = state.overlayW;
      function toPxBottomLeftNorm([nx, ny]) { return { x: nx * W, y: (1 - ny) * H }; }
      const tl = toPxBottomLeftNorm(pv.topLeft);
      const tr = toPxBottomLeftNorm(pv.topRight);
      const bl = toPxBottomLeftNorm(pv.bottomLeft);
      const br = toPxBottomLeftNorm(pv.bottomRight);
      state.quad = normalizeQuad([tl,tr,bl,br]);
      state.screenshotOnTop = !!obj.screenshotOnTop;
      state.cornerRadius = (pv.cornerRadius) || 0;
      
      updateEmptyState();
      updateActionStates();
      ctx.clearRect(0,0,state.overlayW,state.overlayH);
      ctx.drawImage(state.overlayImg, 0, 0);
      if (state.screenshotImg) doRender(true);
      setStatus('mlite loaded âœ“','success');
    };
    overlayImg.onerror = ()=> setError('Failed to decode overlay image');
    overlayImg.src = ovl;
  }catch(err){ 
    setError('Invalid JSON: ' + err.message); 
  }
  e.target.value = '';
});

// Import Screenshot
els.shot.addEventListener('change', (e)=>{
  if (!state.hasLicense) { 
    setStatus('Please activate your license first.','error'); 
    e.target.value=''; 
    return; 
  }
  const f = e.target.files[0]; 
  if (!f) return;
  const ext = (f.name.split('.').pop()||'').toLowerCase();
  if (ext==='heic'||ext==='heif'){ 
    setError('HEIC/HEIF not supported.'); 
    return; 
  }
  const img = new Image();
  img.onload = ()=>{ 
    state.screenshotImg = img;
    
    // If no quad exists, create default centered 512x512 quad
    if (!state.quad) {
      state.quad = createDefaultScreenshotQuad();
    }
    
    updateEmptyState(); 
    updateActionStates(); 
    if (state.overlayImg && state.quad) doRender(true); 
  };
  img.onerror = ()=> setError('Failed to load screenshot image.');
  img.src = URL.createObjectURL(f);
  e.target.value = '';
});

// Save mockup image
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  if (document.getElementById('saveBtn').disabled || !state.hasLicense) return;
  try{
    const blob = await new Promise(res => els.canvas.toBlob(res,'image/png'));
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = 'mockup.png'; 
    a.style.display='none';
    document.body.appendChild(a); 
    a.click();
    setTimeout(()=>{ 
      document.body.removeChild(a); 
      URL.revokeObjectURL(url); 
    }, 50);
    setStatus('Mockup image saved âœ“','success');
  }catch(err){ 
    setError('Save failed: ' + err.message); 
  }
});

function toBottomLeftNorm(pxPt){
  const nx = pxPt.x / state.overlayW;
  const ny_from_top = pxPt.y / state.overlayH;
  const ny_bottom_left = 1 - ny_from_top;
  return [nx, ny_bottom_left];
}

function buildCurrentMlitedoc(name = 'iP17Industrial', index = 0){
  if (!state.overlayImg || !state.quad) throw new Error('Nothing to export');

  const [TL, TR, BR, BL] = state.quad;

  // bottom-left normalised (matches iOS samples)
  function toBottomLeftNorm(pxPt){
    const nx = pxPt.x / state.overlayW;
    const ny_from_top = pxPt.y / state.overlayH;
    const ny_bottom_left = 1 - ny_from_top;
    return [nx, ny_bottom_left];
  }

  // Prefer an actual UUID if available
  const uuid = (self.crypto && crypto.randomUUID) 
    ? crypto.randomUUID() 
    : (Date.now().toString(16) + Math.random().toString(16).slice(2, 10)).toUpperCase();

  const doc = {
    // iOS-required keys
    id: uuid,
    customDeviceMockupBase64: state.originalOverlayBase64,
    index: index,
    projectionValues: {
      topLeft:      toBottomLeftNorm(TL),
      topRight:     toBottomLeftNorm(TR),
      bottomRight:  toBottomLeftNorm(BR),
      bottomLeft:   toBottomLeftNorm(BL),
      cornerRadius: Math.round(state.cornerRadius || 0) // ensure integer
    },
    name: name,
    screenshotOnTop: !!state.screenshotOnTop,
    isFavourite: false,
    supportsBackgrounds: false
  };

  // If your iOS importer is tolerant, you can keep these.
  // If not, DO NOT include them.
  // doc.version = 1;
  // doc.meta = { exportedAt: new Date().toISOString() };

  return doc;
}

function openNameModalLikePrompt(defaultName='My Mockup.mlite'){
  const name = prompt('Name your .mlite file', defaultName);
  if (!name) return;
  const finalName = name.endsWith('.mlite') ? name : name + '.mlite';
  try{
    const doc = buildCurrentMlitedoc();
    const blob = new Blob([JSON.stringify(doc,null,2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = finalName;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ document.body.removeChild(a); }, 50);
    setStatus('.mlite exported âœ“','success');
  }catch(err){ 
    setError('Export .mlite failed: ' + err.message); 
  }
}

els.exportMlBtn.addEventListener('click', ()=>{
  // Check 1: Not in edit mode
  if (state.editMode){
    setStatus('Finish editing before exporting .mlite','error');
    return;
  }
  
  // Check 2: Must have license
  if (!state.hasLicense){ 
    setStatus('Activate your license to export .mlite','error'); 
    return; 
  }
  
  // Check 3: Must have overlay and quad
  if (!state.overlayImg || !state.quad){ 
    setStatus('Load a Template PNG first to export .mlite','error');
    return; 
  }
  
  // Check 4: Must be a Template PNG (NEW CHECK!)
  if (state.sourceType !== 'template'){
    setStatus('Export .mlite only works with Template PNG imports','error');
    return;
  }
  
  // All checks passed - proceed with export
  openNameModalLikePrompt('My Mockup.mlite');
});

els.browse?.addEventListener("click", () => {
  if (!state.hasLicense) {
    setStatus("Activate your license to join the community", "error");
    return;
  }
  window.open("https://t.me/+MbrzOkWJcZRiMDg8", "_blank");
});

els.currentYear.textContent = new Date().getFullYear();

function boot(){
  checkExistingLicense();
  updateLicenseUI();
  updateActionStates();
  initMockupShowcase();
  setStatus('Ready to import files','idle');
}

boot();
</script>

</body>
</html>