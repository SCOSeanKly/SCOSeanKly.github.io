<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WallBoard Theme Manager</title>
    <script src="https://unpkg.com/aws4fetch@1.0.18/dist/aws4fetch.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #0a0e27;
            color: #e4e4e7;
            min-height: 100vh;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            padding: 30px 40px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .header p {
            color: #a5b4fc;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            border-bottom: 1px solid #27272a;
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #71717a;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #a5b4fc;
        }

        .tab.active {
            color: #818cf8;
            border-bottom-color: #818cf8;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #18181b;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 24px;
            border: 1px solid #27272a;
        }

        .section h2 {
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #a1a1aa;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            background: #09090b;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #e4e4e7;
            font-size: 14px;
            transition: all 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.1);
        }

        .file-input-wrapper {
            position: relative;
            width: 100%;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: #09090b;
            border: 2px dashed #3f3f46;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #71717a;
            font-size: 14px;
            -webkit-tap-highlight-color: rgba(129, 140, 248, 0.2);
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .file-input-label:hover {
            border-color: #818cf8;
            background: #18181b;
        }
        
        .file-input-label:active {
            transform: scale(0.98);
        }

        .file-input-label.has-file {
            border-style: solid;
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        input[type="file"] {
            display: none;
        }

        .preview {
            margin-top: 16px;
            display: none;
        }

        .preview.show {
            display: block;
        }

        .preview img {
            max-width: 200px;
            border-radius: 8px;
            border: 1px solid #27272a;
        }

        .preview-info {
            margin-top: 8px;
            font-size: 12px;
            color: #71717a;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #818cf8;
            color: #fff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #6366f1;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(129, 140, 248, 0.4);
        }

        .btn-danger {
            background: #dc2626;
            color: #fff;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }

        .btn-secondary {
            background: #27272a;
            color: #e4e4e7;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #3f3f46;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .output {
            margin-top: 20px;
            padding: 16px;
            background: #09090b;
            border-radius: 8px;
            color: #a1a1aa;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            border: 1px solid #27272a;
        }

        .output.show {
            display: block;
        }

        .output .success {
            color: #22c55e;
        }

        .output .error {
            color: #ef4444;
        }

        .output .info {
            color: #818cf8;
        }

        .progress {
            width: 100%;
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        .progress.show {
            display: block;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #818cf8 0%, #6366f1 100%);
            width: 0%;
            transition: width 0.3s;
        }

        #fontProgress {
            width: 100%;
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        #fontProgress.show {
            display: block;
        }

        #fontProgressBar {
            height: 100%;
            background: linear-gradient(90deg, #818cf8 0%, #6366f1 100%);
            width: 0%;
            transition: width 0.3s;
        }

        #fontOutput {
            margin-top: 20px;
            padding: 16px;
            background: #09090b;
            border-radius: 8px;
            color: #a1a1aa;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            border: 1px solid #27272a;
        }

        #fontOutput.show {
            display: block;
        }

        #fontOutput .success {
            color: #22c55e;
        }

        #fontOutput .error {
            color: #ef4444;
        }

        #fontOutput .info {
            color: #818cf8;
        }

        #weatherProgress {
            width: 100%;
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        #weatherProgress.show {
            display: block;
        }

        #weatherProgressBar {
            height: 100%;
            background: linear-gradient(90deg, #818cf8 0%, #6366f1 100%);
            width: 0%;
            transition: width 0.3s;
        }

        #weatherOutput {
            margin-top: 20px;
            padding: 16px;
            background: #09090b;
            border-radius: 8px;
            color: #a1a1aa;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            border: 1px solid #27272a;
        }

        #weatherOutput.show {
            display: block;
        }

        #weatherOutput .success {
            color: #22c55e;
        }

        #weatherOutput .error {
            color: #ef4444;
        }

        #weatherOutput .info {
            color: #818cf8;
        }

        #mergeWeatherOutput .success {
            color: #22c55e;
        }

        #mergeWeatherOutput .error {
            color: #ef4444;
        }

        #mergeWeatherOutput .info {
            color: #818cf8;
        }

        #versionOutput .success {
            color: #22c55e;
        }

        #versionOutput .error {
            color: #ef4444;
        }

        #versionOutput .info {
            color: #818cf8;
        }

        #newsOutput .success {
            color: #22c55e;
        }

        #newsOutput .error {
            color: #ef4444;
        }

        #newsOutput .info {
            color: #818cf8;
        }

        .news-item-card {
            background: #09090b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .news-item-card:hover {
            border-color: #3f3f46;
        }

        .news-item-card .news-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }

        .news-item-card .news-title {
            font-weight: 600;
            color: #fff;
            font-size: 15px;
        }

        .news-item-card .news-message {
            color: #a1a1aa;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .news-item-card .news-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 12px;
            color: #71717a;
        }

        .news-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .news-type-badge.update {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .news-type-badge.feature {
            background: rgba(129, 140, 248, 0.15);
            color: #a5b4fc;
        }

        .news-type-badge.announcement {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }

        .news-type-badge.alert {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .filename-preview {
            background: rgba(129, 140, 248, 0.1);
            border: 1px solid rgba(129, 140, 248, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            color: #a5b4fc;
        }

        .filename-preview strong {
            color: #818cf8;
        }

        .success-links {
            margin-top: 20px;
            padding: 16px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
        }

        .success-links h4 {
            color: #22c55e;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .success-links a {
            color: #4ade80;
            text-decoration: none;
            display: block;
            margin: 6px 0;
            font-size: 13px;
        }

        .success-links a:hover {
            text-decoration: underline;
        }

        .theme-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .theme-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
            position: relative;
        }

        .theme-card:hover {
            border-color: #818cf8;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .theme-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #09090b;
        }

        .theme-card-content {
            padding: 16px;
        }

        .theme-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .theme-card .author {
            font-size: 13px;
            color: #71717a;
            margin-bottom: 8px;
        }

        .theme-card .meta {
            font-size: 12px;
            color: #52525b;
            margin-bottom: 12px;
        }

        .theme-card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #71717a;
        }

        .spinner {
            border: 3px solid #27272a;
            border-top: 3px solid #818cf8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #71717a;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 12px;
            padding: 20px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #818cf8;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .modal-header p {
            color: #71717a;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .theme-gallery {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 20px;
            }
        }

        /* File Browser Styles */
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #09090b;
            border: 1px solid #27272a;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .file-item:hover {
            border-color: #818cf8;
            background: #18181b;
        }

        .file-item .file-icon {
            font-size: 24px;
            margin-right: 12px;
            width: 32px;
            text-align: center;
        }

        .file-item .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-item .file-name {
            color: #fff;
            font-weight: 500;
            word-break: break-all;
            margin-bottom: 4px;
        }

        .file-item .file-meta {
            font-size: 12px;
            color: #71717a;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .file-item .file-actions {
            display: flex;
            gap: 8px;
            margin-left: 12px;
        }

        .file-item .file-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 16px;
            background: #18181b;
            flex-shrink: 0;
        }

        .file-type-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 6px;
            color: #a1a1aa;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #818cf8;
            color: #fff;
        }

        .filter-btn.active {
            background: #818cf8;
            border-color: #818cf8;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® WallBoard Theme Manager</h1>
        <p>Professional theme management for WallBoard</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">üì§ Upload Theme</button>
            <button class="tab" onclick="switchTab('manage')">üóÇÔ∏è Manage Themes</button>
            <button class="tab" onclick="switchTab('fonts')">üî§ Manage Fonts</button>
            <button class="tab" onclick="switchTab('weather')">üå§Ô∏è Weather Icons</button>
            <button class="tab" onclick="switchTab('news')">üì∞ News</button>
            <button class="tab" onclick="switchTab('backup')">üíæ Backup & Restore</button>
            <button class="tab" onclick="switchTab('browse')">üìÇ Browse Files</button>
        </div>

        <div id="upload-tab" class="tab-content active">
            <div class="section">
                <h2>Theme Details</h2>
                
                <div class="form-group">
                    <label for="themeName">Theme Name *</label>
                    <input type="text" id="themeName" placeholder="e.g. Ocean Sunset" required>
                </div>

                <div class="form-group">
                    <label for="authorName">Author Name *</label>
                    <input type="text" id="authorName" placeholder="e.g. @YourHandle" required>
                </div>

                <div id="filenamePreview" class="filename-preview" style="display: none;">
                    <strong>Filename:</strong> <span id="filenameDisplay"></span>
                </div>
            </div>

            <div class="section">
                <h2>Files</h2>
                
                <div class="form-group">
                    <label>WallTheme File (.walltheme) *</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="themeFileLabel">
                            üì¶ Choose .walltheme file
                        </div>
                        <input type="file" id="themeFile" accept=".walltheme" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Preview Image (PNG, JPG) *</label>
                    <p style="font-size: 12px; color: #71717a; margin-bottom: 8px;">Images will be resized to max 1920px while preserving aspect ratio</p>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="imageFileLabel">
                            üñºÔ∏è Choose image file
                        </div>
                        <input type="file" id="imageFile" accept="image/*" required>
                    </div>
                    
                    <div class="preview" id="imagePreview">
                        <img id="previewImg" alt="Preview">
                        <div class="preview-info" id="previewInfo"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Upload</h2>
                <button class="btn btn-primary" id="uploadBtn" onclick="uploadToCloudflare()">
                    ‚òÅÔ∏è Upload to Cloudflare
                </button>

                <div class="progress" id="progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <div class="output" id="output"></div>

                <div id="successLinks" class="success-links" style="display: none;">
                    <h4>‚úÖ Successfully Uploaded!</h4>
                    <div id="linksList"></div>
                </div>
            </div>
        </div>

        <div id="manage-tab" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalThemes">0</div>
                    <div class="stat-label">Total Themes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDownloads">0</div>
                    <div class="stat-label">Total Downloads</div>
                </div>
            </div>

            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Theme Gallery</h2>
                    <button class="btn btn-secondary btn-sm" onclick="loadThemes()">
                        üîÑ Refresh
                    </button>
                </div>

                <div id="themeGallery">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading themes...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fonts Tab -->
        <div id="fonts-tab" class="tab-content">
            <div class="section">
                <h2>Current Font Package</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Download or replace the fonts.zip file used by WallBoard themes.</p>
                
                <div style="background: #09090b; border: 1px solid #27272a; border-radius: 8px; padding: 20px; margin-bottom: 20px;" id="fontInfo">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="font-size: 32px;">üì¶</div>
                        <div>
                            <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">fonts.zip</div>
                            <div style="font-size: 13px; color: #71717a;" id="fontFileSize">Loading...</div>
                        </div>
                    </div>
                    <a href="https://wallboard-themes.ske-d03.workers.dev/starter-assets/fonts/fonts.zip" 
                       class="btn btn-secondary" 
                       download
                       style="text-decoration: none;">
                        ‚¨áÔ∏è Download Current Fonts
                    </a>
                </div>
            </div>

            <div class="section">
                <h2>Upload New Font Package</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Replace the current fonts.zip with a new version. This will overwrite the existing file.</p>
                
                <div class="form-group">
                    <label>Font Package (.zip) *</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="fontFileLabel">
                            üì¶ Choose fonts.zip file
                        </div>
                        <input type="file" id="fontFile" accept=".zip" required>
                    </div>
                </div>

                <button class="btn btn-primary" id="uploadFontBtn" onclick="uploadFonts()">
                    ‚òÅÔ∏è Upload Font Package
                </button>

                <div class="progress" id="fontProgress">
                    <div class="progress-bar" id="fontProgressBar"></div>
                </div>

                <div class="output" id="fontOutput"></div>

                <div id="fontSuccessLinks" class="success-links" style="display: none;">
                    <h4>‚úÖ Successfully Uploaded!</h4>
                    <div id="fontLinksList"></div>
                </div>
            </div>
        </div>

        <!-- Weather Icons Tab -->
        <div id="weather-tab" class="tab-content">
            <div class="section">
                <h2>Current Weather Icons Package</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Download or replace the weathericons.zip file used by WallBoard themes.</p>
                
                <div style="background: #09090b; border: 1px solid #27272a; border-radius: 8px; padding: 20px; margin-bottom: 20px;" id="weatherInfo">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="font-size: 32px;">üå§Ô∏è</div>
                        <div>
                            <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">weathericons.zip</div>
                            <div style="font-size: 13px; color: #71717a;" id="weatherFileSize">Loading...</div>
                        </div>
                    </div>
                    <a href="https://wallboard-themes.ske-d03.workers.dev/starter-assets/weather-icons/weathericons.zip" 
                       class="btn btn-secondary" 
                       download
                       style="text-decoration: none;">
                        ‚¨áÔ∏è Download Current Weather Icons
                    </a>
                </div>
            </div>

            <div class="section">
                <h2>Upload New Weather Icons Package</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Replace the current weathericons.zip with a new version. This will overwrite the existing file.</p>
                
                <div class="form-group">
                    <label>Weather Icons Package (.zip) *</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="weatherFileLabel">
                            üå§Ô∏è Choose weathericons.zip file
                        </div>
                        <input type="file" id="weatherFile" accept=".zip" required>
                    </div>
                </div>

                <button class="btn btn-primary" id="uploadWeatherBtn" onclick="uploadWeatherIcons()">
                    ‚òÅÔ∏è Upload Weather Icons Package
                </button>

                <div class="progress" id="weatherProgress">
                    <div class="progress-bar" id="weatherProgressBar"></div>
                </div>

                <div class="output" id="weatherOutput"></div>

                <div id="weatherSuccessLinks" class="success-links" style="display: none;">
                    <h4>‚úÖ Successfully Uploaded!</h4>
                    <div id="weatherLinksList"></div>
                </div>
                </div>

            <div class="section">
                <h2>üìÇ Add Icon Pack to Archive</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Add a new icon pack folder directly into the existing weathericons.zip. Just select your folder and it will be merged in alongside the existing packs.</p>
                
                <div style="background: rgba(129, 140, 248, 0.08); border: 1px solid rgba(129, 140, 248, 0.25); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-size: 13px; color: #a5b4fc; line-height: 1.6;">
                        <strong>How it works:</strong><br>
                        1. Select your new icon pack folder<br>
                        2. Click "Merge Into Archive"<br>
                        3. The tool downloads the current archive, adds your folder alongside the existing packs, re-zips and uploads
                    </div>
                </div>

                <div class="form-group">
                    <label>New Icon Pack Folder *</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="mergeWeatherFolderLabel">
                            üìÇ Choose icon pack folder
                        </div>
                        <input type="file" id="mergeWeatherFolder" webkitdirectory directory multiple>
                    </div>
                </div>

                <div id="mergePreview" style="display: none; background: #09090b; border: 1px solid #27272a; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-weight: 600; color: #fff; margin-bottom: 8px;">üìã Folder to be added:</div>
                    <div id="mergePreviewList" style="font-size: 13px; color: #a1a1aa; font-family: 'SF Mono', Monaco, monospace;"></div>
                </div>

                <button class="btn btn-primary" id="mergeWeatherBtn" onclick="mergeWeatherIcons()" disabled>
                    üîÄ Merge Into Archive
                </button>

                <div id="mergeWeatherProgress" style="width: 100%; height: 4px; background: #27272a; border-radius: 2px; overflow: hidden; margin-top: 12px; display: none;">
                    <div id="mergeWeatherProgressBar" style="height: 100%; background: linear-gradient(90deg, #818cf8 0%, #6366f1 100%); width: 0%; transition: width 0.3s;"></div>
                </div>

                <div id="mergeWeatherOutput" style="margin-top: 20px; padding: 16px; background: #09090b; border-radius: 8px; color: #a1a1aa; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto; display: none; border: 1px solid #27272a;"></div>

                <div id="mergeWeatherSuccessLinks" class="success-links" style="display: none;">
                    <h4>‚úÖ Pack Successfully Merged!</h4>
                    <div id="mergeWeatherLinksList"></div>
                </div>
            </div>

            <div class="section">
                <h2>üìã Weather Icons Version</h2>
                <p style="color: #71717a; margin-bottom: 20px;">View and update the version.json that lives alongside weathericons.zip.</p>

                <div style="background: #09090b; border: 1px solid #27272a; border-radius: 8px; padding: 20px; margin-bottom: 20px;" id="versionInfo">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="font-size: 32px;">üìã</div>
                        <div>
                            <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">version.json</div>
                            <div style="font-size: 13px; color: #71717a;" id="versionCurrentInfo">Loading...</div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 0 0 120px;">
                        <label>Version</label>
                        <input type="text" id="versionNumber" placeholder="e.g. 2" style="text-align: center;">
                    </div>
                    <div class="form-group" style="flex: 0 0 200px;">
                        <label>Updated Date</label>
                        <input type="date" id="versionDate" style="width: 100%; padding: 12px 16px; background: #09090b; border: 1px solid #27272a; border-radius: 8px; color: #e4e4e7; font-size: 14px; color-scheme: dark;">
                    </div>
                </div>

                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="setVersionDateToday()">üìÖ Set Date to Today</button>
                    <button class="btn btn-secondary" onclick="incrementVersion()">‚¨ÜÔ∏è Increment Version</button>
                    <button class="btn btn-primary" id="saveVersionBtn" onclick="saveVersionJson()">üíæ Save version.json</button>
                </div>

                <div id="versionOutput" style="margin-top: 20px; padding: 16px; background: #09090b; border-radius: 8px; color: #a1a1aa; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto; display: none; border: 1px solid #27272a;"></div>
            </div>

            </div>
        </div>

        <!-- News Tab -->
        <div id="news-tab" class="tab-content">
            <div class="section">
                <h2>üì∞ Current News Items</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Manage the news.json feed shown in WallComposer. Items are sorted newest first.</p>

                <div id="newsListLoading" style="color: #71717a; padding: 20px; text-align: center;">Loading news items...</div>
                <div id="newsList"></div>
            </div>

            <div class="section">
                <h2>‚ûï Add News Item</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Create a new news item. The ID will be generated automatically from the date.</p>

                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="newsTitle" placeholder="e.g. New Weather Icon Packs Available">
                </div>

                <div class="form-group">
                    <label>Message *</label>
                    <textarea id="newsMessage" rows="3" placeholder="e.g. 5 new weather icon packs have been added..." style="width: 100%; padding: 12px 16px; background: #09090b; border: 1px solid #27272a; border-radius: 8px; color: #e4e4e7; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                </div>

                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 160px;">
                        <label>Type *</label>
                        <select id="newsType" style="width: 100%; padding: 12px 16px; background: #09090b; border: 1px solid #27272a; border-radius: 8px; color: #e4e4e7; font-size: 14px; color-scheme: dark;">
                            <option value="update">üîÑ Update</option>
                            <option value="feature">‚ú® Feature</option>
                            <option value="announcement">üì¢ Announcement</option>
                            <option value="alert">üö® Alert</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 160px;">
                        <label>Action URL (optional)</label>
                        <input type="text" id="newsActionURL" placeholder="https://...">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 160px;">
                        <label>Expiry Date (optional)</label>
                        <input type="date" id="newsExpiry" style="width: 100%; padding: 12px 16px; background: #09090b; border: 1px solid #27272a; border-radius: 8px; color: #e4e4e7; font-size: 14px; color-scheme: dark;">
                    </div>
                </div>

                <button class="btn btn-primary" id="addNewsBtn" onclick="addNewsItem()">
                    ‚ûï Add News Item
                </button>

                <div id="newsOutput" style="margin-top: 20px; padding: 16px; background: #09090b; border-radius: 8px; color: #a1a1aa; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto; display: none; border: 1px solid #27272a;"></div>
            </div>
        </div>

        <!-- Backup & Restore Tab -->
        <div id="backup-tab" class="tab-content">
            <div class="section">
                <h2>üíæ Backup All Themes</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Download a complete backup of all themes including the JSON manifest, all .walltheme files, and all preview images.</p>
                
                <div style="background: #09090b; border: 1px solid #27272a; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="font-size: 32px;">üì¶</div>
                        <div>
                            <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">Full Theme Backup</div>
                            <div style="font-size: 13px; color: #71717a;" id="backupInfo">Includes all themes, images, and metadata</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="backupBtn" onclick="downloadBackup()">
                        ‚¨áÔ∏è Download Full Backup
                    </button>
                </div>

                <div class="progress" id="backupProgress">
                    <div class="progress-bar" id="backupProgressBar"></div>
                </div>

                <div class="output" id="backupOutput"></div>
            </div>

            <div class="section">
                <h2>üîÑ Restore Themes</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Restore themes from a previously downloaded backup file. <strong style="color: #f59e0b;">Warning:</strong> This will replace all existing themes!</p>
                
                <div class="form-group">
                    <label>Backup File (.zip)</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="restoreFileLabel">
                            üì¶ Choose backup .zip file
                        </div>
                        <input type="file" id="restoreFile" accept=".zip">
                    </div>
                </div>

                <button class="btn btn-danger" id="restoreBtn" onclick="confirmRestore()">
                    üîÑ Restore from Backup
                </button>

                <div class="progress" id="restoreProgress">
                    <div class="progress-bar" id="restoreProgressBar"></div>
                </div>

                <div class="output" id="restoreOutput"></div>

                <div id="restoreSuccessLinks" class="success-links" style="display: none;">
                    <h4>‚úÖ Successfully Restored!</h4>
                    <div id="restoreLinksList"></div>
                </div>
            </div>
        </div>

        <!-- Browse Files Tab -->
        <div id="browse-tab" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìÇ R2 Bucket Directory Listing</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="checkFileIntegrity()">
                            üîç Find Errors
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="loadBucketFiles()">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                <p style="color: #71717a; margin-bottom: 20px;">Browse all files in the <code style="background: #27272a; padding: 2px 6px; border-radius: 4px;">wallboard-themes/content/</code> directory</p>
                
                <!-- Integrity Check Results -->
                <div id="integrityResults" style="display: none; margin-bottom: 20px;">
                </div>
                
                <div class="file-stats" style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="stat-card" style="flex: 1;">
                        <div class="stat-value" id="totalFiles">0</div>
                        <div class="stat-label">Total Files</div>
                    </div>
                    <div class="stat-card" style="flex: 1;">
                        <div class="stat-value" id="themeFiles">0</div>
                        <div class="stat-label">.walltheme Files</div>
                    </div>
                    <div class="stat-card" style="flex: 1;">
                        <div class="stat-value" id="imageFiles">0</div>
                        <div class="stat-label">Image Files</div>
                    </div>
                    <div class="stat-card" style="flex: 1;">
                        <div class="stat-value" id="totalSize">0 MB</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                </div>

                <div id="fileListContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading files...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Theme?</h3>
                <p>Are you sure you want to delete "<strong id="deleteThemeName"></strong>"? This action cannot be undone.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Update Theme File Modal -->
    <div id="updateThemeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Theme File</h3>
                <p>Replace the .walltheme file for "<strong id="updateThemeFileName"></strong>"</p>
            </div>
            <div class="form-group">
                <label>New Theme File (.walltheme)</label>
                <div class="file-input-wrapper">
                    <div class="file-input-label" id="updateThemeFileLabel">
                        üì¶ Choose .walltheme file
                    </div>
                    <input type="file" id="updateThemeFileInput" accept=".walltheme">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeUpdateThemeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmUpdateTheme()">Update Theme File</button>
            </div>
        </div>
    </div>

    <!-- Update Image Modal -->
    <div id="updateImageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Preview Image</h3>
                <p>Replace the preview image for "<strong id="updateImageThemeName"></strong>"</p>
            </div>
            <div class="form-group">
                <label>New Preview Image (PNG, JPG)</label>
                <p style="font-size: 12px; color: #71717a; margin-bottom: 8px;">Images will be resized to max 1920px while preserving aspect ratio</p>
                <div class="file-input-wrapper">
                    <div class="file-input-label" id="updateImageFileLabel">
                        üñºÔ∏è Choose image file
                    </div>
                    <input type="file" id="updateImageFileInput" accept="image/*">
                </div>
                <div class="preview" id="updateImagePreview" style="margin-top: 16px; display: none;">
                    <img id="updatePreviewImg" alt="Preview" style="max-width: 200px; border-radius: 8px; border: 1px solid #27272a;">
                    <div class="preview-info" id="updatePreviewInfo" style="margin-top: 8px; font-size: 12px; color: #71717a;"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeUpdateImageModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmUpdateImage()">Update Image</button>
            </div>
        </div>
    </div>

    <script>
        let processedImage = null;
        let currentThemeToDelete = null;
        let currentThemeToUpdate = null;
        let allThemesData = null;

        const R2_ENDPOINT = 'https://d030355118641a7dd9d7205bd27f54cc.r2.cloudflarestorage.com';
        const BUCKET_NAME = 'wallboard-themes';
        const PUBLIC_URL = 'https://pub-85cc5573fcfb4bbd82c88dc9c03cea02.r2.dev';
        const ACCESS_KEY = 'c39e72c04d401157382000503f0f8a3d';
        const SECRET_KEY = '147582f21b4e7149dfb4fa38da5f455bdf9c5bb60ff9057897bcaaea6e47cd50';

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => {
                if (t.onclick.toString().includes("'" + tab + "'")) {
                    t.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            if (tab === 'manage') {
                loadThemes();
            } else if (tab === 'fonts') {
                loadFontInfo();
            } else if (tab === 'weather') {
                loadWeatherInfo();
            } else if (tab === 'news') {
                loadNewsItems();
            } else if (tab === 'browse') {
                loadBucketFiles();
            }
        }

        function log(message, type) {
            type = type || 'info';
            const output = document.getElementById('output');
            output.classList.add('show');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateProgress(percent) {
            const progress = document.getElementById('progress');
            const bar = document.getElementById('progressBar');
            progress.classList.add('show');
            bar.style.width = percent + '%';
        }

        function resizeImage(file, maxDimension) {
            return new Promise(function(resolve, reject) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    
                    img.onload = function() {
                        // Calculate new dimensions while preserving aspect ratio
                        let newWidth = img.width;
                        let newHeight = img.height;
                        
                        // Only resize if image is larger than max dimension
                        if (img.width > maxDimension || img.height > maxDimension) {
                            if (img.width > img.height) {
                                newWidth = maxDimension;
                                newHeight = (img.height / img.width) * maxDimension;
                            } else {
                                newHeight = maxDimension;
                                newWidth = (img.width / img.height) * maxDimension;
                            }
                        }
                        
                        // Create canvas with new dimensions
                        const canvas = document.createElement('canvas');
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        const ctx = canvas.getContext('2d');

                        // Draw image at new size (no cropping, preserves aspect ratio)
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);

                        canvas.toBlob(
                            function(blob) {
                                if (blob) {
                                    resolve(blob);
                                } else {
                                    reject(new Error('Failed to create image blob'));
                                }
                            },
                            'image/png',
                            0.9
                        );
                    };

                    img.onerror = function() { reject(new Error('Failed to load image')); };
                    img.src = e.target.result;
                };

                reader.onerror = function() { reject(new Error('Failed to read file')); };
                reader.readAsDataURL(file);
            });
        }

        function waitForAwsClient() {
            return new Promise(function(resolve, reject) {
                if (typeof AwsClient !== 'undefined') {
                    resolve(AwsClient);
                    return;
                }
                if (typeof window.AwsClient !== 'undefined') {
                    resolve(window.AwsClient);
                    return;
                }
                if (typeof aws4fetch !== 'undefined') {
                    if (typeof aws4fetch.AwsClient !== 'undefined') {
                        resolve(aws4fetch.AwsClient);
                        return;
                    }
                    if (typeof aws4fetch === 'function') {
                        resolve(aws4fetch);
                        return;
                    }
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                const interval = setInterval(function() {
                    attempts++;
                    
                    let client = null;
                    if (typeof AwsClient !== 'undefined') {
                        client = AwsClient;
                    } else if (typeof window.AwsClient !== 'undefined') {
                        client = window.AwsClient;
                    } else if (typeof aws4fetch !== 'undefined') {
                        if (typeof aws4fetch.AwsClient !== 'undefined') {
                            client = aws4fetch.AwsClient;
                        } else if (typeof aws4fetch === 'function') {
                            client = aws4fetch;
                        }
                    }
                    
                    if (client) {
                        clearInterval(interval);
                        resolve(client);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        reject(new Error('AWS library failed to load.'));
                    }
                }, 100);
            });
        }

        async function uploadToCloudflare() {
            document.getElementById('output').innerHTML = '';
            document.getElementById('output').classList.remove('show');
            document.getElementById('progress').classList.remove('show');
            document.getElementById('successLinks').style.display = 'none';
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;

            try {
                log('‚è≥ Initializing...', 'info');
                const AwsClientClass = await waitForAwsClient();

                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                const themeName = document.getElementById('themeName').value.trim();
                const authorName = document.getElementById('authorName').value.trim();
                const themeFile = document.getElementById('themeFile').files[0];
                const imageFile = document.getElementById('imageFile').files[0];

                if (!themeName || !authorName || !themeFile || !imageFile) {
                    alert('Please fill in all required fields!');
                    uploadBtn.disabled = false;
                    return;
                }

                log('üöÄ Starting upload to Cloudflare R2...', 'info');
                updateProgress(5);

                const fileName = themeName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                log('üìù Generated filename: ' + fileName, 'info');
                updateProgress(10);

                log('üñºÔ∏è Processing image...', 'info');
                processedImage = await resizeImage(imageFile, 1920);
                log('‚úÖ Image processed (aspect ratio preserved)', 'success');
                updateProgress(20);

                log('üì• Fetching current wallthemes.json...', 'info');
                let jsonData = {
                    version: "1.0",
                    last_updated: new Date().toISOString(),
                    themes: []
                };
                
                try {
                    // Add cache busting to ensure we get the latest JSON
                    const jsonUrl = PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime();
                    const response = await fetch(jsonUrl, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (response.ok) {
                        const parsedJson = await response.json();
                        
                        console.log('Fetched JSON:', parsedJson);
                        console.log('Number of themes in JSON:', parsedJson.themes ? parsedJson.themes.length : 0);
                        
                        if (parsedJson && parsedJson.themes && Array.isArray(parsedJson.themes)) {
                            jsonData = parsedJson;
                            log('‚úÖ Found ' + jsonData.themes.length + ' existing themes', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Error fetching JSON:', error);
                    log('‚ö†Ô∏è Error fetching JSON, creating new one', 'info');
                }
                updateProgress(30);

                log('üì§ Uploading ' + fileName + '.walltheme...', 'info');
                const themeUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.walltheme';
                const themeResponse = await aws.fetch(themeUrl, {
                    method: 'PUT',
                    body: themeFile,
                    headers: { 'Content-Type': 'application/octet-stream' }
                });
                
                if (!themeResponse.ok) throw new Error('Failed to upload theme: ' + themeResponse.statusText);
                log('‚úÖ Theme file uploaded!', 'success');
                updateProgress(50);

                log('üì§ Uploading ' + fileName + '.png...', 'info');
                const imageUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.png';
                const imageResponse = await aws.fetch(imageUrl, {
                    method: 'PUT',
                    body: processedImage,
                    headers: { 'Content-Type': 'image/png' }
                });
                
                if (!imageResponse.ok) throw new Error('Failed to upload image: ' + imageResponse.statusText);
                log('‚úÖ Image uploaded!', 'success');
                updateProgress(70);

                const newTheme = {
                    name: themeName,
                    author: authorName,
                    thumbnail_url: PUBLIC_URL + '/content/' + fileName + '.png',
                    theme_url: PUBLIC_URL + '/content/' + fileName + '.walltheme',
                    created_date: new Date().toISOString(),
                    downloads: 0
                };

                console.log('Adding new theme:', newTheme);
                console.log('Current themes count before push:', jsonData.themes.length);
                
                jsonData.themes.push(newTheme);
                
                console.log('Current themes count after push:', jsonData.themes.length);
                console.log('All themes:', jsonData.themes.map(function(t) { return t.name; }));
                
                jsonData.last_updated = new Date().toISOString();
                
                log('üìù Updated themes list (now ' + jsonData.themes.length + ' themes)', 'info');
                updateProgress(80);

                log('üì§ Uploading updated wallthemes.json...', 'info');
                const jsonUploadUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/json/wallthemes.json';
                const jsonResponse = await aws.fetch(jsonUploadUrl, {
                    method: 'PUT',
                    body: JSON.stringify(jsonData, null, 2),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!jsonResponse.ok) throw new Error('Failed to upload JSON: ' + jsonResponse.statusText);
                log('‚úÖ JSON updated!', 'success');
                updateProgress(100);
                
                // Wait a moment for Cloudflare to propagate the changes
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });

                log('', 'info');
                log('‚ú® All done! Your theme is now live!', 'success');

                const linksDiv = document.getElementById('linksList');
                linksDiv.innerHTML = '<a href="' + PUBLIC_URL + '/content/' + fileName + '.walltheme" target="_blank">üîó Theme File</a>' +
                    '<a href="' + PUBLIC_URL + '/content/' + fileName + '.png" target="_blank">üîó Preview Image</a>' +
                    '<a href="' + PUBLIC_URL + '/json/wallthemes.json" target="_blank">üîó Updated JSON</a>';
                document.getElementById('successLinks').style.display = 'block';

                document.getElementById('themeName').value = '';
                document.getElementById('authorName').value = '';
                document.getElementById('themeFile').value = '';
                document.getElementById('imageFile').value = '';
                document.getElementById('themeFileLabel').textContent = 'üì¶ Choose .walltheme file';
                document.getElementById('themeFileLabel').classList.remove('has-file');
                document.getElementById('imageFileLabel').textContent = 'üñºÔ∏è Choose image file';
                document.getElementById('imageFileLabel').classList.remove('has-file');
                document.getElementById('imagePreview').classList.remove('show');
                document.getElementById('filenamePreview').style.display = 'none';

            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
                console.error('Full error:', error);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        async function loadThemes() {
            const gallery = document.getElementById('themeGallery');
            gallery.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading themes...</p></div>';

            try {
                // Add cache busting to get latest JSON
                const response = await fetch(PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime(), {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load themes');
                }

                const data = await response.json();
                const themes = data.themes || [];
                
                console.log('Loaded themes:', themes.length);
                console.log('Theme names:', themes.map(function(t) { return t.name; }));

                document.getElementById('totalThemes').textContent = themes.length;
                const totalDownloads = themes.reduce(function(sum, theme) { return sum + (theme.downloads || 0); }, 0);
                document.getElementById('totalDownloads').textContent = totalDownloads;

                if (themes.length === 0) {
                    gallery.innerHTML = '<div class="empty-state">' +
                        '<div class="empty-state-icon">üì¶</div>' +
                        '<h3>No themes yet</h3>' +
                        '<p>Upload your first theme to get started!</p>' +
                        '</div>';
                    return;
                }

                gallery.innerHTML = '<div class="theme-gallery"></div>';
                const galleryGrid = gallery.querySelector('.theme-gallery');

                themes.forEach(function(theme, index) {
                    const card = document.createElement('div');
                    card.className = 'theme-card';
                    
                    const date = new Date(theme.created_date);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });

                    card.innerHTML = '<img src="' + theme.thumbnail_url + '" alt="' + theme.name + '" onerror="this.src=\'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%2318181b%22 width=%22400%22 height=%22300%22/%3E%3Ctext fill=%22%2371717a%22 font-family=%22system-ui%22 font-size=%2218%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22%3ENo Image%3C/text%3E%3C/svg%3E\'">' +
                        '<div class="theme-card-content">' +
                        '<h3>' + theme.name + '</h3>' +
                        '<div class="author">' + theme.author + '</div>' +
                        '<div class="meta">üìÖ ' + formattedDate + ' ¬∑ üì• ' + (theme.downloads || 0) + ' downloads</div>' +
                        '<div class="theme-card-actions">' +
                        '<a href="' + theme.theme_url + '" class="btn btn-secondary btn-sm" target="_blank">‚¨áÔ∏è Download</a>' +
                        '<button class="btn btn-secondary btn-sm" onclick="updateThemeFile(' + index + ', \'' + theme.name + '\')">üìù Update Theme</button>' +
                        '</div>' +
                        '<div class="theme-card-actions" style="margin-top: 8px;">' +
                        '<button class="btn btn-secondary btn-sm" onclick="updateThemeImage(' + index + ', \'' + theme.name + '\')">üñºÔ∏è Update Image</button>' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteTheme(' + index + ', \'' + theme.name + '\')">üóëÔ∏è Delete</button>' +
                        '</div></div>';
                    
                    galleryGrid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading themes:', error);
                gallery.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-state-icon">‚ö†Ô∏è</div>' +
                    '<h3>Failed to load themes</h3>' +
                    '<p>' + error.message + '</p></div>';
            }
        }

        function deleteTheme(index, name) {
            currentThemeToDelete = index;
            document.getElementById('deleteThemeName').textContent = name;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            currentThemeToDelete = null;
        }

        function updateThemeFile(index, name) {
            currentThemeToUpdate = index;
            document.getElementById('updateThemeFileName').textContent = name;
            document.getElementById('updateThemeModal').classList.add('show');
        }

        function closeUpdateThemeModal() {
            document.getElementById('updateThemeModal').classList.remove('show');
            document.getElementById('updateThemeFileInput').value = '';
            document.getElementById('updateThemeFileLabel').textContent = 'üì¶ Choose .walltheme file';
            document.getElementById('updateThemeFileLabel').classList.remove('has-file');
            currentThemeToUpdate = null;
        }

        async function confirmUpdateTheme() {
            if (currentThemeToUpdate === null) return;

            const fileInput = document.getElementById('updateThemeFileInput');
            const newFile = fileInput.files[0];

            if (!newFile) {
                alert('Please select a .walltheme file!');
                return;
            }

            if (!newFile.name.toLowerCase().endsWith('.walltheme')) {
                alert('Please select a .walltheme file!');
                return;
            }

            try {
                const AwsClientClass = await waitForAwsClient();
                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                // Fetch current JSON
                const response = await fetch(PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime(), {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const jsonData = await response.json();
                
                const theme = jsonData.themes[currentThemeToUpdate];
                const fileName = theme.theme_url.split('/').pop().replace('.walltheme', '');

                // Upload new theme file
                const themeUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.walltheme';
                const themeResponse = await aws.fetch(themeUrl, {
                    method: 'PUT',
                    body: newFile,
                    headers: { 'Content-Type': 'application/octet-stream' }
                });

                if (!themeResponse.ok) throw new Error('Failed to upload theme file');

                closeUpdateThemeModal();
                alert('Theme file updated successfully!');

                // Wait for propagation
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });

            } catch (error) {
                alert('Failed to update theme file: ' + error.message);
                console.error('Update error:', error);
            }
        }

        function updateThemeImage(index, name) {
            currentThemeToUpdate = index;
            document.getElementById('updateImageThemeName').textContent = name;
            document.getElementById('updateImageModal').classList.add('show');
        }

        function closeUpdateImageModal() {
            document.getElementById('updateImageModal').classList.remove('show');
            document.getElementById('updateImageFileInput').value = '';
            document.getElementById('updateImageFileLabel').textContent = 'üñºÔ∏è Choose image file';
            document.getElementById('updateImageFileLabel').classList.remove('has-file');
            document.getElementById('updateImagePreview').style.display = 'none';
            currentThemeToUpdate = null;
        }

        async function confirmUpdateImage() {
            if (currentThemeToUpdate === null) return;

            const fileInput = document.getElementById('updateImageFileInput');
            const newFile = fileInput.files[0];

            if (!newFile) {
                alert('Please select an image file!');
                return;
            }

            try {
                const AwsClientClass = await waitForAwsClient();
                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                // Fetch current JSON
                const response = await fetch(PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime(), {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const jsonData = await response.json();
                
                const theme = jsonData.themes[currentThemeToUpdate];
                const fileName = theme.thumbnail_url.split('/').pop().replace('.png', '');

                // Process and resize image
                const processedImg = await resizeImage(newFile, 1920);

                // Upload new image
                const imageUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.png';
                const imageResponse = await aws.fetch(imageUrl, {
                    method: 'PUT',
                    body: processedImg,
                    headers: { 'Content-Type': 'image/png' }
                });

                if (!imageResponse.ok) throw new Error('Failed to upload image');

                closeUpdateImageModal();
                alert('Image updated successfully!');

                // Wait for propagation then reload gallery
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });
                loadThemes();

            } catch (error) {
                alert('Failed to update image: ' + error.message);
                console.error('Update error:', error);
            }
        }

        async function confirmDelete() {
            if (currentThemeToDelete === null) return;

            try {
                const AwsClientClass = await waitForAwsClient();
                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                // Fetch with cache busting
                const response = await fetch(PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime(), {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const jsonData = await response.json();
                
                console.log('Deleting theme at index:', currentThemeToDelete);
                console.log('Total themes before delete:', jsonData.themes.length);
                
                const themeToDelete = jsonData.themes[currentThemeToDelete];
                const fileName = themeToDelete.theme_url.split('/').pop().replace('.walltheme', '');

                await aws.fetch(R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.walltheme', {
                    method: 'DELETE'
                });

                await aws.fetch(R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.png', {
                    method: 'DELETE'
                });

                jsonData.themes.splice(currentThemeToDelete, 1);
                jsonData.last_updated = new Date().toISOString();
                
                console.log('Total themes after delete:', jsonData.themes.length);
                console.log('Remaining themes:', jsonData.themes.map(function(t) { return t.name; }));

                await aws.fetch(R2_ENDPOINT + '/' + BUCKET_NAME + '/json/wallthemes.json', {
                    method: 'PUT',
                    body: JSON.stringify(jsonData, null, 2),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                // Wait for Cloudflare to propagate
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });

                closeDeleteModal();
                loadThemes();

            } catch (error) {
                alert('Failed to delete theme: ' + error.message);
                console.error('Delete error:', error);
            }
        }

        async function loadFontInfo() {
            try {
                const response = await fetch('https://wallboard-themes.ske-d03.workers.dev/starter-assets/fonts/fonts.zip', {
                    method: 'HEAD'
                });
                
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    const lastModified = response.headers.get('last-modified');
                    
                    let sizeText = 'Unknown size';
                    if (size) {
                        const sizeMB = (parseInt(size) / (1024 * 1024)).toFixed(2);
                        sizeText = sizeMB + ' MB';
                    }
                    
                    let dateText = '';
                    if (lastModified) {
                        const date = new Date(lastModified);
                        dateText = ' ‚Ä¢ Updated ' + date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    }
                    
                    document.getElementById('fontFileSize').textContent = sizeText + dateText;
                } else {
                    document.getElementById('fontFileSize').textContent = 'File not found';
                }
            } catch (error) {
                console.error('Error loading font info:', error);
                document.getElementById('fontFileSize').textContent = 'Error loading info';
            }
        }

        async function loadWeatherInfo() {
            try {
                const response = await fetch('https://wallboard-themes.ske-d03.workers.dev/starter-assets/weather-icons/weathericons.zip', {
                    method: 'HEAD'
                });
                
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    const lastModified = response.headers.get('last-modified');
                    
                    let sizeText = 'Unknown size';
                    if (size) {
                        const sizeMB = (parseInt(size) / (1024 * 1024)).toFixed(2);
                        sizeText = sizeMB + ' MB';
                    }
                    
                    let dateText = '';
                    if (lastModified) {
                        const date = new Date(lastModified);
                        dateText = ' ‚Ä¢ Updated ' + date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    }
                    
                    document.getElementById('weatherFileSize').textContent = sizeText + dateText;
                } else {
                    document.getElementById('weatherFileSize').textContent = 'File not found';
                }
            } catch (error) {
                console.error('Error loading weather info:', error);
                document.getElementById('weatherFileSize').textContent = 'Error loading info';
            }
            loadVersionJson();
        }

        async function loadVersionJson() {
            try {
                var response = await fetch('https://wallboard-themes.ske-d03.workers.dev/starter-assets/weather-icons/version.json?t=' + Date.now());
                if (response.ok) {
                    var data = await response.json();
                    document.getElementById('versionNumber').value = data.version || '';
                    document.getElementById('versionDate').value = data.updated || '';
                    document.getElementById('versionCurrentInfo').textContent = 'Version ' + data.version + ' ‚Ä¢ Updated ' + data.updated;
                } else {
                    document.getElementById('versionCurrentInfo').textContent = 'File not found ‚Äî save to create it';
                    document.getElementById('versionNumber').value = '1';
                    setVersionDateToday();
                }
            } catch (error) {
                console.error('Error loading version.json:', error);
                document.getElementById('versionCurrentInfo').textContent = 'Error loading ‚Äî save to create it';
                document.getElementById('versionNumber').value = '1';
                setVersionDateToday();
            }
        }

        function setVersionDateToday() {
            var today = new Date();
            var yyyy = today.getFullYear();
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('versionDate').value = yyyy + '-' + mm + '-' + dd;
        }

        function incrementVersion() {
            var input = document.getElementById('versionNumber');
            var current = parseInt(input.value) || 0;
            input.value = current + 1;
        }

        function versionLog(message, type) {
            type = type || 'info';
            var output = document.getElementById('versionOutput');
            output.style.display = 'block';
            var className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        async function saveVersionJson() {
            var output = document.getElementById('versionOutput');
            output.innerHTML = '';
            output.style.display = 'none';

            var version = document.getElementById('versionNumber').value.trim();
            var updated = document.getElementById('versionDate').value.trim();

            if (!version) { alert('Please enter a version number!'); return; }
            if (!updated) { alert('Please enter an updated date!'); return; }

            var saveBtn = document.getElementById('saveVersionBtn');
            saveBtn.disabled = true;

            try {
                versionLog('‚è≥ Initializing...', 'info');
                var AwsClientClass = await waitForAwsClient();
                var aws = new AwsClientClass({ accessKeyId: ACCESS_KEY, secretAccessKey: SECRET_KEY, service: 's3', region: 'auto' });

                var versionValue = isNaN(version) ? version : parseInt(version);
                var jsonData = JSON.stringify({ version: versionValue, updated: updated }, null, 2);

                versionLog('üì§ Uploading version.json...', 'info');
                var uploadUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/starter-assets/weather-icons/version.json';
                var uploadResponse = await aws.fetch(uploadUrl, {
                    method: 'PUT',
                    body: jsonData,
                    headers: { 'Content-Type': 'application/json', 'Cache-Control': 'public, max-age=60' }
                });
                if (!uploadResponse.ok) throw new Error('Failed to upload version.json: ' + uploadResponse.statusText);
                versionLog('‚úÖ version.json saved! Version ' + versionValue + ' ‚Ä¢ Updated ' + updated, 'success');
                document.getElementById('versionCurrentInfo').textContent = 'Version ' + versionValue + ' ‚Ä¢ Updated ' + updated;
            } catch (error) {
                versionLog('‚ùå Error: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
            }
        }

        function fontLog(message, type) {
            type = type || 'info';
            const output = document.getElementById('fontOutput');
            output.classList.add('show');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateFontProgress(percent) {
            const progress = document.getElementById('fontProgress');
            const bar = document.getElementById('fontProgressBar');
            progress.classList.add('show');
            bar.style.width = percent + '%';
        }

        function weatherLog(message, type) {
            type = type || 'info';
            const output = document.getElementById('weatherOutput');
            output.classList.add('show');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateWeatherProgress(percent) {
            const progress = document.getElementById('weatherProgress');
            const bar = document.getElementById('weatherProgressBar');
            progress.classList.add('show');
            bar.style.width = percent + '%';
        }

        async function uploadFonts() {
            document.getElementById('fontOutput').innerHTML = '';
            document.getElementById('fontOutput').classList.remove('show');
            document.getElementById('fontProgress').classList.remove('show');
            document.getElementById('fontSuccessLinks').style.display = 'none';
            
            const uploadBtn = document.getElementById('uploadFontBtn');
            uploadBtn.disabled = true;

            try {
                fontLog('‚è≥ Initializing...', 'info');
                const AwsClientClass = await waitForAwsClient();

                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                const fontFile = document.getElementById('fontFile').files[0];

                if (!fontFile) {
                    alert('Please select a fonts.zip file!');
                    uploadBtn.disabled = false;
                    return;
                }

                if (!fontFile.name.toLowerCase().endsWith('.zip')) {
                    alert('Please select a .zip file!');
                    uploadBtn.disabled = false;
                    return;
                }

                fontLog('üöÄ Starting upload to Cloudflare R2...', 'info');
                updateFontProgress(10);

                const sizeMB = (fontFile.size / (1024 * 1024)).toFixed(2);
                fontLog('üì¶ File size: ' + sizeMB + ' MB', 'info');
                updateFontProgress(30);

                fontLog('üì§ Uploading fonts.zip...', 'info');
                const fontUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/starter-assets/fonts/fonts.zip';
                const fontResponse = await aws.fetch(fontUrl, {
                    method: 'PUT',
                    body: fontFile,
                    headers: { 
                        'Content-Type': 'application/zip',
                        'Cache-Control': 'public, max-age=3600'
                    }
                });
                
                if (!fontResponse.ok) throw new Error('Failed to upload fonts: ' + fontResponse.statusText);
                fontLog('‚úÖ Font package uploaded!', 'success');
                updateFontProgress(90);

                // Wait for Cloudflare to propagate
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });
                
                updateFontProgress(100);

                fontLog('', 'info');
                fontLog('‚ú® All done! Font package is now live!', 'success');

                const linksDiv = document.getElementById('fontLinksList');
                linksDiv.innerHTML = '<a href="https://wallboard-themes.ske-d03.workers.dev/starter-assets/fonts/fonts.zip" target="_blank">üîó Download Updated Fonts</a>';
                document.getElementById('fontSuccessLinks').style.display = 'block';

                // Reset form
                document.getElementById('fontFile').value = '';
                document.getElementById('fontFileLabel').textContent = 'üì¶ Choose fonts.zip file';
                document.getElementById('fontFileLabel').classList.remove('has-file');

                // Reload font info
                setTimeout(loadFontInfo, 2000);

            } catch (error) {
                fontLog('‚ùå Error: ' + error.message, 'error');
                console.error('Full error:', error);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        async function uploadWeatherIcons() {
            document.getElementById('weatherOutput').innerHTML = '';
            document.getElementById('weatherOutput').classList.remove('show');
            document.getElementById('weatherProgress').classList.remove('show');
            document.getElementById('weatherSuccessLinks').style.display = 'none';
            
            const uploadBtn = document.getElementById('uploadWeatherBtn');
            uploadBtn.disabled = true;

            try {
                weatherLog('‚è≥ Initializing...', 'info');
                const AwsClientClass = await waitForAwsClient();

                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                const weatherFile = document.getElementById('weatherFile').files[0];

                if (!weatherFile) {
                    alert('Please select a weathericons.zip file!');
                    uploadBtn.disabled = false;
                    return;
                }

                if (!weatherFile.name.toLowerCase().endsWith('.zip')) {
                    alert('Please select a .zip file!');
                    uploadBtn.disabled = false;
                    return;
                }

                weatherLog('üöÄ Starting upload to Cloudflare R2...', 'info');
                updateWeatherProgress(10);

                const sizeMB = (weatherFile.size / (1024 * 1024)).toFixed(2);
                weatherLog('üì¶ File size: ' + sizeMB + ' MB', 'info');
                updateWeatherProgress(30);

                weatherLog('üì§ Uploading weathericons.zip...', 'info');
                const weatherUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/starter-assets/weather-icons/weathericons.zip';
                const weatherResponse = await aws.fetch(weatherUrl, {
                    method: 'PUT',
                    body: weatherFile,
                    headers: { 
                        'Content-Type': 'application/zip',
                        'Cache-Control': 'public, max-age=3600'
                    }
                });
                
                if (!weatherResponse.ok) throw new Error('Failed to upload weather icons: ' + weatherResponse.statusText);
                weatherLog('‚úÖ Weather icons package uploaded!', 'success');
                updateWeatherProgress(90);

                // Wait for Cloudflare to propagate
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });
                
                updateWeatherProgress(100);

                weatherLog('', 'info');
                weatherLog('‚ú® All done! Weather icons package is now live!', 'success');

                const linksDiv = document.getElementById('weatherLinksList');
                linksDiv.innerHTML = '<a href="https://wallboard-themes.ske-d03.workers.dev/starter-assets/weather-icons/weathericons.zip" target="_blank">üîó Download Updated Weather Icons</a>';
                document.getElementById('weatherSuccessLinks').style.display = 'block';

                // Reset form
                document.getElementById('weatherFile').value = '';
                document.getElementById('weatherFileLabel').textContent = 'üå§Ô∏è Choose weathericons.zip file';
                document.getElementById('weatherFileLabel').classList.remove('has-file');

                // Reload weather info
                setTimeout(loadWeatherInfo, 2000);

            } catch (error) {
                weatherLog('‚ùå Error: ' + error.message, 'error');
                console.error('Full error:', error);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // ==================== MERGE WEATHER ICON PACK ====================

        function mergeLog(message, type) {
            type = type || 'info';
            var output = document.getElementById('mergeWeatherOutput');
            output.classList.add('show');
            output.innerHTML += '<span class="' + type + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateMergeProgress(percent) {
            var progress = document.getElementById('mergeWeatherProgress');
            var bar = document.getElementById('mergeWeatherProgressBar');
            progress.style.display = 'block';
            bar.style.width = percent + '%';
        }

        var pendingMergeFiles = null;
        var pendingMergeFolderName = null;

        async function mergeWeatherIcons() {
            var output = document.getElementById('mergeWeatherOutput');
            output.innerHTML = '';
            output.classList.remove('show');
            document.getElementById('mergeWeatherProgress').style.display = 'none';
            document.getElementById('mergeWeatherSuccessLinks').style.display = 'none';

            var mergeBtn = document.getElementById('mergeWeatherBtn');
            mergeBtn.disabled = true;

            try {
                if (!pendingMergeFiles || pendingMergeFiles.length === 0) {
                    alert('Please select a folder first!');
                    mergeBtn.disabled = false;
                    return;
                }

                mergeLog('‚è≥ Initializing...', 'info');
                var AwsClientClass = await waitForAwsClient();
                var aws = new AwsClientClass({ accessKeyId: ACCESS_KEY, secretAccessKey: SECRET_KEY, service: 's3', region: 'auto' });

                mergeLog('üì• Downloading current weathericons.zip from R2...', 'info');
                updateMergeProgress(10);

                var existingResponse = await fetch('https://wallboard-themes.ske-d03.workers.dev/starter-assets/weather-icons/weathericons.zip');
                if (!existingResponse.ok) throw new Error('Failed to download existing weather icons: ' + existingResponse.statusText);
                var existingBlob = await existingResponse.blob();
                mergeLog('‚úÖ Downloaded existing archive (' + (existingBlob.size / (1024 * 1024)).toFixed(2) + ' MB)', 'success');
                updateMergeProgress(25);

                mergeLog('üì¶ Reading existing archive...', 'info');
                var existingZip = await JSZip.loadAsync(existingBlob);
                var existingFolders = [];
                existingZip.forEach(function(relativePath) {
                    var topLevel = relativePath.split('/')[0];
                    if (existingFolders.indexOf(topLevel) === -1 && topLevel !== '' && topLevel !== '__MACOSX') {
                        existingFolders.push(topLevel);
                    }
                });
                mergeLog('üìÅ Existing packs (' + existingFolders.length + '): ' + existingFolders.sort().join(', '), 'info');
                updateMergeProgress(40);

                var folderName = pendingMergeFolderName;
                if (existingFolders.indexOf(folderName) !== -1) {
                    if (!confirm('A pack called "' + folderName + '" already exists.\n\nOverwrite it?')) {
                        mergeLog('‚ùå Merge cancelled.', 'error');
                        mergeBtn.disabled = false;
                        return;
                    }
                    mergeLog('‚ö†Ô∏è Overwriting existing pack: ' + folderName, 'info');
                }

                mergeLog('üîÄ Adding "' + folderName + '" to archive...', 'info');
                updateMergeProgress(50);

                var fileCount = 0;
                var files = pendingMergeFiles;
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    var relativePath = file.webkitRelativePath;
                    if (relativePath.includes('__MACOSX') || relativePath.includes('.DS_Store')) continue;
                    existingZip.file(relativePath, await file.arrayBuffer());
                    fileCount++;
                    if (fileCount % 20 === 0) updateMergeProgress(50 + Math.round((i / files.length) * 15));
                }

                mergeLog('‚úÖ Added ' + fileCount + ' files from "' + folderName + '"', 'success');
                updateMergeProgress(65);

                mergeLog('üì¶ Generating combined archive...', 'info');
                var combinedBlob = await existingZip.generateAsync({
                    type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 }
                }, function(metadata) { updateMergeProgress(65 + Math.round(metadata.percent * 0.2)); });

                mergeLog('‚úÖ Combined archive (' + (combinedBlob.size / (1024 * 1024)).toFixed(2) + ' MB)', 'success');
                updateMergeProgress(85);

                mergeLog('üì§ Uploading merged weathericons.zip...', 'info');
                var uploadResponse = await aws.fetch(R2_ENDPOINT + '/' + BUCKET_NAME + '/starter-assets/weather-icons/weathericons.zip', {
                    method: 'PUT', body: combinedBlob,
                    headers: { 'Content-Type': 'application/zip', 'Cache-Control': 'public, max-age=3600' }
                });
                if (!uploadResponse.ok) throw new Error('Failed to upload: ' + uploadResponse.statusText);
                updateMergeProgress(100);

                var finalFolders = [];
                existingZip.forEach(function(relativePath) {
                    var topLevel = relativePath.split('/')[0];
                    if (finalFolders.indexOf(topLevel) === -1 && topLevel !== '' && topLevel !== '__MACOSX') finalFolders.push(topLevel);
                });

                mergeLog('', 'info');
                mergeLog('‚ú® Done! Archive now contains ' + finalFolders.length + ' packs:', 'success');
                mergeLog('üìã ' + finalFolders.sort().join(', '), 'info');

                document.getElementById('mergeWeatherLinksList').innerHTML = '<a href="https://wallboard-themes.ske-d03.workers.dev/starter-assets/weather-icons/weathericons.zip" target="_blank">üîó Download Updated Weather Icons</a>';
                document.getElementById('mergeWeatherSuccessLinks').style.display = 'block';

                document.getElementById('mergeWeatherFolder').value = '';
                document.getElementById('mergeWeatherFolderLabel').textContent = 'üìÇ Choose icon pack folder';
                document.getElementById('mergeWeatherFolderLabel').classList.remove('has-file');
                document.getElementById('mergePreview').style.display = 'none';
                pendingMergeFiles = null;
                pendingMergeFolderName = null;

                incrementVersion();
                setVersionDateToday();
                mergeLog('', 'info');
                mergeLog('üí° Version bumped to ' + document.getElementById('versionNumber').value + ' and date set to today ‚Äî remember to save version.json!', 'info');

                setTimeout(loadWeatherInfo, 2000);
            } catch (error) {
                mergeLog('‚ùå Error: ' + error.message, 'error');
                console.error('Full error:', error);
            } finally {
                mergeBtn.disabled = false;
            }
        }

        // ==================== NEWS MANAGEMENT ====================

        var currentNewsData = [];
        var NEWS_URL = 'https://wallboard-themes.ske-d03.workers.dev/json/news.json';
        var NEWS_R2_PATH = '/json/news.json';

        function newsLog(message, type) {
            type = type || 'info';
            var output = document.getElementById('newsOutput');
            output.style.display = 'block';
            var className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        async function loadNewsItems() {
            var listDiv = document.getElementById('newsList');
            var loadingDiv = document.getElementById('newsListLoading');
            loadingDiv.style.display = 'block';
            listDiv.innerHTML = '';

            try {
                var response = await fetch(NEWS_URL + '?t=' + Date.now());
                if (!response.ok) throw new Error('Failed to fetch news.json: ' + response.statusText);
                currentNewsData = await response.json();

                loadingDiv.style.display = 'none';

                if (currentNewsData.length === 0) {
                    listDiv.innerHTML = '<div style="color: #71717a; padding: 20px; text-align: center;">No news items yet.</div>';
                    return;
                }

                // Sort newest first
                currentNewsData.sort(function(a, b) {
                    return new Date(b.date) - new Date(a.date);
                });

                var html = '';
                currentNewsData.forEach(function(item, index) {
                    var date = new Date(item.date);
                    var dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                    var expiryStr = '';
                    if (item.expiryDate) {
                        var expiry = new Date(item.expiryDate);
                        var isExpired = expiry < new Date();
                        expiryStr = '<span style="color: ' + (isExpired ? '#ef4444' : '#71717a') + ';">' +
                            (isExpired ? '‚ö†Ô∏è Expired' : '‚è≥ Expires') + ' ' +
                            expiry.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) + '</span>';
                    }

                    html += '<div class="news-item-card">' +
                        '<div class="news-header">' +
                            '<div>' +
                                '<span class="news-type-badge ' + (item.type || 'update') + '">' + (item.type || 'update') + '</span>' +
                                ' <span class="news-title">' + escapeHtml(item.title) + '</span>' +
                            '</div>' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteNewsItem(\'' + item.id + '\')" style="padding: 6px 12px; font-size: 12px; flex-shrink: 0;">üóëÔ∏è Delete</button>' +
                        '</div>' +
                        '<div class="news-message">' + escapeHtml(item.message) + '</div>' +
                        '<div class="news-meta">' +
                            '<span>üìÖ ' + dateStr + '</span>' +
                            (item.actionURL ? '<span>üîó <a href="' + escapeHtml(item.actionURL) + '" target="_blank" style="color: #818cf8;">' + escapeHtml(item.actionURL) + '</a></span>' : '') +
                            (expiryStr ? expiryStr : '') +
                            '<span style="color: #52525b; font-family: monospace; font-size: 11px;">' + escapeHtml(item.id) + '</span>' +
                        '</div>' +
                    '</div>';
                });

                listDiv.innerHTML = html;
            } catch (error) {
                loadingDiv.style.display = 'none';
                listDiv.innerHTML = '<div style="color: #ef4444; padding: 20px; text-align: center;">Error loading news: ' + error.message + '</div>';
                console.error('Error loading news:', error);
            }
        }

        async function saveNewsToR2(newsArray) {
            var AwsClientClass = await waitForAwsClient();
            var aws = new AwsClientClass({ accessKeyId: ACCESS_KEY, secretAccessKey: SECRET_KEY, service: 's3', region: 'auto' });

            var jsonData = JSON.stringify(newsArray, null, 2);
            var uploadUrl = R2_ENDPOINT + '/' + BUCKET_NAME + NEWS_R2_PATH;
            var response = await aws.fetch(uploadUrl, {
                method: 'PUT',
                body: jsonData,
                headers: { 'Content-Type': 'application/json', 'Cache-Control': 'public, max-age=60' }
            });
            if (!response.ok) throw new Error('Failed to save news.json: ' + response.statusText);
        }

        async function deleteNewsItem(id) {
            if (!confirm('Delete this news item?')) return;

            try {
                var filtered = currentNewsData.filter(function(item) { return item.id !== id; });
                await saveNewsToR2(filtered);
                currentNewsData = filtered;
                loadNewsItems();
            } catch (error) {
                alert('Error deleting news item: ' + error.message);
                console.error(error);
            }
        }

        async function addNewsItem() {
            var output = document.getElementById('newsOutput');
            output.innerHTML = '';
            output.style.display = 'none';

            var title = document.getElementById('newsTitle').value.trim();
            var message = document.getElementById('newsMessage').value.trim();
            var type = document.getElementById('newsType').value;
            var actionURL = document.getElementById('newsActionURL').value.trim() || null;
            var expiry = document.getElementById('newsExpiry').value;

            if (!title) { alert('Please enter a title!'); return; }
            if (!message) { alert('Please enter a message!'); return; }

            var addBtn = document.getElementById('addNewsBtn');
            addBtn.disabled = true;

            try {
                newsLog('‚è≥ Saving news item...', 'info');

                // Generate ID from current date
                var now = new Date();
                var dateStr = now.getFullYear() + '-' +
                    String(now.getMonth() + 1).padStart(2, '0') + '-' +
                    String(now.getDate()).padStart(2, '0');

                // Find next available sequence number for today
                var seq = 1;
                currentNewsData.forEach(function(item) {
                    if (item.id && item.id.startsWith('news-' + dateStr)) {
                        var parts = item.id.split('-');
                        var existing = parseInt(parts[parts.length - 1]);
                        if (existing >= seq) seq = existing + 1;
                    }
                });

                var newItem = {
                    id: 'news-' + dateStr + '-' + String(seq).padStart(3, '0'),
                    title: title,
                    message: message,
                    date: now.toISOString(),
                    type: type,
                    actionURL: actionURL,
                    expiryDate: expiry ? new Date(expiry + 'T00:00:00Z').toISOString() : null
                };

                currentNewsData.unshift(newItem);
                await saveNewsToR2(currentNewsData);

                newsLog('‚úÖ News item added: ' + newItem.id, 'success');

                // Reset form
                document.getElementById('newsTitle').value = '';
                document.getElementById('newsMessage').value = '';
                document.getElementById('newsType').value = 'update';
                document.getElementById('newsActionURL').value = '';
                document.getElementById('newsExpiry').value = '';

                loadNewsItems();
            } catch (error) {
                newsLog('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            } finally {
                addBtn.disabled = false;
            }
        }

        // ==================== BACKUP & RESTORE FUNCTIONS ====================

        function backupLog(message, type) {
            type = type || 'info';
            const output = document.getElementById('backupOutput');
            output.classList.add('show');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateBackupProgress(percent) {
            const progress = document.getElementById('backupProgress');
            const bar = document.getElementById('backupProgressBar');
            progress.classList.add('show');
            bar.style.width = percent + '%';
        }

        function restoreLog(message, type) {
            type = type || 'info';
            const output = document.getElementById('restoreOutput');
            output.classList.add('show');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateRestoreProgress(percent) {
            const progress = document.getElementById('restoreProgress');
            const bar = document.getElementById('restoreProgressBar');
            progress.classList.add('show');
            bar.style.width = percent + '%';
        }

        async function downloadBackup() {
            const backupBtn = document.getElementById('backupBtn');
            backupBtn.disabled = true;
            document.getElementById('backupOutput').innerHTML = '';
            document.getElementById('backupOutput').classList.remove('show');
            document.getElementById('backupProgress').classList.remove('show');

            try {
                backupLog('‚è≥ Starting backup...', 'info');
                updateBackupProgress(5);

                // Fetch the themes JSON
                backupLog('üì• Fetching themes manifest...', 'info');
                const jsonUrl = PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime();
                const response = await fetch(jsonUrl, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch themes JSON');
                }

                const jsonData = await response.json();
                const themes = jsonData.themes || [];
                backupLog('‚úÖ Found ' + themes.length + ' themes to backup', 'success');
                updateBackupProgress(10);

                if (themes.length === 0) {
                    backupLog('‚ö†Ô∏è No themes to backup!', 'error');
                    backupBtn.disabled = false;
                    return;
                }

                // Create a new ZIP
                const zip = new JSZip();
                
                // Add the JSON file
                zip.file('wallthemes.json', JSON.stringify(jsonData, null, 2));
                backupLog('üì¶ Added wallthemes.json to backup', 'info');

                // Create folders
                const contentFolder = zip.folder('content');

                // Download and add each theme file and image
                const totalFiles = themes.length * 2; // Each theme has a .walltheme and .png
                let downloadedFiles = 0;

                for (const theme of themes) {
                    try {
                        // Extract filename from URL
                        const themeFileName = theme.theme_url.split('/').pop();
                        const imageFileName = theme.thumbnail_url.split('/').pop();

                        // Download theme file
                        backupLog('üì• Downloading ' + themeFileName + '...', 'info');
                        const themeResponse = await fetch(theme.theme_url);
                        if (themeResponse.ok) {
                            const themeBlob = await themeResponse.blob();
                            contentFolder.file(themeFileName, themeBlob);
                            downloadedFiles++;
                            backupLog('‚úÖ Added ' + themeFileName, 'success');
                        } else {
                            backupLog('‚ö†Ô∏è Failed to download ' + themeFileName, 'error');
                        }

                        // Download image file
                        backupLog('üì• Downloading ' + imageFileName + '...', 'info');
                        const imageResponse = await fetch(theme.thumbnail_url);
                        if (imageResponse.ok) {
                            const imageBlob = await imageResponse.blob();
                            contentFolder.file(imageFileName, imageBlob);
                            downloadedFiles++;
                            backupLog('‚úÖ Added ' + imageFileName, 'success');
                        } else {
                            backupLog('‚ö†Ô∏è Failed to download ' + imageFileName, 'error');
                        }

                        // Update progress
                        const progress = 10 + (downloadedFiles / totalFiles) * 70;
                        updateBackupProgress(progress);

                    } catch (err) {
                        backupLog('‚ö†Ô∏è Error processing theme "' + theme.name + '": ' + err.message, 'error');
                    }
                }

                backupLog('üì¶ Generating ZIP file...', 'info');
                updateBackupProgress(85);

                // Generate the ZIP file
                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                }, function(metadata) {
                    updateBackupProgress(85 + (metadata.percent / 100) * 10);
                });

                updateBackupProgress(95);

                // Create download link
                const timestamp = new Date().toISOString().slice(0, 10);
                const fileName = 'wallboard-themes-backup-' + timestamp + '.zip';
                
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(content);
                downloadLink.download = fileName;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                updateBackupProgress(100);
                
                const sizeMB = (content.size / (1024 * 1024)).toFixed(2);
                backupLog('', 'info');
                backupLog('‚ú® Backup complete! Downloaded ' + fileName + ' (' + sizeMB + ' MB)', 'success');
                backupLog('üìä ' + downloadedFiles + ' files backed up from ' + themes.length + ' themes', 'success');

            } catch (error) {
                backupLog('‚ùå Error: ' + error.message, 'error');
                console.error('Full error:', error);
            } finally {
                backupBtn.disabled = false;
            }
        }

        function confirmRestore() {
            const restoreFile = document.getElementById('restoreFile').files[0];
            
            if (!restoreFile) {
                alert('Please select a backup file first!');
                return;
            }

            if (!restoreFile.name.toLowerCase().endsWith('.zip')) {
                alert('Please select a valid .zip backup file!');
                return;
            }

            if (confirm('‚ö†Ô∏è WARNING: This will replace ALL existing themes with the backup content.\n\nAre you sure you want to continue?')) {
                restoreFromBackup();
            }
        }

        async function restoreFromBackup() {
            const restoreBtn = document.getElementById('restoreBtn');
            restoreBtn.disabled = true;
            document.getElementById('restoreOutput').innerHTML = '';
            document.getElementById('restoreOutput').classList.remove('show');
            document.getElementById('restoreProgress').classList.remove('show');
            document.getElementById('restoreSuccessLinks').style.display = 'none';

            try {
                restoreLog('‚è≥ Starting restore...', 'info');
                updateRestoreProgress(5);

                const AwsClientClass = await waitForAwsClient();
                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                const restoreFile = document.getElementById('restoreFile').files[0];
                
                restoreLog('üì¶ Reading backup file...', 'info');
                updateRestoreProgress(10);

                // Read the ZIP file
                const zip = await JSZip.loadAsync(restoreFile);
                
                // Check if wallthemes.json exists
                const jsonFile = zip.file('wallthemes.json');
                if (!jsonFile) {
                    throw new Error('Invalid backup: wallthemes.json not found');
                }

                restoreLog('‚úÖ Valid backup file detected', 'success');
                updateRestoreProgress(15);

                // Parse the JSON
                const jsonContent = await jsonFile.async('string');
                const jsonData = JSON.parse(jsonContent);
                const themes = jsonData.themes || [];

                restoreLog('üìã Found ' + themes.length + ' themes in backup', 'info');
                updateRestoreProgress(20);

                // Get the content folder
                const contentFiles = [];
                zip.folder('content').forEach(function(relativePath, file) {
                    contentFiles.push({ path: relativePath, file: file });
                });

                restoreLog('üì¶ Found ' + contentFiles.length + ' content files', 'info');

                // Upload each content file
                let uploadedFiles = 0;
                const totalFiles = contentFiles.length + 1; // +1 for JSON

                for (const item of contentFiles) {
                    try {
                        const blob = await item.file.async('blob');
                        const fileName = item.path;
                        
                        // Determine content type
                        let contentType = 'application/octet-stream';
                        if (fileName.endsWith('.png')) {
                            contentType = 'image/png';
                        } else if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg')) {
                            contentType = 'image/jpeg';
                        } else if (fileName.endsWith('.walltheme')) {
                            contentType = 'application/octet-stream';
                        }

                        restoreLog('üì§ Uploading ' + fileName + '...', 'info');
                        
                        const uploadUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName;
                        const response = await aws.fetch(uploadUrl, {
                            method: 'PUT',
                            body: blob,
                            headers: { 'Content-Type': contentType }
                        });

                        if (!response.ok) {
                            throw new Error('Upload failed: ' + response.statusText);
                        }

                        uploadedFiles++;
                        restoreLog('‚úÖ Uploaded ' + fileName, 'success');
                        
                        const progress = 20 + (uploadedFiles / totalFiles) * 70;
                        updateRestoreProgress(progress);

                    } catch (err) {
                        restoreLog('‚ö†Ô∏è Failed to upload ' + item.path + ': ' + err.message, 'error');
                    }
                }

                // Upload the JSON file
                restoreLog('üì§ Uploading wallthemes.json...', 'info');
                
                // Update the last_updated timestamp
                jsonData.last_updated = new Date().toISOString();
                
                const jsonUploadUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/json/wallthemes.json';
                const jsonResponse = await aws.fetch(jsonUploadUrl, {
                    method: 'PUT',
                    body: JSON.stringify(jsonData, null, 2),
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!jsonResponse.ok) {
                    throw new Error('Failed to upload JSON: ' + jsonResponse.statusText);
                }

                restoreLog('‚úÖ Uploaded wallthemes.json', 'success');
                updateRestoreProgress(95);

                // Wait for Cloudflare to propagate
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });

                updateRestoreProgress(100);

                restoreLog('', 'info');
                restoreLog('‚ú® Restore complete!', 'success');
                restoreLog('üìä Restored ' + themes.length + ' themes (' + uploadedFiles + ' files)', 'success');

                const linksDiv = document.getElementById('restoreLinksList');
                linksDiv.innerHTML = '<a href="' + PUBLIC_URL + '/json/wallthemes.json" target="_blank">üîó View Restored JSON</a>';
                document.getElementById('restoreSuccessLinks').style.display = 'block';

                // Reset form
                document.getElementById('restoreFile').value = '';
                document.getElementById('restoreFileLabel').textContent = 'üì¶ Choose backup .zip file';
                document.getElementById('restoreFileLabel').classList.remove('has-file');

                // Reload themes gallery
                setTimeout(loadThemes, 2000);

            } catch (error) {
                restoreLog('‚ùå Error: ' + error.message, 'error');
                console.error('Full error:', error);
            } finally {
                restoreBtn.disabled = false;
            }
        }

        // ==================== END BACKUP & RESTORE ====================

        // ==================== FILE BROWSER ====================
        let allBucketFiles = [];
        let currentFileFilter = 'all';

        async function loadBucketFiles() {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading files from R2 bucket...</p></div>';

            try {
                const AwsClientClass = await waitForAwsClient();
                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                // List objects in the content/ directory
                const listUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '?list-type=2&prefix=content/';
                const response = await aws.fetch(listUrl, { method: 'GET' });

                if (!response.ok) {
                    throw new Error('Failed to list bucket contents: ' + response.status);
                }

                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                // Parse the XML response
                const contents = xmlDoc.getElementsByTagName('Contents');
                allBucketFiles = [];
                let totalSize = 0;

                for (let i = 0; i < contents.length; i++) {
                    const item = contents[i];
                    const key = item.getElementsByTagName('Key')[0]?.textContent || '';
                    const size = parseInt(item.getElementsByTagName('Size')[0]?.textContent || '0');
                    const lastModified = item.getElementsByTagName('LastModified')[0]?.textContent || '';

                    // Skip the directory itself
                    if (key === 'content/' || key === '') continue;

                    const fileName = key.replace('content/', '');
                    const extension = fileName.split('.').pop().toLowerCase();
                    
                    let fileType = 'other';
                    if (extension === 'walltheme') {
                        fileType = 'walltheme';
                    } else if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(extension)) {
                        fileType = 'image';
                    }

                    totalSize += size;
                    allBucketFiles.push({
                        key: key,
                        fileName: fileName,
                        size: size,
                        lastModified: lastModified,
                        extension: extension,
                        fileType: fileType,
                        publicUrl: PUBLIC_URL + '/' + key
                    });
                }

                // Sort by last modified (newest first)
                allBucketFiles.sort(function(a, b) {
                    return new Date(b.lastModified) - new Date(a.lastModified);
                });

                // Update stats
                const themeCount = allBucketFiles.filter(function(f) { return f.fileType === 'walltheme'; }).length;
                const imageCount = allBucketFiles.filter(function(f) { return f.fileType === 'image'; }).length;
                
                document.getElementById('totalFiles').textContent = allBucketFiles.length;
                document.getElementById('themeFiles').textContent = themeCount;
                document.getElementById('imageFiles').textContent = imageCount;
                document.getElementById('totalSize').textContent = formatFileSize(totalSize);

                // Render the file list
                renderFileList();

            } catch (error) {
                console.error('Error loading bucket files:', error);
                container.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-state-icon">‚ö†Ô∏è</div>' +
                    '<h3>Failed to load files</h3>' +
                    '<p>' + error.message + '</p></div>';
            }
        }

        function renderFileList() {
            const container = document.getElementById('fileListContainer');
            
            // Filter files based on current filter
            let filteredFiles = allBucketFiles;
            if (currentFileFilter !== 'all') {
                filteredFiles = allBucketFiles.filter(function(f) {
                    return f.fileType === currentFileFilter;
                });
            }

            if (filteredFiles.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-state-icon">üìÇ</div>' +
                    '<h3>No files found</h3>' +
                    '<p>No files match the current filter</p></div>';
                return;
            }

            let html = '<div class="file-type-filter">' +
                '<button class="filter-btn' + (currentFileFilter === 'all' ? ' active' : '') + '" onclick="setFileFilter(\'all\')">All Files</button>' +
                '<button class="filter-btn' + (currentFileFilter === 'walltheme' ? ' active' : '') + '" onclick="setFileFilter(\'walltheme\')">.walltheme</button>' +
                '<button class="filter-btn' + (currentFileFilter === 'image' ? ' active' : '') + '" onclick="setFileFilter(\'image\')">Images</button>' +
                '<button class="filter-btn' + (currentFileFilter === 'other' ? ' active' : '') + '" onclick="setFileFilter(\'other\')">Other</button>' +
                '</div>';

            html += '<div class="file-list">';

            filteredFiles.forEach(function(file) {
                const icon = getFileIcon(file.fileType, file.extension);
                const date = new Date(file.lastModified);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let previewHtml = '';
                if (file.fileType === 'image') {
                    previewHtml = '<img class="file-preview" src="' + file.publicUrl + '" alt="Preview" onerror="this.style.display=\'none\'">';
                }

                html += '<div class="file-item">' +
                    '<div class="file-icon">' + icon + '</div>' +
                    previewHtml +
                    '<div class="file-info">' +
                    '<div class="file-name">' + escapeHtml(file.fileName) + '</div>' +
                    '<div class="file-meta">' +
                    '<span>üì¶ ' + formatFileSize(file.size) + '</span>' +
                    '<span>üìÖ ' + formattedDate + '</span>' +
                    '<span>üìÇ ' + file.extension.toUpperCase() + '</span>' +
                    '</div></div>' +
                    '<div class="file-actions">' +
                    '<a href="' + file.publicUrl + '" class="btn btn-secondary btn-sm" target="_blank" download>‚¨áÔ∏è Download</a>' +
                    '<button class="btn btn-secondary btn-sm" onclick="copyToClipboard(\'' + file.publicUrl + '\')">üìã Copy URL</button>' +
                    '<button class="btn btn-danger btn-sm" onclick="deleteBucketFile(\'' + file.key + '\', \'' + escapeHtml(file.fileName) + '\')">üóëÔ∏è</button>' +
                    '</div></div>';
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function setFileFilter(filter) {
            currentFileFilter = filter;
            renderFileList();
        }

        function getFileIcon(fileType, extension) {
            switch (fileType) {
                case 'walltheme':
                    return 'üé®';
                case 'image':
                    return 'üñºÔ∏è';
                default:
                    return 'üìÑ';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('URL copied to clipboard!');
            }).catch(function(err) {
                console.error('Failed to copy:', err);
                prompt('Copy this URL:', text);
            });
        }

        async function deleteBucketFile(key, fileName) {
            if (!confirm('Delete "' + fileName + '"?\n\nThis will permanently delete the file from the R2 bucket. This action cannot be undone.')) {
                return;
            }

            try {
                const AwsClientClass = await waitForAwsClient();
                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                const deleteUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/' + key;
                const response = await aws.fetch(deleteUrl, { method: 'DELETE' });

                if (!response.ok) {
                    throw new Error('Failed to delete file: ' + response.status);
                }

                alert('File deleted successfully!');
                loadBucketFiles();

            } catch (error) {
                alert('Failed to delete file: ' + error.message);
                console.error('Delete error:', error);
            }
        }

        // ==================== END FILE BROWSER ====================

        // ==================== INTEGRITY CHECK ====================
        function checkFileIntegrity() {
            if (allBucketFiles.length === 0) {
                alert('Please wait for files to load first.');
                return;
            }

            const resultsDiv = document.getElementById('integrityResults');
            
            // Get all walltheme files and image files
            const themeFiles = allBucketFiles.filter(function(f) { return f.fileType === 'walltheme'; });
            const imageFiles = allBucketFiles.filter(function(f) { return f.fileType === 'image'; });

            // Extract base names (without extension)
            const themeBaseNames = new Set(themeFiles.map(function(f) {
                return f.fileName.replace('.walltheme', '');
            }));
            
            const imageBaseNames = new Set(imageFiles.map(function(f) {
                // Remove common image extensions
                return f.fileName.replace(/\.(png|jpg|jpeg|gif|webp)$/i, '');
            }));

            // Find mismatches
            const themesWithoutImages = [];
            const imagesWithoutThemes = [];

            themeBaseNames.forEach(function(name) {
                if (!imageBaseNames.has(name)) {
                    const themeFile = themeFiles.find(function(f) {
                        return f.fileName.replace('.walltheme', '') === name;
                    });
                    themesWithoutImages.push(themeFile);
                }
            });

            imageBaseNames.forEach(function(name) {
                if (!themeBaseNames.has(name)) {
                    const imageFile = imageFiles.find(function(f) {
                        return f.fileName.replace(/\.(png|jpg|jpeg|gif|webp)$/i, '') === name;
                    });
                    imagesWithoutThemes.push(imageFile);
                }
            });

            // Build results HTML
            let html = '';

            if (themesWithoutImages.length === 0 && imagesWithoutThemes.length === 0) {
                html = '<div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 16px;">' +
                    '<h4 style="color: #22c55e; margin: 0 0 8px 0;">‚úÖ All files match!</h4>' +
                    '<p style="color: #71717a; margin: 0;">Every .walltheme file has a corresponding image file.</p>' +
                    '</div>';
            } else {
                html = '<div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 16px;">' +
                    '<h4 style="color: #ef4444; margin: 0 0 12px 0;">‚ö†Ô∏è Mismatched Files Found</h4>';

                if (themesWithoutImages.length > 0) {
                    html += '<div style="margin-bottom: 16px;">' +
                        '<h5 style="color: #f59e0b; margin: 0 0 8px 0;">üì¶ Themes missing images (' + themesWithoutImages.length + '):</h5>' +
                        '<div class="file-list" style="gap: 4px;">';
                    
                    themesWithoutImages.forEach(function(file) {
                        html += '<div class="file-item" style="padding: 10px 12px; background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);">' +
                            '<div class="file-icon">üé®</div>' +
                            '<div class="file-info" style="flex: 1;">' +
                            '<div class="file-name" style="font-size: 13px;">' + escapeHtml(file.fileName) + '</div>' +
                            '</div>' +
                            '<div class="file-actions">' +
                            '<a href="' + file.publicUrl + '" class="btn btn-secondary btn-sm" target="_blank" download>‚¨áÔ∏è</a>' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteBucketFile(\'' + file.key + '\', \'' + escapeHtml(file.fileName) + '\')">üóëÔ∏è</button>' +
                            '</div></div>';
                    });
                    
                    html += '</div></div>';
                }

                if (imagesWithoutThemes.length > 0) {
                    html += '<div>' +
                        '<h5 style="color: #f59e0b; margin: 0 0 8px 0;">üñºÔ∏è Images missing themes (' + imagesWithoutThemes.length + '):</h5>' +
                        '<div class="file-list" style="gap: 4px;">';
                    
                    imagesWithoutThemes.forEach(function(file) {
                        html += '<div class="file-item" style="padding: 10px 12px; background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);">' +
                            '<img class="file-preview" src="' + file.publicUrl + '" alt="Preview" style="width: 50px; height: 50px;" onerror="this.style.display=\'none\'">' +
                            '<div class="file-info" style="flex: 1;">' +
                            '<div class="file-name" style="font-size: 13px;">' + escapeHtml(file.fileName) + '</div>' +
                            '</div>' +
                            '<div class="file-actions">' +
                            '<a href="' + file.publicUrl + '" class="btn btn-secondary btn-sm" target="_blank" download>‚¨áÔ∏è</a>' +
                            '<button class="btn btn-danger btn-sm" onclick="deleteBucketFile(\'' + file.key + '\', \'' + escapeHtml(file.fileName) + '\')">üóëÔ∏è</button>' +
                            '</div></div>';
                    });
                    
                    html += '</div></div>';
                }

                html += '</div>';
            }

            // Add close button
            html += '<button class="btn btn-secondary btn-sm" style="margin-top: 12px;" onclick="document.getElementById(\'integrityResults\').style.display=\'none\'">‚úï Close</button>';

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        // ==================== END INTEGRITY CHECK ====================

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('themeName').addEventListener('input', function() {
                const themeName = this.value.trim();
                if (themeName) {
                    const fileName = themeName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    document.getElementById('filenameDisplay').textContent = fileName;
                    document.getElementById('filenamePreview').style.display = 'block';
                } else {
                    document.getElementById('filenamePreview').style.display = 'none';
                }
            });

            document.getElementById('themeFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('themeFileLabel').textContent = '‚úÖ ' + file.name;
                    document.getElementById('themeFileLabel').classList.add('has-file');
                }
            });
            
            // Add explicit click handler for mobile
            document.getElementById('themeFileLabel').addEventListener('click', function(e) {
                console.log('Theme file label clicked');
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('themeFile').click();
            });

            document.getElementById('imageFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('imageFileLabel').textContent = '‚úÖ ' + file.name;
                    document.getElementById('imageFileLabel').classList.add('has-file');
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.getElementById('previewImg');
                        img.src = event.target.result;
                        document.getElementById('imagePreview').classList.add('show');
                        
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            const maxDim = 1920;
                            let displayText = 'Original: ' + tempImg.width + '√ó' + tempImg.height + 'px';
                            
                            if (tempImg.width > maxDim || tempImg.height > maxDim) {
                                let newW, newH;
                                if (tempImg.width > tempImg.height) {
                                    newW = maxDim;
                                    newH = Math.round((tempImg.height / tempImg.width) * maxDim);
                                } else {
                                    newH = maxDim;
                                    newW = Math.round((tempImg.width / tempImg.height) * maxDim);
                                }
                                displayText += ' ‚Ä¢ Will be resized to ' + newW + '√ó' + newH + 'px (aspect ratio preserved)';
                            } else {
                                displayText += ' ‚Ä¢ No resize needed';
                            }
                            
                            document.getElementById('previewInfo').textContent = displayText;
                        };
                        tempImg.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Add explicit click handler for mobile
            document.getElementById('imageFileLabel').addEventListener('click', function(e) {
                console.log('Image file label clicked');
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('imageFile').click();
            });

            // Font file input handler
            document.getElementById('fontFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    document.getElementById('fontFileLabel').textContent = '‚úÖ ' + file.name + ' (' + sizeMB + ' MB)';
                    document.getElementById('fontFileLabel').classList.add('has-file');
                }
            });
            
            document.getElementById('fontFileLabel').addEventListener('click', function(e) {
                console.log('Font file label clicked');
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('fontFile').click();
            });

            // Weather file input handler
            document.getElementById('weatherFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    document.getElementById('weatherFileLabel').textContent = '‚úÖ ' + file.name + ' (' + sizeMB + ' MB)';
                    document.getElementById('weatherFileLabel').classList.add('has-file');
                }
            });
            
            document.getElementById('weatherFileLabel').addEventListener('click', function(e) {
                console.log('Weather file label clicked');
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('weatherFile').click();
            });

            // Merge weather folder input handler
            document.getElementById('mergeWeatherFolder').addEventListener('change', function(e) {
                var files = e.target.files;
                if (files && files.length > 0) {
                    var folderName = files[0].webkitRelativePath.split('/')[0];
                    var validFiles = [];
                    for (var i = 0; i < files.length; i++) {
                        var path = files[i].webkitRelativePath;
                        if (!path.includes('__MACOSX') && !path.includes('.DS_Store')) validFiles.push(files[i]);
                    }
                    pendingMergeFiles = files;
                    pendingMergeFolderName = folderName;
                    document.getElementById('mergeWeatherFolderLabel').textContent = '‚úÖ ' + folderName + ' (' + validFiles.length + ' files)';
                    document.getElementById('mergeWeatherFolderLabel').classList.add('has-file');

                    var previewHtml = 'üìÅ <strong>' + folderName + '</strong> ‚Äî ' + validFiles.length + ' files';
                    var samples = validFiles.slice(0, 5);
                    previewHtml += '<div style="margin-top: 8px; padding-left: 16px; color: #71717a;">';
                    for (var j = 0; j < samples.length; j++) {
                        previewHtml += '  ' + samples[j].webkitRelativePath + '<br>';
                    }
                    if (validFiles.length > 5) previewHtml += '  ... and ' + (validFiles.length - 5) + ' more';
                    previewHtml += '</div>';
                    document.getElementById('mergePreviewList').innerHTML = previewHtml;
                    document.getElementById('mergePreview').style.display = 'block';
                    document.getElementById('mergeWeatherBtn').disabled = false;
                }
            });

            document.getElementById('mergeWeatherFolderLabel').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('mergeWeatherFolder').click();
            });

            // Update theme file input handler
            document.getElementById('updateThemeFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('updateThemeFileLabel').textContent = '‚úÖ ' + file.name;
                    document.getElementById('updateThemeFileLabel').classList.add('has-file');
                }
            });
            
            document.getElementById('updateThemeFileLabel').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('updateThemeFileInput').click();
            });

            // Update image file input handler
            document.getElementById('updateImageFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('updateImageFileLabel').textContent = '‚úÖ ' + file.name;
                    document.getElementById('updateImageFileLabel').classList.add('has-file');
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.getElementById('updatePreviewImg');
                        img.src = event.target.result;
                        document.getElementById('updateImagePreview').style.display = 'block';
                        
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            const maxDim = 1920;
                            let displayText = 'Original: ' + tempImg.width + '√ó' + tempImg.height + 'px';
                            
                            if (tempImg.width > maxDim || tempImg.height > maxDim) {
                                let newW, newH;
                                if (tempImg.width > tempImg.height) {
                                    newW = maxDim;
                                    newH = Math.round((tempImg.height / tempImg.width) * maxDim);
                                } else {
                                    newH = maxDim;
                                    newW = Math.round((tempImg.width / tempImg.height) * maxDim);
                                }
                                displayText += ' ‚Ä¢ Will be resized to ' + newW + '√ó' + newH + 'px (aspect ratio preserved)';
                            } else {
                                displayText += ' ‚Ä¢ No resize needed';
                            }
                            
                            document.getElementById('updatePreviewInfo').textContent = displayText;
                        };
                        tempImg.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            document.getElementById('updateImageFileLabel').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('updateImageFileInput').click();
            });

            // Restore file input handler
            document.getElementById('restoreFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    document.getElementById('restoreFileLabel').textContent = '‚úÖ ' + file.name + ' (' + sizeMB + ' MB)';
                    document.getElementById('restoreFileLabel').classList.add('has-file');
                }
            });
            
            document.getElementById('restoreFileLabel').addEventListener('click', function(e) {
                console.log('Restore file label clicked');
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('restoreFile').click();
            });

            loadThemes();
            loadFontInfo();
            loadWeatherInfo();
        });

        window.uploadToCloudflare = uploadToCloudflare;
    </script>
</body>
</html>
