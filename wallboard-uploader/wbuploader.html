<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WallBoard Theme Manager</title>
    <script src="https://unpkg.com/aws4fetch@1.0.18/dist/aws4fetch.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #0a0e27;
            color: #e4e4e7;
            min-height: 100vh;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            padding: 30px 40px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .header p {
            color: #a5b4fc;
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            border-bottom: 1px solid #27272a;
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #71717a;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #a5b4fc;
        }

        .tab.active {
            color: #818cf8;
            border-bottom-color: #818cf8;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #18181b;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 24px;
            border: 1px solid #27272a;
        }

        .section h2 {
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #a1a1aa;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            background: #09090b;
            border: 1px solid #27272a;
            border-radius: 8px;
            color: #e4e4e7;
            font-size: 14px;
            transition: all 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #818cf8;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.1);
        }

        .file-input-wrapper {
            position: relative;
            width: 100%;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: #09090b;
            border: 2px dashed #3f3f46;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #71717a;
            font-size: 14px;
            -webkit-tap-highlight-color: rgba(129, 140, 248, 0.2);
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .file-input-label:hover {
            border-color: #818cf8;
            background: #18181b;
        }
        
        .file-input-label:active {
            transform: scale(0.98);
        }

        .file-input-label.has-file {
            border-style: solid;
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        input[type="file"] {
            display: none;
        }

        .preview {
            margin-top: 16px;
            display: none;
        }

        .preview.show {
            display: block;
        }

        .preview img {
            max-width: 200px;
            border-radius: 8px;
            border: 1px solid #27272a;
        }

        .preview-info {
            margin-top: 8px;
            font-size: 12px;
            color: #71717a;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #818cf8;
            color: #fff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #6366f1;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(129, 140, 248, 0.4);
        }

        .btn-danger {
            background: #dc2626;
            color: #fff;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }

        .btn-secondary {
            background: #27272a;
            color: #e4e4e7;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #3f3f46;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .output {
            margin-top: 20px;
            padding: 16px;
            background: #09090b;
            border-radius: 8px;
            color: #a1a1aa;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            border: 1px solid #27272a;
        }

        .output.show {
            display: block;
        }

        .output .success {
            color: #22c55e;
        }

        .output .error {
            color: #ef4444;
        }

        .output .info {
            color: #818cf8;
        }

        .progress {
            width: 100%;
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        .progress.show {
            display: block;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #818cf8 0%, #6366f1 100%);
            width: 0%;
            transition: width 0.3s;
        }

        #fontProgress {
            width: 100%;
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        #fontProgress.show {
            display: block;
        }

        #fontProgressBar {
            height: 100%;
            background: linear-gradient(90deg, #818cf8 0%, #6366f1 100%);
            width: 0%;
            transition: width 0.3s;
        }

        #fontOutput {
            margin-top: 20px;
            padding: 16px;
            background: #09090b;
            border-radius: 8px;
            color: #a1a1aa;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            border: 1px solid #27272a;
        }

        #fontOutput.show {
            display: block;
        }

        #fontOutput .success {
            color: #22c55e;
        }

        #fontOutput .error {
            color: #ef4444;
        }

        #fontOutput .info {
            color: #818cf8;
        }

        #weatherProgress {
            width: 100%;
            height: 4px;
            background: #27272a;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        #weatherProgress.show {
            display: block;
        }

        #weatherProgressBar {
            height: 100%;
            background: linear-gradient(90deg, #818cf8 0%, #6366f1 100%);
            width: 0%;
            transition: width 0.3s;
        }

        #weatherOutput {
            margin-top: 20px;
            padding: 16px;
            background: #09090b;
            border-radius: 8px;
            color: #a1a1aa;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            border: 1px solid #27272a;
        }

        #weatherOutput.show {
            display: block;
        }

        #weatherOutput .success {
            color: #22c55e;
        }

        #weatherOutput .error {
            color: #ef4444;
        }

        #weatherOutput .info {
            color: #818cf8;
        }

        .filename-preview {
            background: rgba(129, 140, 248, 0.1);
            border: 1px solid rgba(129, 140, 248, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 12px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            color: #a5b4fc;
        }

        .filename-preview strong {
            color: #818cf8;
        }

        .success-links {
            margin-top: 20px;
            padding: 16px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
        }

        .success-links h4 {
            color: #22c55e;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .success-links a {
            color: #4ade80;
            text-decoration: none;
            display: block;
            margin: 6px 0;
            font-size: 13px;
        }

        .success-links a:hover {
            text-decoration: underline;
        }

        .theme-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .theme-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
            position: relative;
        }

        .theme-card:hover {
            border-color: #818cf8;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .theme-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #09090b;
        }

        .theme-card-content {
            padding: 16px;
        }

        .theme-card h3 {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .theme-card .author {
            font-size: 13px;
            color: #71717a;
            margin-bottom: 8px;
        }

        .theme-card .meta {
            font-size: 12px;
            color: #52525b;
            margin-bottom: 12px;
        }

        .theme-card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #71717a;
        }

        .spinner {
            border: 3px solid #27272a;
            border-top: 3px solid #818cf8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #71717a;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 12px;
            padding: 20px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #818cf8;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .modal-header p {
            color: #71717a;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .theme-gallery {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® WallBoard Theme Manager</h1>
        <p>Professional theme management for WallBoard</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">üì§ Upload Theme</button>
            <button class="tab" onclick="switchTab('manage')">üóÇÔ∏è Manage Themes</button>
            <button class="tab" onclick="switchTab('fonts')">üî§ Manage Fonts</button>
            <button class="tab" onclick="switchTab('weather')">üå§Ô∏è Weather Icons</button>
        </div>

        <div id="upload-tab" class="tab-content active">
            <div class="section">
                <h2>Theme Details</h2>
                
                <div class="form-group">
                    <label for="themeName">Theme Name *</label>
                    <input type="text" id="themeName" placeholder="e.g. Ocean Sunset" required>
                </div>

                <div class="form-group">
                    <label for="authorName">Author Name *</label>
                    <input type="text" id="authorName" placeholder="e.g. @YourHandle" required>
                </div>

                <div id="filenamePreview" class="filename-preview" style="display: none;">
                    <strong>Filename:</strong> <span id="filenameDisplay"></span>
                </div>
            </div>

            <div class="section">
                <h2>Files</h2>
                
                <div class="form-group">
                    <label>WallTheme File (.walltheme) *</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="themeFileLabel">
                            üì¶ Choose .walltheme file
                        </div>
                        <input type="file" id="themeFile" accept=".walltheme" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Preview Image (PNG, JPG) *</label>
                    <p style="font-size: 12px; color: #71717a; margin-bottom: 8px;">Images will be resized to max 1920px while preserving aspect ratio</p>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="imageFileLabel">
                            üñºÔ∏è Choose image file
                        </div>
                        <input type="file" id="imageFile" accept="image/*" required>
                    </div>
                    
                    <div class="preview" id="imagePreview">
                        <img id="previewImg" alt="Preview">
                        <div class="preview-info" id="previewInfo"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Upload</h2>
                <button class="btn btn-primary" id="uploadBtn" onclick="uploadToCloudflare()">
                    ‚òÅÔ∏è Upload to Cloudflare
                </button>

                <div class="progress" id="progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <div class="output" id="output"></div>

                <div id="successLinks" class="success-links" style="display: none;">
                    <h4>‚úÖ Successfully Uploaded!</h4>
                    <div id="linksList"></div>
                </div>
            </div>
        </div>

        <div id="manage-tab" class="tab-content">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalThemes">0</div>
                    <div class="stat-label">Total Themes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDownloads">0</div>
                    <div class="stat-label">Total Downloads</div>
                </div>
            </div>

            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Theme Gallery</h2>
                    <button class="btn btn-secondary btn-sm" onclick="loadThemes()">
                        üîÑ Refresh
                    </button>
                </div>

                <div id="themeGallery">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading themes...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fonts Tab -->
        <div id="fonts-tab" class="tab-content">
            <div class="section">
                <h2>Current Font Package</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Download or replace the fonts.zip file used by WallBoard themes.</p>
                
                <div style="background: #09090b; border: 1px solid #27272a; border-radius: 8px; padding: 20px; margin-bottom: 20px;" id="fontInfo">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="font-size: 32px;">üì¶</div>
                        <div>
                            <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">fonts.zip</div>
                            <div style="font-size: 13px; color: #71717a;" id="fontFileSize">Loading...</div>
                        </div>
                    </div>
                    <a href="https://wallboard-themes.ske-d03.workers.dev/starter-assets/fonts/fonts.zip" 
                       class="btn btn-secondary" 
                       download
                       style="text-decoration: none;">
                        ‚¨áÔ∏è Download Current Fonts
                    </a>
                </div>
            </div>

            <div class="section">
                <h2>Upload New Font Package</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Replace the current fonts.zip with a new version. This will overwrite the existing file.</p>
                
                <div class="form-group">
                    <label>Font Package (.zip) *</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="fontFileLabel">
                            üì¶ Choose fonts.zip file
                        </div>
                        <input type="file" id="fontFile" accept=".zip" required>
                    </div>
                </div>

                <button class="btn btn-primary" id="uploadFontBtn" onclick="uploadFonts()">
                    ‚òÅÔ∏è Upload Font Package
                </button>

                <div class="progress" id="fontProgress">
                    <div class="progress-bar" id="fontProgressBar"></div>
                </div>

                <div class="output" id="fontOutput"></div>

                <div id="fontSuccessLinks" class="success-links" style="display: none;">
                    <h4>‚úÖ Successfully Uploaded!</h4>
                    <div id="fontLinksList"></div>
                </div>
            </div>
        </div>

        <!-- Weather Icons Tab -->
        <div id="weather-tab" class="tab-content">
            <div class="section">
                <h2>Current Weather Icons Package</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Download or replace the weathericons.zip file used by WallBoard themes.</p>
                
                <div style="background: #09090b; border: 1px solid #27272a; border-radius: 8px; padding: 20px; margin-bottom: 20px;" id="weatherInfo">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="font-size: 32px;">üå§Ô∏è</div>
                        <div>
                            <div style="font-weight: 600; color: #fff; margin-bottom: 4px;">weathericons.zip</div>
                            <div style="font-size: 13px; color: #71717a;" id="weatherFileSize">Loading...</div>
                        </div>
                    </div>
                    <a href="https://wallboard-themes.ske-d03.workers.dev/starter-assets/weather-icons/weathericons.zip" 
                       class="btn btn-secondary" 
                       download
                       style="text-decoration: none;">
                        ‚¨áÔ∏è Download Current Weather Icons
                    </a>
                </div>
            </div>

            <div class="section">
                <h2>Upload New Weather Icons Package</h2>
                <p style="color: #71717a; margin-bottom: 20px;">Replace the current weathericons.zip with a new version. This will overwrite the existing file.</p>
                
                <div class="form-group">
                    <label>Weather Icons Package (.zip) *</label>
                    <div class="file-input-wrapper">
                        <div class="file-input-label" id="weatherFileLabel">
                            üå§Ô∏è Choose weathericons.zip file
                        </div>
                        <input type="file" id="weatherFile" accept=".zip" required>
                    </div>
                </div>

                <button class="btn btn-primary" id="uploadWeatherBtn" onclick="uploadWeatherIcons()">
                    ‚òÅÔ∏è Upload Weather Icons Package
                </button>

                <div class="progress" id="weatherProgress">
                    <div class="progress-bar" id="weatherProgressBar"></div>
                </div>

                <div class="output" id="weatherOutput"></div>

                <div id="weatherSuccessLinks" class="success-links" style="display: none;">
                    <h4>‚úÖ Successfully Uploaded!</h4>
                    <div id="weatherLinksList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Theme?</h3>
                <p>Are you sure you want to delete "<strong id="deleteThemeName"></strong>"? This action cannot be undone.</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Update Theme File Modal -->
    <div id="updateThemeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Theme File</h3>
                <p>Replace the .walltheme file for "<strong id="updateThemeFileName"></strong>"</p>
            </div>
            <div class="form-group">
                <label>New Theme File (.walltheme)</label>
                <div class="file-input-wrapper">
                    <div class="file-input-label" id="updateThemeFileLabel">
                        üì¶ Choose .walltheme file
                    </div>
                    <input type="file" id="updateThemeFileInput" accept=".walltheme">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeUpdateThemeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmUpdateTheme()">Update Theme File</button>
            </div>
        </div>
    </div>

    <!-- Update Image Modal -->
    <div id="updateImageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Preview Image</h3>
                <p>Replace the preview image for "<strong id="updateImageThemeName"></strong>"</p>
            </div>
            <div class="form-group">
                <label>New Preview Image (PNG, JPG)</label>
                <p style="font-size: 12px; color: #71717a; margin-bottom: 8px;">Images will be resized to max 1920px while preserving aspect ratio</p>
                <div class="file-input-wrapper">
                    <div class="file-input-label" id="updateImageFileLabel">
                        üñºÔ∏è Choose image file
                    </div>
                    <input type="file" id="updateImageFileInput" accept="image/*">
                </div>
                <div class="preview" id="updateImagePreview" style="margin-top: 16px; display: none;">
                    <img id="updatePreviewImg" alt="Preview" style="max-width: 200px; border-radius: 8px; border: 1px solid #27272a;">
                    <div class="preview-info" id="updatePreviewInfo" style="margin-top: 8px; font-size: 12px; color: #71717a;"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeUpdateImageModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmUpdateImage()">Update Image</button>
            </div>
        </div>
    </div>

    <script>
        let processedImage = null;
        let currentThemeToDelete = null;
        let currentThemeToUpdate = null;
        let allThemesData = null;

        const R2_ENDPOINT = 'https://d030355118641a7dd9d7205bd27f54cc.r2.cloudflarestorage.com';
        const BUCKET_NAME = 'wallboard-themes';
        const PUBLIC_URL = 'https://pub-85cc5573fcfb4bbd82c88dc9c03cea02.r2.dev';
        const ACCESS_KEY = 'c39e72c04d401157382000503f0f8a3d';
        const SECRET_KEY = '147582f21b4e7149dfb4fa38da5f455bdf9c5bb60ff9057897bcaaea6e47cd50';

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => {
                if (t.onclick.toString().includes("'" + tab + "'")) {
                    t.classList.add('active');
                }
            });

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            if (tab === 'manage') {
                loadThemes();
            } else if (tab === 'fonts') {
                loadFontInfo();
            } else if (tab === 'weather') {
                loadWeatherInfo();
            }
        }

        function log(message, type) {
            type = type || 'info';
            const output = document.getElementById('output');
            output.classList.add('show');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateProgress(percent) {
            const progress = document.getElementById('progress');
            const bar = document.getElementById('progressBar');
            progress.classList.add('show');
            bar.style.width = percent + '%';
        }

        function resizeImage(file, maxDimension) {
            return new Promise(function(resolve, reject) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    
                    img.onload = function() {
                        // Calculate new dimensions while preserving aspect ratio
                        let newWidth = img.width;
                        let newHeight = img.height;
                        
                        // Only resize if image is larger than max dimension
                        if (img.width > maxDimension || img.height > maxDimension) {
                            if (img.width > img.height) {
                                newWidth = maxDimension;
                                newHeight = (img.height / img.width) * maxDimension;
                            } else {
                                newHeight = maxDimension;
                                newWidth = (img.width / img.height) * maxDimension;
                            }
                        }
                        
                        // Create canvas with new dimensions
                        const canvas = document.createElement('canvas');
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        const ctx = canvas.getContext('2d');

                        // Draw image at new size (no cropping, preserves aspect ratio)
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);

                        canvas.toBlob(
                            function(blob) {
                                if (blob) {
                                    resolve(blob);
                                } else {
                                    reject(new Error('Failed to create image blob'));
                                }
                            },
                            'image/png',
                            0.9
                        );
                    };

                    img.onerror = function() { reject(new Error('Failed to load image')); };
                    img.src = e.target.result;
                };

                reader.onerror = function() { reject(new Error('Failed to read file')); };
                reader.readAsDataURL(file);
            });
        }

        function waitForAwsClient() {
            return new Promise(function(resolve, reject) {
                if (typeof AwsClient !== 'undefined') {
                    resolve(AwsClient);
                    return;
                }
                if (typeof window.AwsClient !== 'undefined') {
                    resolve(window.AwsClient);
                    return;
                }
                if (typeof aws4fetch !== 'undefined') {
                    if (typeof aws4fetch.AwsClient !== 'undefined') {
                        resolve(aws4fetch.AwsClient);
                        return;
                    }
                    if (typeof aws4fetch === 'function') {
                        resolve(aws4fetch);
                        return;
                    }
                }
                
                let attempts = 0;
                const maxAttempts = 50;
                const interval = setInterval(function() {
                    attempts++;
                    
                    let client = null;
                    if (typeof AwsClient !== 'undefined') {
                        client = AwsClient;
                    } else if (typeof window.AwsClient !== 'undefined') {
                        client = window.AwsClient;
                    } else if (typeof aws4fetch !== 'undefined') {
                        if (typeof aws4fetch.AwsClient !== 'undefined') {
                            client = aws4fetch.AwsClient;
                        } else if (typeof aws4fetch === 'function') {
                            client = aws4fetch;
                        }
                    }
                    
                    if (client) {
                        clearInterval(interval);
                        resolve(client);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        reject(new Error('AWS library failed to load.'));
                    }
                }, 100);
            });
        }

        async function uploadToCloudflare() {
            document.getElementById('output').innerHTML = '';
            document.getElementById('output').classList.remove('show');
            document.getElementById('progress').classList.remove('show');
            document.getElementById('successLinks').style.display = 'none';
            
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;

            try {
                log('‚è≥ Initializing...', 'info');
                const AwsClientClass = await waitForAwsClient();

                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                const themeName = document.getElementById('themeName').value.trim();
                const authorName = document.getElementById('authorName').value.trim();
                const themeFile = document.getElementById('themeFile').files[0];
                const imageFile = document.getElementById('imageFile').files[0];

                if (!themeName || !authorName || !themeFile || !imageFile) {
                    alert('Please fill in all required fields!');
                    uploadBtn.disabled = false;
                    return;
                }

                log('üöÄ Starting upload to Cloudflare R2...', 'info');
                updateProgress(5);

                const fileName = themeName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                log('üìù Generated filename: ' + fileName, 'info');
                updateProgress(10);

                log('üñºÔ∏è Processing image...', 'info');
                processedImage = await resizeImage(imageFile, 1920);
                log('‚úÖ Image processed (aspect ratio preserved)', 'success');
                updateProgress(20);

                log('üì• Fetching current wallthemes.json...', 'info');
                let jsonData = {
                    version: "1.0",
                    last_updated: new Date().toISOString(),
                    themes: []
                };
                
                try {
                    // Add cache busting to ensure we get the latest JSON
                    const jsonUrl = PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime();
                    const response = await fetch(jsonUrl, {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (response.ok) {
                        const parsedJson = await response.json();
                        
                        console.log('Fetched JSON:', parsedJson);
                        console.log('Number of themes in JSON:', parsedJson.themes ? parsedJson.themes.length : 0);
                        
                        if (parsedJson && parsedJson.themes && Array.isArray(parsedJson.themes)) {
                            jsonData = parsedJson;
                            log('‚úÖ Found ' + jsonData.themes.length + ' existing themes', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Error fetching JSON:', error);
                    log('‚ö†Ô∏è Error fetching JSON, creating new one', 'info');
                }
                updateProgress(30);

                log('üì§ Uploading ' + fileName + '.walltheme...', 'info');
                const themeUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.walltheme';
                const themeResponse = await aws.fetch(themeUrl, {
                    method: 'PUT',
                    body: themeFile,
                    headers: { 'Content-Type': 'application/octet-stream' }
                });
                
                if (!themeResponse.ok) throw new Error('Failed to upload theme: ' + themeResponse.statusText);
                log('‚úÖ Theme file uploaded!', 'success');
                updateProgress(50);

                log('üì§ Uploading ' + fileName + '.png...', 'info');
                const imageUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.png';
                const imageResponse = await aws.fetch(imageUrl, {
                    method: 'PUT',
                    body: processedImage,
                    headers: { 'Content-Type': 'image/png' }
                });
                
                if (!imageResponse.ok) throw new Error('Failed to upload image: ' + imageResponse.statusText);
                log('‚úÖ Image uploaded!', 'success');
                updateProgress(70);

                const newTheme = {
                    name: themeName,
                    author: authorName,
                    thumbnail_url: PUBLIC_URL + '/content/' + fileName + '.png',
                    theme_url: PUBLIC_URL + '/content/' + fileName + '.walltheme',
                    created_date: new Date().toISOString(),
                    downloads: 0
                };

                console.log('Adding new theme:', newTheme);
                console.log('Current themes count before push:', jsonData.themes.length);
                
                jsonData.themes.push(newTheme);
                
                console.log('Current themes count after push:', jsonData.themes.length);
                console.log('All themes:', jsonData.themes.map(function(t) { return t.name; }));
                
                jsonData.last_updated = new Date().toISOString();
                
                log('üìù Updated themes list (now ' + jsonData.themes.length + ' themes)', 'info');
                updateProgress(80);

                log('üì§ Uploading updated wallthemes.json...', 'info');
                const jsonUploadUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/json/wallthemes.json';
                const jsonResponse = await aws.fetch(jsonUploadUrl, {
                    method: 'PUT',
                    body: JSON.stringify(jsonData, null, 2),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!jsonResponse.ok) throw new Error('Failed to upload JSON: ' + jsonResponse.statusText);
                log('‚úÖ JSON updated!', 'success');
                updateProgress(100);
                
                // Wait a moment for Cloudflare to propagate the changes
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });

                log('', 'info');
                log('‚ú® All done! Your theme is now live!', 'success');

                const linksDiv = document.getElementById('linksList');
                linksDiv.innerHTML = '<a href="' + PUBLIC_URL + '/content/' + fileName + '.walltheme" target="_blank">üîó Theme File</a>' +
                    '<a href="' + PUBLIC_URL + '/content/' + fileName + '.png" target="_blank">üîó Preview Image</a>' +
                    '<a href="' + PUBLIC_URL + '/json/wallthemes.json" target="_blank">üîó Updated JSON</a>';
                document.getElementById('successLinks').style.display = 'block';

                document.getElementById('themeName').value = '';
                document.getElementById('authorName').value = '';
                document.getElementById('themeFile').value = '';
                document.getElementById('imageFile').value = '';
                document.getElementById('themeFileLabel').textContent = 'üì¶ Choose .walltheme file';
                document.getElementById('themeFileLabel').classList.remove('has-file');
                document.getElementById('imageFileLabel').textContent = 'üñºÔ∏è Choose image file';
                document.getElementById('imageFileLabel').classList.remove('has-file');
                document.getElementById('imagePreview').classList.remove('show');
                document.getElementById('filenamePreview').style.display = 'none';

            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
                console.error('Full error:', error);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        async function loadThemes() {
            const gallery = document.getElementById('themeGallery');
            gallery.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading themes...</p></div>';

            try {
                // Add cache busting to get latest JSON
                const response = await fetch(PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime(), {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load themes');
                }

                const data = await response.json();
                const themes = data.themes || [];
                
                console.log('Loaded themes:', themes.length);
                console.log('Theme names:', themes.map(function(t) { return t.name; }));

                document.getElementById('totalThemes').textContent = themes.length;
                const totalDownloads = themes.reduce(function(sum, theme) { return sum + (theme.downloads || 0); }, 0);
                document.getElementById('totalDownloads').textContent = totalDownloads;

                if (themes.length === 0) {
                    gallery.innerHTML = '<div class="empty-state">' +
                        '<div class="empty-state-icon">üì¶</div>' +
                        '<h3>No themes yet</h3>' +
                        '<p>Upload your first theme to get started!</p>' +
                        '</div>';
                    return;
                }

                gallery.innerHTML = '<div class="theme-gallery"></div>';
                const galleryGrid = gallery.querySelector('.theme-gallery');

                themes.forEach(function(theme, index) {
                    const card = document.createElement('div');
                    card.className = 'theme-card';
                    
                    const date = new Date(theme.created_date);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });

                    card.innerHTML = '<img src="' + theme.thumbnail_url + '" alt="' + theme.name + '" onerror="this.src=\'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22%3E%3Crect fill=%22%2318181b%22 width=%22400%22 height=%22300%22/%3E%3Ctext fill=%22%2371717a%22 font-family=%22system-ui%22 font-size=%2218%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22%3ENo Image%3C/text%3E%3C/svg%3E\'">' +
                        '<div class="theme-card-content">' +
                        '<h3>' + theme.name + '</h3>' +
                        '<div class="author">' + theme.author + '</div>' +
                        '<div class="meta">üìÖ ' + formattedDate + ' ¬∑ üì• ' + (theme.downloads || 0) + ' downloads</div>' +
                        '<div class="theme-card-actions">' +
                        '<a href="' + theme.theme_url + '" class="btn btn-secondary btn-sm" target="_blank">‚¨áÔ∏è Download</a>' +
                        '<button class="btn btn-secondary btn-sm" onclick="updateThemeFile(' + index + ', \'' + theme.name + '\')">üìù Update Theme</button>' +
                        '</div>' +
                        '<div class="theme-card-actions" style="margin-top: 8px;">' +
                        '<button class="btn btn-secondary btn-sm" onclick="updateThemeImage(' + index + ', \'' + theme.name + '\')">üñºÔ∏è Update Image</button>' +
                        '<button class="btn btn-danger btn-sm" onclick="deleteTheme(' + index + ', \'' + theme.name + '\')">üóëÔ∏è Delete</button>' +
                        '</div></div>';
                    
                    galleryGrid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading themes:', error);
                gallery.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-state-icon">‚ö†Ô∏è</div>' +
                    '<h3>Failed to load themes</h3>' +
                    '<p>' + error.message + '</p></div>';
            }
        }

        function deleteTheme(index, name) {
            currentThemeToDelete = index;
            document.getElementById('deleteThemeName').textContent = name;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            currentThemeToDelete = null;
        }

        function updateThemeFile(index, name) {
            currentThemeToUpdate = index;
            document.getElementById('updateThemeFileName').textContent = name;
            document.getElementById('updateThemeModal').classList.add('show');
        }

        function closeUpdateThemeModal() {
            document.getElementById('updateThemeModal').classList.remove('show');
            document.getElementById('updateThemeFileInput').value = '';
            document.getElementById('updateThemeFileLabel').textContent = 'üì¶ Choose .walltheme file';
            document.getElementById('updateThemeFileLabel').classList.remove('has-file');
            currentThemeToUpdate = null;
        }

        async function confirmUpdateTheme() {
            if (currentThemeToUpdate === null) return;

            const fileInput = document.getElementById('updateThemeFileInput');
            const newFile = fileInput.files[0];

            if (!newFile) {
                alert('Please select a .walltheme file!');
                return;
            }

            if (!newFile.name.toLowerCase().endsWith('.walltheme')) {
                alert('Please select a .walltheme file!');
                return;
            }

            try {
                const AwsClientClass = await waitForAwsClient();
                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                // Fetch current JSON
                const response = await fetch(PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime(), {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const jsonData = await response.json();
                
                const theme = jsonData.themes[currentThemeToUpdate];
                const fileName = theme.theme_url.split('/').pop().replace('.walltheme', '');

                // Upload new theme file
                const themeUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.walltheme';
                const themeResponse = await aws.fetch(themeUrl, {
                    method: 'PUT',
                    body: newFile,
                    headers: { 'Content-Type': 'application/octet-stream' }
                });

                if (!themeResponse.ok) throw new Error('Failed to upload theme file');

                closeUpdateThemeModal();
                alert('Theme file updated successfully!');

                // Wait for propagation
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });

            } catch (error) {
                alert('Failed to update theme file: ' + error.message);
                console.error('Update error:', error);
            }
        }

        function updateThemeImage(index, name) {
            currentThemeToUpdate = index;
            document.getElementById('updateImageThemeName').textContent = name;
            document.getElementById('updateImageModal').classList.add('show');
        }

        function closeUpdateImageModal() {
            document.getElementById('updateImageModal').classList.remove('show');
            document.getElementById('updateImageFileInput').value = '';
            document.getElementById('updateImageFileLabel').textContent = 'üñºÔ∏è Choose image file';
            document.getElementById('updateImageFileLabel').classList.remove('has-file');
            document.getElementById('updateImagePreview').style.display = 'none';
            currentThemeToUpdate = null;
        }

        async function confirmUpdateImage() {
            if (currentThemeToUpdate === null) return;

            const fileInput = document.getElementById('updateImageFileInput');
            const newFile = fileInput.files[0];

            if (!newFile) {
                alert('Please select an image file!');
                return;
            }

            try {
                const AwsClientClass = await waitForAwsClient();
                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                // Fetch current JSON
                const response = await fetch(PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime(), {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const jsonData = await response.json();
                
                const theme = jsonData.themes[currentThemeToUpdate];
                const fileName = theme.thumbnail_url.split('/').pop().replace('.png', '');

                // Process and resize image
                const processedImg = await resizeImage(newFile, 1920);

                // Upload new image
                const imageUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.png';
                const imageResponse = await aws.fetch(imageUrl, {
                    method: 'PUT',
                    body: processedImg,
                    headers: { 'Content-Type': 'image/png' }
                });

                if (!imageResponse.ok) throw new Error('Failed to upload image');

                closeUpdateImageModal();
                alert('Image updated successfully!');

                // Wait for propagation then reload gallery
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });
                loadThemes();

            } catch (error) {
                alert('Failed to update image: ' + error.message);
                console.error('Update error:', error);
            }
        }

        async function confirmDelete() {
            if (currentThemeToDelete === null) return;

            try {
                const AwsClientClass = await waitForAwsClient();
                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                // Fetch with cache busting
                const response = await fetch(PUBLIC_URL + '/json/wallthemes.json?t=' + new Date().getTime(), {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const jsonData = await response.json();
                
                console.log('Deleting theme at index:', currentThemeToDelete);
                console.log('Total themes before delete:', jsonData.themes.length);
                
                const themeToDelete = jsonData.themes[currentThemeToDelete];
                const fileName = themeToDelete.theme_url.split('/').pop().replace('.walltheme', '');

                await aws.fetch(R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.walltheme', {
                    method: 'DELETE'
                });

                await aws.fetch(R2_ENDPOINT + '/' + BUCKET_NAME + '/content/' + fileName + '.png', {
                    method: 'DELETE'
                });

                jsonData.themes.splice(currentThemeToDelete, 1);
                jsonData.last_updated = new Date().toISOString();
                
                console.log('Total themes after delete:', jsonData.themes.length);
                console.log('Remaining themes:', jsonData.themes.map(function(t) { return t.name; }));

                await aws.fetch(R2_ENDPOINT + '/' + BUCKET_NAME + '/json/wallthemes.json', {
                    method: 'PUT',
                    body: JSON.stringify(jsonData, null, 2),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                // Wait for Cloudflare to propagate
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });

                closeDeleteModal();
                loadThemes();

            } catch (error) {
                alert('Failed to delete theme: ' + error.message);
                console.error('Delete error:', error);
            }
        }

        async function loadFontInfo() {
            try {
                const response = await fetch('https://wallboard-themes.ske-d03.workers.dev/starter-assets/fonts/fonts.zip', {
                    method: 'HEAD'
                });
                
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    const lastModified = response.headers.get('last-modified');
                    
                    let sizeText = 'Unknown size';
                    if (size) {
                        const sizeMB = (parseInt(size) / (1024 * 1024)).toFixed(2);
                        sizeText = sizeMB + ' MB';
                    }
                    
                    let dateText = '';
                    if (lastModified) {
                        const date = new Date(lastModified);
                        dateText = ' ‚Ä¢ Updated ' + date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    }
                    
                    document.getElementById('fontFileSize').textContent = sizeText + dateText;
                } else {
                    document.getElementById('fontFileSize').textContent = 'File not found';
                }
            } catch (error) {
                console.error('Error loading font info:', error);
                document.getElementById('fontFileSize').textContent = 'Error loading info';
            }
        }

        async function loadWeatherInfo() {
            try {
                const response = await fetch('https://wallboard-themes.ske-d03.workers.dev/starter-assets/weather-icons/weathericons.zip', {
                    method: 'HEAD'
                });
                
                if (response.ok) {
                    const size = response.headers.get('content-length');
                    const lastModified = response.headers.get('last-modified');
                    
                    let sizeText = 'Unknown size';
                    if (size) {
                        const sizeMB = (parseInt(size) / (1024 * 1024)).toFixed(2);
                        sizeText = sizeMB + ' MB';
                    }
                    
                    let dateText = '';
                    if (lastModified) {
                        const date = new Date(lastModified);
                        dateText = ' ‚Ä¢ Updated ' + date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric' 
                        });
                    }
                    
                    document.getElementById('weatherFileSize').textContent = sizeText + dateText;
                } else {
                    document.getElementById('weatherFileSize').textContent = 'File not found';
                }
            } catch (error) {
                console.error('Error loading weather info:', error);
                document.getElementById('weatherFileSize').textContent = 'Error loading info';
            }
        }

        function fontLog(message, type) {
            type = type || 'info';
            const output = document.getElementById('fontOutput');
            output.classList.add('show');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateFontProgress(percent) {
            const progress = document.getElementById('fontProgress');
            const bar = document.getElementById('fontProgressBar');
            progress.classList.add('show');
            bar.style.width = percent + '%';
        }

        function weatherLog(message, type) {
            type = type || 'info';
            const output = document.getElementById('weatherOutput');
            output.classList.add('show');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            output.innerHTML += '<span class="' + className + '">' + message + '</span>\n';
            output.scrollTop = output.scrollHeight;
        }

        function updateWeatherProgress(percent) {
            const progress = document.getElementById('weatherProgress');
            const bar = document.getElementById('weatherProgressBar');
            progress.classList.add('show');
            bar.style.width = percent + '%';
        }

        async function uploadFonts() {
            document.getElementById('fontOutput').innerHTML = '';
            document.getElementById('fontOutput').classList.remove('show');
            document.getElementById('fontProgress').classList.remove('show');
            document.getElementById('fontSuccessLinks').style.display = 'none';
            
            const uploadBtn = document.getElementById('uploadFontBtn');
            uploadBtn.disabled = true;

            try {
                fontLog('‚è≥ Initializing...', 'info');
                const AwsClientClass = await waitForAwsClient();

                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                const fontFile = document.getElementById('fontFile').files[0];

                if (!fontFile) {
                    alert('Please select a fonts.zip file!');
                    uploadBtn.disabled = false;
                    return;
                }

                if (!fontFile.name.toLowerCase().endsWith('.zip')) {
                    alert('Please select a .zip file!');
                    uploadBtn.disabled = false;
                    return;
                }

                fontLog('üöÄ Starting upload to Cloudflare R2...', 'info');
                updateFontProgress(10);

                const sizeMB = (fontFile.size / (1024 * 1024)).toFixed(2);
                fontLog('üì¶ File size: ' + sizeMB + ' MB', 'info');
                updateFontProgress(30);

                fontLog('üì§ Uploading fonts.zip...', 'info');
                const fontUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/starter-assets/fonts/fonts.zip';
                const fontResponse = await aws.fetch(fontUrl, {
                    method: 'PUT',
                    body: fontFile,
                    headers: { 
                        'Content-Type': 'application/zip',
                        'Cache-Control': 'public, max-age=3600'
                    }
                });
                
                if (!fontResponse.ok) throw new Error('Failed to upload fonts: ' + fontResponse.statusText);
                fontLog('‚úÖ Font package uploaded!', 'success');
                updateFontProgress(90);

                // Wait for Cloudflare to propagate
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });
                
                updateFontProgress(100);

                fontLog('', 'info');
                fontLog('‚ú® All done! Font package is now live!', 'success');

                const linksDiv = document.getElementById('fontLinksList');
                linksDiv.innerHTML = '<a href="https://wallboard-themes.ske-d03.workers.dev/starter-assets/fonts/fonts.zip" target="_blank">üîó Download Updated Fonts</a>';
                document.getElementById('fontSuccessLinks').style.display = 'block';

                // Reset form
                document.getElementById('fontFile').value = '';
                document.getElementById('fontFileLabel').textContent = 'üì¶ Choose fonts.zip file';
                document.getElementById('fontFileLabel').classList.remove('has-file');

                // Reload font info
                setTimeout(loadFontInfo, 2000);

            } catch (error) {
                fontLog('‚ùå Error: ' + error.message, 'error');
                console.error('Full error:', error);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        async function uploadWeatherIcons() {
            document.getElementById('weatherOutput').innerHTML = '';
            document.getElementById('weatherOutput').classList.remove('show');
            document.getElementById('weatherProgress').classList.remove('show');
            document.getElementById('weatherSuccessLinks').style.display = 'none';
            
            const uploadBtn = document.getElementById('uploadWeatherBtn');
            uploadBtn.disabled = true;

            try {
                weatherLog('‚è≥ Initializing...', 'info');
                const AwsClientClass = await waitForAwsClient();

                const aws = new AwsClientClass({
                    accessKeyId: ACCESS_KEY,
                    secretAccessKey: SECRET_KEY,
                    service: 's3',
                    region: 'auto'
                });

                const weatherFile = document.getElementById('weatherFile').files[0];

                if (!weatherFile) {
                    alert('Please select a weathericons.zip file!');
                    uploadBtn.disabled = false;
                    return;
                }

                if (!weatherFile.name.toLowerCase().endsWith('.zip')) {
                    alert('Please select a .zip file!');
                    uploadBtn.disabled = false;
                    return;
                }

                weatherLog('üöÄ Starting upload to Cloudflare R2...', 'info');
                updateWeatherProgress(10);

                const sizeMB = (weatherFile.size / (1024 * 1024)).toFixed(2);
                weatherLog('üì¶ File size: ' + sizeMB + ' MB', 'info');
                updateWeatherProgress(30);

                weatherLog('üì§ Uploading weathericons.zip...', 'info');
                const weatherUrl = R2_ENDPOINT + '/' + BUCKET_NAME + '/starter-assets/weather-icons/weathericons.zip';
                const weatherResponse = await aws.fetch(weatherUrl, {
                    method: 'PUT',
                    body: weatherFile,
                    headers: { 
                        'Content-Type': 'application/zip',
                        'Cache-Control': 'public, max-age=3600'
                    }
                });
                
                if (!weatherResponse.ok) throw new Error('Failed to upload weather icons: ' + weatherResponse.statusText);
                weatherLog('‚úÖ Weather icons package uploaded!', 'success');
                updateWeatherProgress(90);

                // Wait for Cloudflare to propagate
                await new Promise(function(resolve) { setTimeout(resolve, 1000); });
                
                updateWeatherProgress(100);

                weatherLog('', 'info');
                weatherLog('‚ú® All done! Weather icons package is now live!', 'success');

                const linksDiv = document.getElementById('weatherLinksList');
                linksDiv.innerHTML = '<a href="https://wallboard-themes.ske-d03.workers.dev/starter-assets/weather-icons/weathericons.zip" target="_blank">üîó Download Updated Weather Icons</a>';
                document.getElementById('weatherSuccessLinks').style.display = 'block';

                // Reset form
                document.getElementById('weatherFile').value = '';
                document.getElementById('weatherFileLabel').textContent = 'üå§Ô∏è Choose weathericons.zip file';
                document.getElementById('weatherFileLabel').classList.remove('has-file');

                // Reload weather info
                setTimeout(loadWeatherInfo, 2000);

            } catch (error) {
                weatherLog('‚ùå Error: ' + error.message, 'error');
                console.error('Full error:', error);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('themeName').addEventListener('input', function() {
                const themeName = this.value.trim();
                if (themeName) {
                    const fileName = themeName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    document.getElementById('filenameDisplay').textContent = fileName;
                    document.getElementById('filenamePreview').style.display = 'block';
                } else {
                    document.getElementById('filenamePreview').style.display = 'none';
                }
            });

            document.getElementById('themeFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('themeFileLabel').textContent = '‚úÖ ' + file.name;
                    document.getElementById('themeFileLabel').classList.add('has-file');
                }
            });
            
            // Add explicit click handler for mobile
            document.getElementById('themeFileLabel').addEventListener('click', function(e) {
                console.log('Theme file label clicked');
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('themeFile').click();
            });

            document.getElementById('imageFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('imageFileLabel').textContent = '‚úÖ ' + file.name;
                    document.getElementById('imageFileLabel').classList.add('has-file');
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.getElementById('previewImg');
                        img.src = event.target.result;
                        document.getElementById('imagePreview').classList.add('show');
                        
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            const maxDim = 1920;
                            let displayText = 'Original: ' + tempImg.width + '√ó' + tempImg.height + 'px';
                            
                            if (tempImg.width > maxDim || tempImg.height > maxDim) {
                                let newW, newH;
                                if (tempImg.width > tempImg.height) {
                                    newW = maxDim;
                                    newH = Math.round((tempImg.height / tempImg.width) * maxDim);
                                } else {
                                    newH = maxDim;
                                    newW = Math.round((tempImg.width / tempImg.height) * maxDim);
                                }
                                displayText += ' ‚Ä¢ Will be resized to ' + newW + '√ó' + newH + 'px (aspect ratio preserved)';
                            } else {
                                displayText += ' ‚Ä¢ No resize needed';
                            }
                            
                            document.getElementById('previewInfo').textContent = displayText;
                        };
                        tempImg.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Add explicit click handler for mobile
            document.getElementById('imageFileLabel').addEventListener('click', function(e) {
                console.log('Image file label clicked');
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('imageFile').click();
            });

            // Font file input handler
            document.getElementById('fontFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    document.getElementById('fontFileLabel').textContent = '‚úÖ ' + file.name + ' (' + sizeMB + ' MB)';
                    document.getElementById('fontFileLabel').classList.add('has-file');
                }
            });
            
            document.getElementById('fontFileLabel').addEventListener('click', function(e) {
                console.log('Font file label clicked');
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('fontFile').click();
            });

            // Weather file input handler
            document.getElementById('weatherFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    document.getElementById('weatherFileLabel').textContent = '‚úÖ ' + file.name + ' (' + sizeMB + ' MB)';
                    document.getElementById('weatherFileLabel').classList.add('has-file');
                }
            });
            
            document.getElementById('weatherFileLabel').addEventListener('click', function(e) {
                console.log('Weather file label clicked');
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('weatherFile').click();
            });

            // Update theme file input handler
            document.getElementById('updateThemeFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('updateThemeFileLabel').textContent = '‚úÖ ' + file.name;
                    document.getElementById('updateThemeFileLabel').classList.add('has-file');
                }
            });
            
            document.getElementById('updateThemeFileLabel').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('updateThemeFileInput').click();
            });

            // Update image file input handler
            document.getElementById('updateImageFileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('updateImageFileLabel').textContent = '‚úÖ ' + file.name;
                    document.getElementById('updateImageFileLabel').classList.add('has-file');
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = document.getElementById('updatePreviewImg');
                        img.src = event.target.result;
                        document.getElementById('updateImagePreview').style.display = 'block';
                        
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            const maxDim = 1920;
                            let displayText = 'Original: ' + tempImg.width + '√ó' + tempImg.height + 'px';
                            
                            if (tempImg.width > maxDim || tempImg.height > maxDim) {
                                let newW, newH;
                                if (tempImg.width > tempImg.height) {
                                    newW = maxDim;
                                    newH = Math.round((tempImg.height / tempImg.width) * maxDim);
                                } else {
                                    newH = maxDim;
                                    newW = Math.round((tempImg.width / tempImg.height) * maxDim);
                                }
                                displayText += ' ‚Ä¢ Will be resized to ' + newW + '√ó' + newH + 'px (aspect ratio preserved)';
                            } else {
                                displayText += ' ‚Ä¢ No resize needed';
                            }
                            
                            document.getElementById('updatePreviewInfo').textContent = displayText;
                        };
                        tempImg.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            document.getElementById('updateImageFileLabel').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                document.getElementById('updateImageFileInput').click();
            });

            loadThemes();
            loadFontInfo();
            loadWeatherInfo();
        });

        window.uploadToCloudflare = uploadToCloudflare;
    </script>
</body>
</html>
